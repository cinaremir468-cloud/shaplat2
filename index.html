<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFocus AI - Ultra Comprehensive System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --primary-glow: rgba(99, 102, 241, 0.15);
            --secondary: #8b5cf6; --accent: #ec4899; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --info: #3b82f6; --dark: #0f172a; --card: #1e293b;
            --card-hover: #334155; --border: #475569; --text: #f8fafc; --text-muted: #94a3b8;
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text); min-height: 100vh; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; overflow: hidden; }
        .login-container::before { content: ''; position: absolute; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 50px 50px; animation: moveBackground 20s linear infinite; }
        @keyframes moveBackground { 0% { transform: translate(0, 0); } 100% { transform: translate(50px, 50px); } }
        .login-box { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 24px; padding: 48px; max-width: 440px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); position: relative; z-index: 1; animation: fadeInUp 0.6s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .login-logo { text-align: center; margin-bottom: 32px; }
        .login-logo i { font-size: 64px; color: white; margin-bottom: 16px; display: block; }
        .login-logo h1 { font-size: 32px; font-weight: 800; color: white; margin-bottom: 8px; }
        .login-logo p { color: rgba(255, 255, 255, 0.8); font-size: 14px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: white; font-size: 14px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 14px 16px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 15px; transition: all 0.3s; font-family: 'Inter', sans-serif; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: white; background: rgba(255, 255, 255, 0.15); }
        .input-group input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .input-group select { cursor: pointer; }
        .input-group select option { background: #1e293b; color: white; }
        .input-group textarea { resize: vertical; min-height: 100px; }
        .btn { padding: 14px 24px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: white; color: #764ba2; width: 100%; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-google { background: white; color: #333; width: 100%; margin-top: 12px; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--card-hover); color: white; }
        .btn-info { background: var(--info); color: white; }
        .divider { text-align: center; margin: 24px 0; position: relative; }
        .divider::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 1px; background: rgba(255, 255, 255, 0.2); }
        .divider span { background: transparent; padding: 0 12px; position: relative; color: rgba(255, 255, 255, 0.8); font-size: 14px; }
        .app-container { display: none; }
        .app-header { background: var(--card); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .app-logo { display: flex; align-items: center; gap: 12px; }
        .app-logo i { font-size: 28px; color: var(--primary); }
        .app-logo h2 { font-size: 20px; font-weight: 700; }
        .user-menu { display: flex; align-items: center; gap: 16px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; font-weight: 600; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .btn-logout { background: var(--danger); color: white; padding: 8px 16px; font-size: 14px; }
        .tabs { background: var(--card); border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; gap: 8px; overflow-x: auto; }
        .tab-btn { padding: 16px 24px; background: transparent; border: none; color: var(--text-muted); font-size: 15px; font-weight: 600; cursor: pointer; position: relative; transition: all 0.3s; display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 3px 3px 0 0; }
        .content { padding: 24px; max-width: 1800px; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; transition: all 0.3s; cursor: pointer; position: relative; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); border-color: var(--primary); }
        .card-add { border: 2px dashed var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; gap: 12px; }
        .card-add:hover { border-color: var(--primary); background: var(--primary-glow); }
        .card-add i { font-size: 48px; color: var(--primary); }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; text-align: center; }
        .card-subtitle { color: var(--text-muted); font-size: 14px; text-align: center; margin-bottom: 8px; }
        .card-meta { display: flex; justify-content: space-between; padding-top: 16px; border-top: 1px solid var(--border); font-size: 13px; margin-top: 16px; }
        .card-meta-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; display: flex; align-items: center; gap: 16px; }
        .stat-icon { width: 56px; height: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
        .stat-icon.primary { background: var(--primary-glow); color: var(--primary); }
        .stat-icon.success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .stat-icon.warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .stat-icon.info { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .stat-info h3 { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .stat-info p { color: var(--text-muted); font-size: 14px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; animation: scaleIn 0.3s ease; margin: auto; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--card); z-index: 10; }
        .modal-title { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .btn-close { background: transparent; border: none; font-size: 24px; color: var(--text-muted); cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.3s; }
        .btn-close:hover { background: var(--card-hover); color: var(--text); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .camera-preview { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .camera-preview video, .camera-preview canvas, .camera-preview img { width: 100%; height: 100%; object-fit: contain; }
        .face-photos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; }
        .face-photo-slot { aspect-ratio: 1; border: 2px dashed var(--border); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: all 0.3s; position: relative; }
        .face-photo-slot:hover { border-color: var(--primary); background: var(--primary-glow); }
        .face-photo-slot.captured { border-color: var(--success); padding: 0; }
        .face-photo-slot img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
        .face-photo-number { position: absolute; top: 8px; right: 8px; background: var(--success); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; z-index: 1; }
        .student-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 16px; }
        .student-item { background: var(--dark); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .student-item:hover { background: var(--card-hover); }
        .student-item.selected { border-color: var(--primary); background: var(--primary-glow); }
        .student-item-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; overflow: hidden; }
        .student-item-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .student-item-info { flex: 1; min-width: 0; }
        .student-item-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .student-item-class { font-size: 12px; color: var(--text-muted); }
        .live-container { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        .live-feed { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
        .live-feed-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .live-indicator { width: 12px; height: 12px; background: var(--danger); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .live-sidebar { display: flex; flex-direction: column; gap: 20px; }
        .metrics-panel { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
        .metrics-panel h3 { font-size: 16px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .metric-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .metric-item:last-child { border-bottom: none; }
        .metric-label { color: var(--text-muted); font-size: 14px; }
        .metric-value { font-weight: 600; font-size: 16px; }
        .progress-bar { width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 4px; transition: width 0.5s ease; }
        .audio-visualizer { height: 80px; background: var(--dark); border-radius: 8px; margin-top: 12px; position: relative; overflow: hidden; }
        .audio-visualizer canvas { width: 100%; height: 100%; }
        .analysis-log { max-height: 500px; overflow-y: auto; }
        .log-item { padding: 16px; border-bottom: 1px solid var(--border); }
        .log-item:last-child { border-bottom: none; }
        .log-time { color: var(--text-muted); font-size: 12px; margin-bottom: 8px; }
        .log-content h4 { font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .log-content p { color: var(--text-muted); font-size: 13px; line-height: 1.6; margin-bottom: 8px; }
        .log-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 12px; }
        .log-metric { background: var(--dark); padding: 8px 12px; border-radius: 8px; font-size: 11px; }
        .log-metric-label { color: var(--text-muted); display: block; margin-bottom: 4px; }
        .log-metric-value { color: var(--primary); font-weight: 600; font-size: 13px; }
        .badge { padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .badge-primary { background: var(--primary-glow); color: var(--primary); }
        .alert { padding: 16px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 12px; }
        .alert-info { background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); color: var(--info); }
        .alert-success { background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); color: var(--success); }
        .alert-warning { background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); color: var(--warning); }
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .control-buttons { display: flex; gap: 12px; justify-content: center; padding: 20px; flex-wrap: wrap; }
        .control-buttons .btn { min-width: 120px; }
        .timer-display { font-family: 'Courier New', monospace; font-size: 24px; font-weight: bold; color: var(--primary); }
        @media (max-width: 1024px) { .live-container { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .cards-grid, .stats-grid { grid-template-columns: 1fr; } .control-buttons { flex-direction: column; } .control-buttons .btn { width: 100%; } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>StudyFocus AI</h1>
                <p>Ultra Comprehensive Analysis System</p>
            </div>
            <form onsubmit="return false;">
                <div class="input-group">
                    <label>E-posta</label>
                    <input type="email" id="email" placeholder="ornek@email.com">
                </div>
                <div class="input-group">
                    <label>Şifre</label>
                    <input type="password" id="password" placeholder="••••••••">
                </div>
                <button type="button" class="btn btn-primary" onclick="emailLogin()" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Giriş Yap
                </button>
                <div class="divider"><span>veya</span></div>
                <button type="button" class="btn btn-google" onclick="googleLogin()" id="googleBtn">
                    <i class="fab fa-google"></i> Google ile Giriş
                </button>
            </form>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="app-header">
            <div class="app-logo">
                <i class="fas fa-graduation-cap"></i>
                <h2>StudyFocus AI</h2>
            </div>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">Kullanıcı</span>
                <button class="btn btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Çıkış</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('classes', event)"><i class="fas fa-school"></i> Sınıflar</button>
            <button class="tab-btn" onclick="showTab('students', event)"><i class="fas fa-users"></i> Öğrenciler</button>
            <button class="tab-btn" onclick="showTab('cameras', event)"><i class="fas fa-camera"></i> Kameralar</button>
            <button class="tab-btn" onclick="showTab('sessions', event)"><i class="fas fa-video"></i> Oturumlar</button>
            <button class="tab-btn" onclick="showTab('live', event)"><i class="fas fa-broadcast-tower"></i> Canlı İzleme</button>
            <button class="tab-btn" onclick="showTab('reports', event)"><i class="fas fa-chart-line"></i> Raporlar</button>
        </div>

        <div class="content">
            <div class="tab-content active" id="classesTab">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-school"></i></div><div class="stat-info"><h3 id="totalClasses">0</h3><p>Toplam Sınıf</p></div></div>
                    <div class="stat-card"><div class="stat-icon success"><i class="fas fa-users"></i></div><div class="stat-info"><h3 id="totalClassStudents">0</h3><p>Sınıf Öğrencileri</p></div></div>
                    <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-play-circle"></i></div><div class="stat-info"><h3 id="activeClassSessions">0</h3><p>Aktif Sınıf Oturumu</p></div></div>
                </div>
                <div class="cards-grid" id="classesGrid">
                    <div class="card card-add" onclick="showAddClassModal()"><i class="fas fa-plus"></i><h3>Yeni Sınıf Oluştur</h3><p>Çoklu öğrenci + Ortam analizi</p></div>
                </div>
            </div>

            <div class="tab-content" id="studentsTab">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-users"></i></div><div class="stat-info"><h3 id="totalStudents">0</h3><p>Toplam Öğrenci</p></div></div>
                    <div class="stat-card"><div class="stat-icon success"><i class="fas fa-check-circle"></i></div><div class="stat-info"><h3 id="trainedStudents">0</h3><p>Eğitilmiş Yüz</p></div></div>
                </div>
                <div class="cards-grid" id="studentsGrid">
                    <div class="card card-add" onclick="showAddStudentModal()"><i class="fas fa-plus"></i><h3>Yeni Öğrenci Ekle</h3><p>Yüz tanıma ile kayıt</p></div>
                </div>
            </div>

            <div class="tab-content" id="camerasTab">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon info"><i class="fas fa-camera"></i></div><div class="stat-info"><h3 id="totalCameras">0</h3><p>Toplam Kamera</p></div></div>
                </div>
                <div class="cards-grid" id="camerasGrid">
                    <div class="card card-add" onclick="showAddCameraModal()"><i class="fas fa-plus"></i><h3>Yeni Kamera Ekle</h3><p>Webcam veya IP Kamera</p></div>
                </div>
            </div>

            <div class="tab-content" id="sessionsTab">
                <div class="cards-grid" id="sessionsGrid">
                    <div class="card card-add" onclick="showStartSessionModal()"><i class="fas fa-play-circle"></i><h3>Yeni Oturum Başlat</h3><p>Bireysel veya Sınıf</p></div>
                </div>
            </div>

            <div class="tab-content" id="liveTab">
                <div id="noActiveSession"><div class="alert alert-info"><i class="fas fa-info-circle" style="font-size:20px;"></i><div><strong>Canlı İzleme</strong><br>Oturum başlatınca burada görünecek</div></div></div>
                <div class="live-container" id="liveContainer" style="display:none;">
                    <div class="live-feed">
                        <div class="live-feed-header">
                            <div style="display:flex;align-items:center;gap:12px;"><div class="live-indicator"></div><h3 id="liveSessionTitle">Canlı İzleme</h3></div>
                            <div class="timer-display" id="sessionTimer">00:00:00</div>
                        </div>
                        <div class="camera-preview">
                            <video id="liveVideo" autoplay playsinline muted></video>
                            <img id="liveImage" style="display:none;">
                            <canvas id="liveCanvas" style="display:none;"></canvas>
                        </div>
                        <div class="control-buttons">
                            <button class="btn btn-warning" onclick="pauseSession()" id="pauseBtn"><i class="fas fa-pause"></i> Duraklat</button>
                            <button class="btn btn-success" onclick="resumeSession()" id="resumeBtn" style="display:none;"><i class="fas fa-play"></i> Devam</button>
                            <button class="btn btn-danger" onclick="endSession()"><i class="fas fa-stop"></i> Bitir</button>
                        </div>
                    </div>
                    <div class="live-sidebar">
                        <div class="metrics-panel">
                            <h3><i class="fas fa-tachometer-alt"></i> Anlık Metrikler</h3>
                            <div class="metric-item"><span class="metric-label">Genel Skor</span><span class="metric-value" id="liveScore">-</span></div>
                            <div class="progress-bar"><div class="progress-fill" id="liveScoreBar" style="width:0%"></div></div>
                            <div class="metric-item"><span class="metric-label">Odaklanma</span><span class="metric-value" id="liveFocus">-</span></div>
                            <div class="metric-item"><span class="metric-label">Dikkat</span><span class="metric-value" id="liveAttention">-</span></div>
                            <div class="metric-item"><span class="metric-label">Duygusal</span><span class="metric-value" id="liveEmotion">-</span></div>
                        </div>
                        <div class="metrics-panel">
                            <h3><i class="fas fa-volume-up"></i> Ses Analizi</h3>
                            <div class="metric-item"><span class="metric-label">Ses Seviyesi</span><span class="metric-value" id="liveAudioLevel">-</span></div>
                            <div class="metric-item"><span class="metric-label">Gürültü</span><span class="metric-value" id="liveNoise">-</span></div>
                            <div class="audio-visualizer"><canvas id="audioCanvas"></canvas></div>
                        </div>
                        <div class="metrics-panel">
                            <h3><i class="fas fa-list"></i> Son Analizler</h3>
                            <div class="analysis-log" id="analysisLog"><div class="log-item"><p style="text-align:center;color:var(--text-muted);">Analiz sonuçları...</p></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="reportsTab"><div class="cards-grid" id="reportsGrid"><div class="loading"><div class="spinner"></div><p>Yükleniyor...</p></div></div></div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="addClassModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title"><i class="fas fa-school"></i> Yeni Sınıf Oluştur</h3><button class="btn-close" onclick="closeModal('addClassModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div class="input-group"><label>Sınıf Adı *</label><input type="text" id="className" placeholder="10/A - Fen Sınıfı"></div><div class="form-row"><div class="input-group"><label>Seviye</label><input type="text" id="classGrade" placeholder="10"></div><div class="input-group"><label>Şube</label><input type="text" id="classSection" placeholder="A"></div></div><div class="input-group"><label>Kamera Seç *</label><select id="classCamera"><option value="">Kamera seçin...</option></select></div><div class="input-group"><label>Öğrenciler</label><div class="student-list" id="classStudentsList"></div></div><div class="input-group"><label>Açıklama</label><textarea id="classDescription" placeholder="Sınıf hakkında notlar..."></textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addClassModal')">İptal</button><button class="btn btn-primary" onclick="saveClass()" id="saveClassBtn"><i class="fas fa-save"></i> Sınıfı Kaydet</button></div></div></div>

    <div class="modal" id="addStudentModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title"><i class="fas fa-user-plus"></i> Yeni Öğrenci</h3><button class="btn-close" onclick="closeModal('addStudentModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div class="form-row"><div class="input-group"><label>Ad Soyad *</label><input type="text" id="studentName" placeholder="Ahmet Yılmaz"></div><div class="input-group"><label>Öğrenci No *</label><input type="text" id="studentNo" placeholder="12345"></div></div><div class="input-group"><label>Sınıf</label><input type="text" id="studentClass" placeholder="10/A"></div><div class="alert alert-info"><i class="fas fa-info-circle"></i><div><strong>Yüz Eğitimi</strong><br>3 farklı açıdan fotoğraf çekin</div></div><div class="camera-preview"><video id="studentVideo" autoplay playsinline></video><canvas id="studentCanvas" style="display:none;"></canvas></div><div class="face-photos-grid" id="facePhotosGrid"><div class="face-photo-slot" onclick="captureFacePhoto(0)"><i class="fas fa-camera"></i><span>Fotoğraf 1</span></div><div class="face-photo-slot" onclick="captureFacePhoto(1)"><i class="fas fa-camera"></i><span>Fotoğraf 2</span></div><div class="face-photo-slot" onclick="captureFacePhoto(2)"><i class="fas fa-camera"></i><span>Fotoğraf 3</span></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addStudentModal')">İptal</button><button class="btn btn-primary" onclick="saveStudent()" id="saveStudentBtn"><i class="fas fa-save"></i> Kaydet</button></div></div></div>

    <div class="modal" id="addCameraModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title"><i class="fas fa-camera"></i> Yeni Kamera</h3><button class="btn-close" onclick="closeModal('addCameraModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div class="input-group"><label>Kamera Adı *</label><input type="text" id="cameraName" placeholder="Sınıf Kamerası"></div><div class="input-group"><label>Tip *</label><select id="cameraType" onchange="toggleCameraType()"><option value="webcam">Webcam</option><option value="ip">IP Kamera</option><option value="android">Android IP Webcam</option></select></div><div class="input-group" id="ipCameraUrl" style="display:none;"><label>URL *</label><input type="text" id="cameraUrl" placeholder="http://192.168.1.100:8080"></div><div class="input-group"><label>Konum</label><input type="text" id="cameraLocation" placeholder="Sınıfın ön tarafı"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addCameraModal')">İptal</button><button class="btn btn-warning" onclick="testCamera()" id="testCameraBtn"><i class="fas fa-vial"></i> Test</button><button class="btn btn-primary" onclick="saveCamera()" id="saveCameraBtn"><i class="fas fa-save"></i> Kaydet</button></div></div></div>

    <div class="modal" id="startSessionModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title"><i class="fas fa-play-circle"></i> Yeni Oturum</h3><button class="btn-close" onclick="closeModal('startSessionModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div class="input-group"><label>Tip *</label><select id="sessionType" onchange="toggleSessionType()"><option value="individual">Bireysel (Tek Öğrenci)</option><option value="class">Sınıf (Çoklu Öğrenci + Ortam)</option></select></div><div id="individualSession"><div class="input-group"><label>Öğrenci *</label><select id="sessionStudent"><option value="">Seçin...</option></select></div></div><div id="classSession" style="display:none;"><div class="input-group"><label>Sınıf *</label><select id="sessionClass"><option value="">Seçin...</option></select></div></div><div class="input-group"><label>Kamera *</label><select id="sessionCamera"><option value="">Seçin...</option></select></div><div class="form-row"><div class="input-group"><label>Analiz Aralığı (sn)</label><input type="number" id="analysisInterval" value="15" min="10" max="60"></div><div class="input-group"><label>GPT Model</label><select id="gptModel"><option value="gpt-4o">GPT-4o (Yüksek)</option><option value="gpt-4o-mini" selected>GPT-4o-mini (Hızlı)</option></select></div></div><div class="input-group"><label>Süre (dk)</label><input type="number" id="sessionDuration" placeholder="Boş=Manuel bitiş" min="1"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('startSessionModal')">İptal</button><button class="btn btn-success" onclick="startSession()" id="startSessionBtn"><i class="fas fa-play"></i> Başlat</button></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
const firebaseConfig={apiKey:"AIzaSyCbolraCD1nrOqcIE5GHPAaX9SRhHQXYIY",authDomain:"videoanlyze.firebaseapp.com",projectId:"videoanlyze",storageBucket:"videoanlyze.firebasestorage.app",messagingSenderId:"1053069335615",appId:"1:1053069335615:web:5dbf8f2345a5bf18b1ac8a"};
firebase.initializeApp(firebaseConfig);const auth=firebase.auth(),db=firebase.firestore();
const OPENAI_API_KEY='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';
let currentUser,classes=[],students=[],cameras=[],sessions=[],currentSession,analysisInterval,timerInterval,videoStream,audioContext,audioAnalyser,audioDataArray,sessionStartTime,isPaused=false,facePhotos=[],faceDescriptors=[];

window.onload=async()=>{await loadFaceModels();checkAuth();};
async function loadFaceModels(){const MODEL_URL='https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/';try{await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)]);console.log('✅ Models loaded');}catch(e){console.error('❌ Model error:',e);}}

function checkAuth(){auth.onAuthStateChanged(user=>{if(user){currentUser=user;showApp();}});}
async function emailLogin(){const email=document.getElementById('email').value,password=document.getElementById('password').value,loginBtn=document.getElementById('loginBtn');if(!email||!password){alert('❌ Tüm alanları doldurun');return;}loginBtn.disabled=true;loginBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Giriş...';try{await auth.signInWithEmailAndPassword(email,password);}catch(e){if(e.code==='auth/user-not-found'||e.code==='auth/wrong-password'){try{await auth.createUserWithEmailAndPassword(email,password);}catch(ce){alert('❌ '+ce.message);}}else{alert('❌ '+e.message);}}finally{loginBtn.disabled=false;loginBtn.innerHTML='<i class="fas fa-sign-in-alt"></i> Giriş Yap';}}
async function googleLogin(){const googleBtn=document.getElementById('googleBtn');googleBtn.disabled=true;googleBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Bağlanıyor...';try{await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());}catch(e){alert('❌ '+e.message);}finally{googleBtn.disabled=false;googleBtn.innerHTML='<i class="fab fa-google"></i> Google ile Giriş';}}
async function logout(){await auth.signOut();}

async function showApp(){document.getElementById('loginScreen').style.display='none';document.getElementById('appContainer').style.display='block';const userName=currentUser.displayName||currentUser.email.split('@')[0];document.getElementById('userName').textContent=userName;const avatarEl=document.getElementById('userAvatar');if(currentUser.photoURL){avatarEl.innerHTML=`<img src="${currentUser.photoURL}" alt="Avatar">`;}else{avatarEl.textContent=userName.charAt(0).toUpperCase();}await Promise.all([loadClasses(),loadStudents(),loadCameras(),loadSessions()]);updateStats();}

function showTab(tabName,clickEvent){document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));if(clickEvent&&clickEvent.target){clickEvent.target.closest('.tab-btn').classList.add('active');}else{const tabMap={'classes':0,'students':1,'cameras':2,'sessions':3,'live':4,'reports':5};const index=tabMap[tabName];if(index!==undefined){document.querySelectorAll('.tab-btn')[index].classList.add('active');}}document.querySelectorAll('.tab-content').forEach(content=>content.classList.remove('active'));document.getElementById(tabName+'Tab').classList.add('active');if(tabName==='reports'){loadReports();}}

async function loadClasses(){try{const snapshot=await db.collection('users').doc(currentUser.uid).collection('classes').get();classes=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));renderClasses();}catch(e){console.error('Classes load:',e);}}
function renderClasses(){const grid=document.getElementById('classesGrid'),addCard=grid.querySelector('.card-add');grid.innerHTML='';grid.appendChild(addCard);classes.forEach(c=>{const card=document.createElement('div');card.className='card';card.innerHTML=`<div class="card-title">${c.name}</div><p class="card-subtitle">${c.grade||''} ${c.section||''}</p><p class="card-subtitle">${c.studentIds?.length||0} öğrenci</p><div class="card-meta"><span class="card-meta-item"><i class="fas fa-camera"></i> ${c.cameraId?'Bağlı':'Yok'}</span><span class="card-meta-item"><i class="fas fa-chart-bar"></i> ${c.sessionsCount||0} oturum</span></div>`;grid.appendChild(card);});updateStats();}

async function loadStudents(){try{const snapshot=await db.collection('users').doc(currentUser.uid).collection('students').get();students=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));renderStudents();}catch(e){console.error('Students:',e);}}
function renderStudents(){const grid=document.getElementById('studentsGrid'),addCard=grid.querySelector('.card-add');grid.innerHTML='';grid.appendChild(addCard);students.forEach(s=>{const card=document.createElement('div');card.className='card';const initials=s.name.split(' ').map(n=>n[0]).join('').substring(0,2);const avatar=s.profilePhoto?`<img src="${s.profilePhoto}" alt="${s.name}" style="width:60px;height:60px;border-radius:50%;margin:0 auto 12px;display:block;object-fit:cover;">`:initials;card.innerHTML=`<div style="text-align:center;font-size:32px;font-weight:700;color:var(--primary);margin-bottom:12px;">${avatar}</div><div class="card-title">${s.name}</div><p class="card-subtitle">${s.class} - No: ${s.studentNo}</p><div class="card-meta"><span class="card-meta-item"><i class="fas fa-check-circle"></i> ${s.faceDescriptorsJSON?'Eğitildi':'Yüz yok'}</span></div>`;grid.appendChild(card);});updateStats();}

async function loadCameras(){try{const snapshot=await db.collection('users').doc(currentUser.uid).collection('cameras').get();cameras=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));renderCameras();}catch(e){console.error('Cameras:',e);}}
function renderCameras(){const grid=document.getElementById('camerasGrid'),addCard=grid.querySelector('.card-add');grid.innerHTML='';grid.appendChild(addCard);cameras.forEach(c=>{const card=document.createElement('div');card.className='card';const icons={webcam:'fa-video',ip:'fa-network-wired',android:'fa-mobile-alt'};card.innerHTML=`<div style="text-align:center;font-size:48px;color:var(--info);margin-bottom:12px;"><i class="fas ${icons[c.type]||'fa-camera'}"></i></div><div class="card-title">${c.name}</div><p class="card-subtitle">${c.type==='webcam'?'Webcam':'IP Kamera'}</p>${c.location?`<p class="card-subtitle">${c.location}</p>`:''}`;grid.appendChild(card);});updateStats();}

async function loadSessions(){try{const snapshot=await db.collection('users').doc(currentUser.uid).collection('sessions').orderBy('startTime','desc').limit(50).get();sessions=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));renderSessions();}catch(e){console.error('Sessions:',e);}}
function renderSessions(){const grid=document.getElementById('sessionsGrid'),addCard=grid.querySelector('.card-add');grid.innerHTML='';grid.appendChild(addCard);sessions.forEach(s=>{const card=document.createElement('div');card.className='card';const startTime=s.startTime?.toDate?s.startTime.toDate():new Date();let duration='Devam';if(s.endTime){const endTime=s.endTime.toDate();const mins=Math.round((endTime-startTime)/60000);duration=`${Math.floor(mins/60)}h ${mins%60}m`;}const statusBadge=s.status==='active'?'badge-success':s.status==='paused'?'badge-warning':'badge-info';const type=s.type==='class'?'Sınıf':'Bireysel';card.innerHTML=`<div class="card-title">${type} Oturum</div><p class="card-subtitle">${startTime.toLocaleString('tr-TR')}</p><div class="card-meta"><span class="card-meta-item"><i class="fas fa-clock"></i> ${duration}</span><span class="badge ${statusBadge}">${s.status==='active'?'Aktif':s.status==='paused'?'Duraklı':'Tamamlandı'}</span></div>`;grid.appendChild(card);});}

function loadReports(){document.getElementById('reportsGrid').innerHTML='<div class="alert alert-info"><i class="fas fa-info-circle"></i><div>Raporlar yakında...</div></div>';}

function updateStats(){document.getElementById('totalClasses').textContent=classes.length;document.getElementById('totalClassStudents').textContent=classes.reduce((sum,c)=>sum+(c.studentIds?.length||0),0);document.getElementById('activeClassSessions').textContent=sessions.filter(s=>s.status==='active'&&s.type==='class').length;document.getElementById('totalStudents').textContent=students.length;document.getElementById('trainedStudents').textContent=students.filter(s=>s.faceDescriptorsJSON).length;document.getElementById('totalCameras').textContent=cameras.length;}

function showAddClassModal(){const modal=document.getElementById('addClassModal');modal.classList.add('active');const cameraSelect=document.getElementById('classCamera');cameraSelect.innerHTML='<option value="">Kamera seçin...</option>';cameras.forEach(c=>{cameraSelect.innerHTML+=`<option value="${c.id}">${c.name}</option>`;});const studentsList=document.getElementById('classStudentsList');studentsList.innerHTML='';students.forEach(s=>{const item=document.createElement('div');item.className='student-item';item.onclick=()=>item.classList.toggle('selected');const initials=s.name.split(' ').map(n=>n[0]).join('').substring(0,2);const avatar=s.profilePhoto?`<img src="${s.profilePhoto}">`:`${initials}`;item.innerHTML=`<div class="student-item-avatar">${avatar}</div><div class="student-item-info"><div class="student-item-name">${s.name}</div><div class="student-item-class">${s.class}</div></div>`;item.dataset.studentId=s.id;studentsList.appendChild(item);});}

async function saveClass(){const name=document.getElementById('className').value,grade=document.getElementById('classGrade').value,section=document.getElementById('classSection').value,cameraId=document.getElementById('classCamera').value,description=document.getElementById('classDescription').value,saveBtn=document.getElementById('saveClassBtn');if(!name||!cameraId){alert('❌ İsim ve kamera gerekli');return;}const selectedStudents=Array.from(document.querySelectorAll('.student-item.selected')).map(item=>item.dataset.studentId);if(selectedStudents.length===0){alert('❌ En az 1 öğrenci seçin');return;}saveBtn.disabled=true;saveBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';try{await db.collection('users').doc(currentUser.uid).collection('classes').add({name,grade,section,cameraId,studentIds:selectedStudents,description,sessionsCount:0,createdAt:firebase.firestore.FieldValue.serverTimestamp()});closeModal('addClassModal');await loadClasses();alert('✅ Sınıf oluşturuldu!');}catch(e){alert('❌ '+e.message);}finally{saveBtn.disabled=false;saveBtn.innerHTML='<i class="fas fa-save"></i> Kaydet';}}

function showAddStudentModal(){const modal=document.getElementById('addStudentModal');modal.classList.add('active');facePhotos=[];faceDescriptors=[];document.getElementById('studentName').value='';document.getElementById('studentNo').value='';document.getElementById('studentClass').value='';document.querySelectorAll('.face-photo-slot').forEach((slot,i)=>{slot.classList.remove('captured');slot.innerHTML=`<i class="fas fa-camera"></i><span>Fotoğraf ${i+1}</span>`;});startStudentCamera();}

async function startStudentCamera(){try{const video=document.getElementById('studentVideo');const stream=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}});video.srcObject=stream;videoStream=stream;}catch(e){alert('❌ Kamera erişimi başarısız!');}}

async function captureFacePhoto(index){const video=document.getElementById('studentVideo'),canvas=document.getElementById('studentCanvas'),ctx=canvas.getContext('2d');canvas.width=video.videoWidth;canvas.height=video.videoHeight;ctx.drawImage(video,0,0);try{const detection=await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();if(!detection){alert('❌ Yüz bulunamadı!');return;}const photoUrl=canvas.toDataURL('image/jpeg',0.85);facePhotos[index]=photoUrl;faceDescriptors[index]=Array.from(detection.descriptor);const slot=document.querySelectorAll('.face-photo-slot')[index];slot.classList.add('captured');slot.innerHTML=`<img src="${photoUrl}"><div class="face-photo-number">${index+1}</div>`;}catch(e){alert('❌ Yüz yakalama hatası!');}}

async function saveStudent(){const name=document.getElementById('studentName').value,studentNo=document.getElementById('studentNo').value,studentClass=document.getElementById('studentClass').value,saveBtn=document.getElementById('saveStudentBtn');if(!name||!studentNo||!studentClass){alert('❌ Tüm alanları doldurun');return;}if(facePhotos.filter(p=>p).length<3){alert('❌ 3 fotoğraf gerekli');return;}saveBtn.disabled=true;saveBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';try{await db.collection('users').doc(currentUser.uid).collection('students').add({name,studentNo,class:studentClass,profilePhoto:facePhotos[0],facePhotos,faceDescriptorsJSON:JSON.stringify(faceDescriptors),faceTrained:true,createdAt:firebase.firestore.FieldValue.serverTimestamp(),totalHours:0,avgScore:0});if(videoStream){videoStream.getTracks().forEach(track=>track.stop());videoStream=null;}closeModal('addStudentModal');await loadStudents();alert('✅ Öğrenci kaydedildi!');}catch(e){alert('❌ '+e.message);}finally{saveBtn.disabled=false;saveBtn.innerHTML='<i class="fas fa-save"></i> Kaydet';}}

function showAddCameraModal(){document.getElementById('addCameraModal').classList.add('active');document.getElementById('cameraName').value='';document.getElementById('cameraType').value='webcam';document.getElementById('cameraUrl').value='';document.getElementById('cameraLocation').value='';toggleCameraType();}
function toggleCameraType(){const type=document.getElementById('cameraType').value;document.getElementById('ipCameraUrl').style.display=(type==='ip'||type==='android')?'block':'none';}
async function testCamera(){alert('Kamera test özelliği - Demodan kopyalanacak');}
async function saveCamera(){const name=document.getElementById('cameraName').value,type=document.getElementById('cameraType').value,url=document.getElementById('cameraUrl').value,location=document.getElementById('cameraLocation').value,saveBtn=document.getElementById('saveCameraBtn');if(!name){alert('❌ İsim gerekli');return;}if((type==='ip'||type==='android')&&!url){alert('❌ URL gerekli');return;}saveBtn.disabled=true;saveBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';try{await db.collection('users').doc(currentUser.uid).collection('cameras').add({name,type,url:type!=='webcam'?url:null,location,status:'online',createdAt:firebase.firestore.FieldValue.serverTimestamp()});closeModal('addCameraModal');await loadCameras();alert('✅ Kamera kaydedildi!');}catch(e){alert('❌ '+e.message);}finally{saveBtn.disabled=false;saveBtn.innerHTML='<i class="fas fa-save"></i> Kaydet';}}

function showStartSessionModal(){if(students.length===0){alert('❌ Önce öğrenci ekle!');return;}if(cameras.length===0){alert('❌ Önce kamera ekle!');return;}document.getElementById('startSessionModal').classList.add('active');const studentSelect=document.getElementById('sessionStudent');studentSelect.innerHTML='<option value="">Seçin...</option>';students.forEach(s=>{studentSelect.innerHTML+=`<option value="${s.id}">${s.name}</option>`;});const classSelect=document.getElementById('sessionClass');classSelect.innerHTML='<option value="">Seçin...</option>';classes.forEach(c=>{classSelect.innerHTML+=`<option value="${c.id}">${c.name}</option>`;});const cameraSelect=document.getElementById('sessionCamera');cameraSelect.innerHTML='<option value="">Seçin...</option>';cameras.forEach(c=>{cameraSelect.innerHTML+=`<option value="${c.id}">${c.name}</option>`;});}
function toggleSessionType(){const type=document.getElementById('sessionType').value;document.getElementById('individualSession').style.display=type==='individual'?'block':'none';document.getElementById('classSession').style.display=type==='class'?'block':'none';}

async function startSession(){const type=document.getElementById('sessionType').value,interval=parseInt(document.getElementById('analysisInterval').value),gptModel=document.getElementById('gptModel').value,duration=document.getElementById('sessionDuration').value,startBtn=document.getElementById('startSessionBtn');let studentId,classId;const cameraId=document.getElementById('sessionCamera').value;if(!cameraId){alert('❌ Kamera seçin');return;}if(type==='individual'){studentId=document.getElementById('sessionStudent').value;if(!studentId){alert('❌ Öğrenci seçin');return;}}else{classId=document.getElementById('sessionClass').value;if(!classId){alert('❌ Sınıf seçin');return;}}startBtn.disabled=true;startBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Başlatılıyor...';try{const sessionData={type,studentId:studentId||null,classId:classId||null,cameraId,startTime:firebase.firestore.FieldValue.serverTimestamp(),endTime:null,status:'active',analysisInterval:interval,gptModel,sessionDuration:duration?parseInt(duration):null,analysisCount:0};const docRef=await db.collection('users').doc(currentUser.uid).collection('sessions').add(sessionData);currentSession={id:docRef.id,...sessionData,studentId,classId,cameraId};closeModal('startSessionModal');showTab('live');await startLiveMonitoring();await loadSessions();}catch(e){alert('❌ '+e.message);}finally{startBtn.disabled=false;startBtn.innerHTML='<i class="fas fa-play"></i> Başlat';}}

async function startLiveMonitoring(){document.getElementById('noActiveSession').style.display='none';document.getElementById('liveContainer').style.display='grid';const camera=cameras.find(c=>c.id===currentSession.cameraId);if(!camera){alert('❌ Kamera bulunamadı!');return;}if(currentSession.type==='class'){const classData=classes.find(c=>c.id===currentSession.classId);document.getElementById('liveSessionTitle').textContent=`Sınıf: ${classData.name}`;}else{const student=students.find(s=>s.id===currentSession.studentId);document.getElementById('liveSessionTitle').textContent=`Öğrenci: ${student.name}`;}sessionStartTime=Date.now();isPaused=false;startTimer();try{if(camera.type==='webcam'){const video=document.getElementById('liveVideo');video.style.display='block';document.getElementById('liveImage').style.display='none';const stream=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720},audio:true});video.srcObject=stream;videoStream=stream;await initAudioAnalysis(stream);}else{const img=document.getElementById('liveImage');img.style.display='block';document.getElementById('liveVideo').style.display='none';const updateIPCamera=()=>{if(!isPaused&&currentSession){const url=camera.url+(camera.type==='android'?'/shot.jpg':'');const newImg=new Image();newImg.onload=()=>{img.src=newImg.src;};newImg.src=`${url}?t=${Date.now()}`;}};updateIPCamera();setInterval(updateIPCamera,1000);}const interval=currentSession.analysisInterval*1000;analysisInterval=setInterval(()=>{if(!isPaused&&currentSession){performAnalysis();}},interval);setTimeout(()=>performAnalysis(),3000);}catch(e){alert('❌ Canlı izleme başarısız: '+e.message);}}

async function initAudioAnalysis(stream){try{audioContext=new(window.AudioContext||window.webkitAudioContext)();const source=audioContext.createMediaStreamSource(stream);audioAnalyser=audioContext.createAnalyser();audioAnalyser.fftSize=256;source.connect(audioAnalyser);audioDataArray=new Uint8Array(audioAnalyser.frequencyBinCount);visualizeAudio();}catch(e){console.error('Audio analysis error:',e);}}

function visualizeAudio(){if(!audioAnalyser||isPaused)return;const canvas=document.getElementById('audioCanvas'),ctx=canvas.getContext('2d');canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;audioAnalyser.getByteFrequencyData(audioDataArray);ctx.clearRect(0,0,canvas.width,canvas.height);const barWidth=(canvas.width/audioDataArray.length)*2.5;let x=0;for(let i=0;i<audioDataArray.length;i++){const barHeight=(audioDataArray[i]/255)*canvas.height;ctx.fillStyle=`rgb(99, 102, 241)`;ctx.fillRect(x,canvas.height-barHeight,barWidth,barHeight);x+=barWidth+1;}const avgVolume=audioDataArray.reduce((a,b)=>a+b,0)/audioDataArray.length;const noiseLevel=avgVolume>50?'YÜKSEK':avgVolume>20?'ORTA':'DÜŞÜK';document.getElementById('liveAudioLevel').textContent=Math.round(avgVolume)+'%';document.getElementById('liveNoise').textContent=noiseLevel;requestAnimationFrame(visualizeAudio);}

function startTimer(){timerInterval=setInterval(()=>{if(!isPaused&&sessionStartTime){const elapsed=Date.now()-sessionStartTime;const hours=Math.floor(elapsed/3600000);const minutes=Math.floor((elapsed%3600000)/60000);const seconds=Math.floor((elapsed%60000)/1000);document.getElementById('sessionTimer').textContent=`${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;}},1000);}

async function performAnalysis(){if(!currentSession||isPaused)return;const camera=cameras.find(c=>c.id===currentSession.cameraId);if(!camera)return;let sourceElement;if(camera.type==='webcam'){sourceElement=document.getElementById('liveVideo');}else{sourceElement=document.getElementById('liveImage');}const canvas=document.getElementById('liveCanvas'),ctx=canvas.getContext('2d');canvas.width=sourceElement.videoWidth||sourceElement.naturalWidth||640;canvas.height=sourceElement.videoHeight||sourceElement.naturalHeight||480;try{ctx.drawImage(sourceElement,0,0,canvas.width,canvas.height);const aiAnalysis=await analyzeWithAI(canvas);const analysisData={timestamp:firebase.firestore.FieldValue.serverTimestamp(),aiAnalysis};await db.collection('users').doc(currentUser.uid).collection('sessions').doc(currentSession.id).collection('analyses').add(analysisData);await db.collection('users').doc(currentUser.uid).collection('sessions').doc(currentSession.id).update({analysisCount:firebase.firestore.FieldValue.increment(1)});updateLiveUI({timestamp:new Date().toISOString(),aiAnalysis});}catch(e){console.error('Analysis error:',e);}}

async function analyzeWithAI(canvas){try{const base64Image=canvas.toDataURL('image/jpeg',0.7);const model=currentSession.gptModel||'gpt-4o-mini';const isClass=currentSession.type==='class';const prompt=isClass?`Sınıf ortamını ultra detaylı analiz et. JSON formatında dön:
{
  "overall_score": 0-100,
  "focus_score": 0-10,
  "attention_level": "HIGH|MEDIUM|LOW",
  "classroom_environment": {
    "lighting": "EXCELLENT|GOOD|POOR",
    "noise_level": "QUIET|MODERATE|LOUD",
    "cleanliness": "CLEAN|MODERATE|MESSY",
    "organization": "ORGANIZED|MODERATE|DISORGANIZED",
    "temperature_comfort": "COMFORTABLE|TOO_HOT|TOO_COLD"
  },
  "visible_students": {
    "total_count": 0,
    "engaged_count": 0,
    "distracted_count": 0,
    "off_task_count": 0
  },
  "student_behaviors": {
    "taking_notes": 0,
    "using_devices": 0,
    "talking": 0,
    "sleeping": 0,
    "eating_drinking": 0,
    "out_of_seat": 0
  },
  "engagement_metrics": {
    "hands_raised": 0,
    "active_participation": "HIGH|MEDIUM|LOW",
    "peer_interaction": "COLLABORATIVE|INDIVIDUAL|DISRUPTIVE",
    "teacher_interaction": "HIGH|MEDIUM|LOW|NONE"
  },
  "attention_distribution": {
    "focused_on_board": 0,
    "focused_on_desk": 0,
    "looking_around": 0,
    "using_phone": 0
  },
  "posture_analysis": {
    "proper_seating": 0,
    "slouching": 0,
    "standing": 0,
    "restless": 0
  },
  "distractions": ["liste"],
  "positive_observations": ["liste"],
  "concerns": ["liste"],
  "recommendations": ["liste"],
  "detailed_observation": "kapsamlı türkçe gözlem (200-300 karakter)"
}`:`Öğrenciyi ultra detaylı analiz et. JSON formatında dön:
{
  "overall_score": 0-100,
  "focus_score": 0-10,
  "attention_level": "HIGH|MEDIUM|LOW",
  "cognitive_state": {
    "concentration_level": "DEEP|MODERATE|SHALLOW|DISTRACTED",
    "mental_fatigue": "ALERT|SLIGHTLY_TIRED|TIRED|EXHAUSTED",
    "processing_speed": "FAST|NORMAL|SLOW",
    "comprehension_indicators": "UNDERSTANDING|CONFUSED|STRUGGLING"
  },
  "body_language": {
    "posture": "EXCELLENT|GOOD|SLOUCHED|COLLAPSED",
    "posture_score": 0-10,
    "head_position": "UPRIGHT|TILTED|DOWN|RESTING",
    "shoulder_tension": "RELAXED|TENSE|HUNCHED",
    "spine_alignment": "STRAIGHT|CURVED|POOR"
  },
  "facial_analysis": {
    "eye_contact": "SCREEN|BOOK|AWAY|CLOSED",
    "eye_movement": "FOCUSED|SCANNING|WANDERING|TIRED",
    "blink_rate": "NORMAL|FREQUENT|RARE",
    "facial_expression": "FOCUSED|INTERESTED|BORED|FRUSTRATED|CONFUSED|STRESSED",
    "micro_expressions": ["liste"]
  },
  "hand_activity": {
    "primary_action": "WRITING|TYPING|READING|GESTURING|IDLE|FIDGETING",
    "writing_speed": "FAST|NORMAL|SLOW|NONE",
    "typing_quality": "ACTIVE|OCCASIONAL|NONE",
    "fidgeting_level": "NONE|SLIGHT|MODERATE|EXCESSIVE"
  },
  "engagement_indicators": {
    "note_taking": true/false,
    "using_reference_materials": true/false,
    "active_problem_solving": true/false,
    "pausing_to_think": true/false,
    "checking_answers": true/false
  },
  "environment_factors": {
    "desk_organization": "ORGANIZED|MODERATE|CLUTTERED|MESSY",
    "lighting_quality": "GOOD|POOR|HARSH|DIM",
    "study_materials_visible": ["liste"],
    "phone_visible": true/false,
    "food_drink_present": true/false,
    "other_people_nearby": true/false
  },
  "time_management_indicators": {
    "working_steadily": true/false,
    "taking_breaks": "APPROPRIATE|TOO_FREQUENT|NOT_ENOUGH",
    "pacing": "GOOD|TOO_FAST|TOO_SLOW",
    "multitasking": true/false
  },
  "emotional_state": {
    "primary_emotion": "FOCUSED|MOTIVATED|CALM|ANXIOUS|FRUSTRATED|BORED|TIRED",
    "stress_level": "LOW|MODERATE|HIGH",
    "confidence_level": "HIGH|MODERATE|LOW",
    "mood_indicators": ["liste"]
  },
  "distractions": {
    "internal": ["liste"],
    "external": ["liste"],
    "technology_related": ["liste"]
  },
  "productivity_assessment": {
    "output_quality": "HIGH|MODERATE|LOW",
    "work_consistency": "STEADY|INTERMITTENT|DECLINING",
    "efficiency_level": "OPTIMAL|MODERATE|SUBOPTIMAL"
  },
  "health_concerns": ["liste veya boş"],
  "strengths": ["liste - olumlu yönler"],
  "areas_for_improvement": ["liste - gelişim alanları"],
  "immediate_recommendations": ["liste - acil öneriler"],
  "long_term_suggestions": ["liste - uzun vadeli öneriler"],
  "detailed_observation": "çok detaylı türkçe gözlem ve analiz (300-400 karakter)"
}`;const response=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Authorization':`Bearer ${OPENAI_API_KEY}`,'Content-Type':'application/json'},body:JSON.stringify({model,max_tokens:2000,temperature:0.3,messages:[{role:'user',content:[{type:'text',text:prompt},{type:'image_url',image_url:{url:base64Image,detail:'low'}}]}]})});if(!response.ok)throw new Error(`OpenAI API error: ${response.status}`);const data=await response.json();const content=data.choices[0].message.content;const jsonMatch=content.match(/\{[\s\S]*\}/);return JSON.parse(jsonMatch?jsonMatch[0]:content);}catch(e){console.error('AI error:',e);return{overall_score:70,focus_score:7,attention_level:'MEDIUM',detailed_observation:'AI analizi geçici olarak kullanılamıyor (fallback mode)'};}
}

function updateLiveUI(analysis){const ai=analysis.aiAnalysis;document.getElementById('liveScore').textContent=(ai.overall_score||70)+'/100';document.getElementById('liveScoreBar').style.width=(ai.overall_score||70)+'%';document.getElementById('liveFocus').textContent=(ai.focus_score||7)+'/10';document.getElementById('liveAttention').textContent=ai.attention_level||'MEDIUM';document.getElementById('liveEmotion').textContent=ai.emotional_state?.primary_emotion||ai.emotional_state||'NEUTRAL';const log=document.getElementById('analysisLog'),time=new Date(analysis.timestamp).toLocaleTimeString('tr-TR');const attentionBadge=ai.attention_level==='HIGH'?'badge-success':ai.attention_level==='MEDIUM'?'badge-warning':'badge-danger';const logItem=document.createElement('div');logItem.className='log-item';logItem.innerHTML=`<div class="log-time">${time}</div><div class="log-content"><h4><span class="badge ${attentionBadge}">${ai.attention_level||'MEDIUM'}</span> <span class="badge badge-primary">Skor: ${ai.overall_score||70}/100</span></h4><p><strong>${ai.detailed_observation||'Analiz tamamlandı'}</strong></p>${currentSession.type==='class'&&ai.visible_students?`<div class="log-metrics"><div class="log-metric"><span class="log-metric-label">Görünen</span><span class="log-metric-value">${ai.visible_students.total_count||0}</span></div><div class="log-metric"><span class="log-metric-label">Odaklanmış</span><span class="log-metric-value">${ai.visible_students.engaged_count||0}</span></div><div class="log-metric"><span class="log-metric-label">Dağınık</span><span class="log-metric-value">${ai.visible_students.distracted_count||0}</span></div></div>`:''}</div>`;log.insertBefore(logItem,log.firstChild);while(log.children.length>15){log.removeChild(log.lastChild);}}

function pauseSession(){isPaused=true;document.getElementById('pauseBtn').style.display='none';document.getElementById('resumeBtn').style.display='inline-flex';}
function resumeSession(){isPaused=false;document.getElementById('pauseBtn').style.display='inline-flex';document.getElementById('resumeBtn').style.display='none';}
function endSession(){if(!confirm('Oturumu bitir?'))return;if(videoStream){videoStream.getTracks().forEach(track=>track.stop());}if(analysisInterval){clearInterval(analysisInterval);}if(timerInterval){clearInterval(timerInterval);}if(audioContext){audioContext.close();}db.collection('users').doc(currentUser.uid).collection('sessions').doc(currentSession.id).update({status:'completed',endTime:firebase.firestore.FieldValue.serverTimestamp()});currentSession=null;document.getElementById('liveContainer').style.display='none';document.getElementById('noActiveSession').style.display='block';alert('✅ Oturum tamamlandı!');}

function closeModal(modalId){document.getElementById(modalId).classList.remove('active');if(videoStream){videoStream.getTracks().forEach(track=>track.stop());videoStream=null;}}
window.onclick=e=>{if(e.target.classList.contains('modal')){e.target.classList.remove('active');if(videoStream){videoStream.getTracks().forEach(track=>track.stop());videoStream=null;}}};

console.log('✅ StudyFocus AI - Ultra Comprehensive System v2.0');
console.log('📊 Sınıf Yönetimi + Ses Analizi + Ultra Detaylı AI + Çoklu Öğrenci Analizi');
    </script>
</body>
</html>
