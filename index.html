<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoAnlyze - AI Video Analiz Platformu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .glass-dark { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .camera-card { transition: all 0.3s ease; }
        .camera-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .notification-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; background: #000; }
        .video-container video, .video-container img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-active { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-inactive { background: #6b7280; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass rounded-3xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold gradient-text mb-2">VideoAnlyze</h1>
                <p class="text-gray-600">AI Destekli Video Analiz Platformu</p>
            </div>
            
            <div class="space-y-4">
                <!-- Google Login -->
                <button onclick="loginWithGoogle()" class="w-full bg-white border-2 border-gray-200 hover:border-purple-500 text-gray-700 font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition-all">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Google ile Giriş Yap
                </button>

                <!-- Email Login -->
                <div id="emailForm" class="space-y-3">
                    <input id="emailInput" type="email" placeholder="E-posta" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all">
                    <input id="passwordInput" type="password" placeholder="Şifre" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all">
                    <button onclick="loginWithEmail()" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold py-3 px-4 rounded-xl transition-all">
                        E-posta ile Giriş
                    </button>
                    <button onclick="registerWithEmail()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-xl transition-all">
                        Kayıt Ol
                    </button>
                </div>

                <!-- Guest Login -->
                <button onclick="loginAsGuest()" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-semibold py-3 px-4 rounded-xl transition-all">
                    Misafir Olarak Devam Et
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen p-6">
        <!-- Header -->
        <div class="glass rounded-2xl shadow-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold gradient-text">VideoAnlyze</h1>
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <span class="status-indicator status-active"></span>
                        <span id="userEmail">Kullanıcı</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <select id="gptModel" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-4o-mini">GPT-4o-mini</option>
                    </select>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all">
                        Çıkış
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel - Cameras -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Add Camera -->
                <div class="glass rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4">Kamera Ekle</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="cameraName" type="text" placeholder="Kamera Adı" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <input id="cameraUrl" type="text" placeholder="IP Kamera URL / Android IP Webcam" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <select id="cameraType" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                            <option value="ip">IP Kamera</option>
                            <option value="android">Android IP Webcam</option>
                            <option value="rtsp">RTSP Stream</option>
                        </select>
                        <button onclick="addCamera()" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-lg font-semibold transition-all">
                            Kamera Ekle
                        </button>
                    </div>
                </div>

                <!-- Camera List -->
                <div id="cameraList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Cameras will be added here -->
                </div>
            </div>

            <!-- Right Panel - Notifications -->
            <div class="space-y-6">
                <!-- Active Alerts -->
                <div class="glass rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4">Aktif Uyarılar</h2>
                    <div id="notificationsList" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-sm">Henüz uyarı bulunmuyor</p>
                    </div>
                </div>

                <!-- Reports -->
                <div class="glass rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4">Son Raporlar</h2>
                    <div id="reportsList" class="space-y-3">
                        <p class="text-gray-500 text-sm">Henüz rapor oluşturulmamış</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera View Modal -->
    <div id="cameraModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="glass rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 id="modalCameraName" class="text-2xl font-bold">Kamera İzleme</h2>
                    <button onclick="closeCameraModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <!-- Video Display -->
                <div class="video-container rounded-xl overflow-hidden mb-4">
                    <img id="cameraStream" src="" alt="Camera Stream" class="hidden">
                    <video id="cameraVideo" autoplay muted class="hidden"></video>
                    <div id="cameraPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gray-900">
                        <p class="text-white">Kamera yükleniyor...</p>
                    </div>
                </div>

                <!-- Analysis Controls -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Analysis Questions -->
                    <div>
                        <h3 class="font-bold mb-3">Analiz Soruları</h3>
                        <div class="space-y-2 max-h-60 overflow-y-auto mb-3">
                            <div class="grid grid-cols-2 gap-2" id="analysisQuestions"></div>
                        </div>
                        <input id="customQuestion" type="text" placeholder="Özel soru ekle" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none mb-2">
                        <button onclick="startAnalysis()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition-all">
                            Analizi Başlat
                        </button>
                    </div>

                    <!-- Alert Settings -->
                    <div>
                        <h3 class="font-bold mb-3">Uyarı Ayarları</h3>
                        <div class="space-y-2 max-h-60 overflow-y-auto mb-3">
                            <div class="grid grid-cols-2 gap-2" id="alertTypes"></div>
                        </div>
                        <input id="customAlert" type="text" placeholder="Özel uyarı ekle" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                    </div>
                </div>

                <!-- Live Analysis Results -->
                <div id="analysisResults" class="mt-6 hidden">
                    <h3 class="font-bold mb-3">Canlı Analiz Sonuçları</h3>
                    <div id="analysisStream" class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto space-y-2"></div>
                </div>

                <!-- Report Generation -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-bold mb-3">Rapor Oluştur</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <input id="reportStartTime" type="datetime-local" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <input id="reportEndTime" type="datetime-local" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <select id="reportTopic" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                            <option value="">Rapor Konusu Seç</option>
                        </select>
                    </div>
                    <input id="customReportTopic" type="text" placeholder="Veya özel konu yaz" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none mt-3">
                    <button onclick="generateReport()" class="w-full mt-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition-all">
                        Rapor Oluştur
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase & OpenAI Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCbolraCD1nrOqcIE5GHPAaX9SRhHQXYIY",
            authDomain: "videoanlyze.firebaseapp.com",
            projectId: "videoanlyze",
            storageBucket: "videoanlyze.firebasestorage.app",
            messagingSenderId: "1053069335615",
            appId: "1:1053069335615:web:5dbf8f2345a5bf18b1ac8a",
            measurementId: "G-TLEWYXX05H"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const OPENAI_API_KEY = "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";

        window.db = db;
        window.auth = auth;
        window.storage = storage;

        // Predefined Analysis Questions
        const analysisQuestions = [
            "Kamera görüntüsünde kaç kişi var?",
            "Herhangi bir güvenlik tehdidi var mı?",
            "Kalabalık yoğunluğu nasıl?",
            "Hareket algılandı mı?",
            "Şüpheli davranış var mı?",
            "Araç sayısı nedir?",
            "Trafik durumu nasıl?",
            "Yaya geçişi var mı?",
            "Yangın veya duman var mı?",
            "Su baskını var mı?",
            "Kaza durumu var mı?",
            "İzinsiz giriş var mı?",
            "Maske kullanımı kontrol",
            "Sosyal mesafe kontrol",
            "Hijyen kurallarına uyum",
            "Ekipman kullanımı doğru mu?",
            "İş güvenliği ihlali var mı?",
            "Yetkisiz alan erişimi",
            "Silah veya tehlikeli nesne",
            "Kavga veya şiddet",
            "Düşme veya kaza riski",
            "Aydınlatma yeterli mi?",
            "Hava koşulları nasıl?",
            "Görüş kalitesi iyi mi?",
            "Gece görüşü aktif mi?",
            "Hayvan varlığı",
            "Çöp veya düzensizlik",
            "Bakım gereksinimi",
            "Enerji tüketimi analizi",
            "Verimlilik değerlendirmesi"
        ];

        // Predefined Alert Types
        const alertTypes = [
            "İzinsiz Giriş",
            "Şüpheli Hareket",
            "Kalabalık Uyarısı",
            "Yangın Algılandı",
            "Duman Tespit",
            "Su Baskını",
            "Kaza Durumu",
            "Düşme Algılandı",
            "Kavga/Şiddet",
            "Silah Tespit",
            "Maske Takılmamış",
            "Sosyal Mesafe İhlali",
            "Yetkisiz Alan Erişimi",
            "Ekipman Eksikliği",
            "İş Güvenliği İhlali",
            "Araç Hızlı Hareket",
            "Yanlış Yönde Hareket",
            "Park İhlali",
            "Trafik İhlali",
            "Yaya Güvenliği",
            "Hayvan Algılandı",
            "Nesne Bırakıldı",
            "Çöp Tespit",
            "Bakım Gerekli",
            "Aydınlatma Sorunu",
            "Kamera Arızası",
            "Düşük Görüş",
            "Hava Koşulları",
            "Enerji Kesintisi",
            "Sistem Uyarısı"
        ];

        // Report Topics
        const reportTopics = [
            "Günlük Güvenlik Özeti",
            "Haftalık Aktivite Raporu",
            "İhlal ve Uyarı Analizi",
            "Trafik Yoğunluk Raporu",
            "Kalabalık Analizi",
            "Olay İnceleme Raporu",
            "Performans Değerlendirmesi",
            "Risk Değerlendirmesi",
            "Uyumluluk Raporu",
            "Operasyonel Verimlilik"
        ];

        let currentUser = null;
        let currentCamera = null;
        let analysisInterval = null;
        let activeAlerts = new Map();

        // Initialize UI Elements
        function initializeUI() {
            // Analysis Questions
            const questionsContainer = document.getElementById('analysisQuestions');
            analysisQuestions.forEach((question, index) => {
                const checkbox = document.createElement('label');
                checkbox.className = 'flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded';
                checkbox.innerHTML = `
                    <input type="checkbox" class="analysis-question" data-question="${question}" value="${index}">
                    <span>${question}</span>
                `;
                questionsContainer.appendChild(checkbox);
            });

            // Alert Types
            const alertsContainer = document.getElementById('alertTypes');
            alertTypes.forEach((alert, index) => {
                const checkbox = document.createElement('label');
                checkbox.className = 'flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded';
                checkbox.innerHTML = `
                    <input type="checkbox" class="alert-type" data-alert="${alert}" value="${index}">
                    <span>${alert}</span>
                `;
                alertsContainer.appendChild(checkbox);
            });

            // Report Topics
            const reportSelect = document.getElementById('reportTopic');
            reportTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                reportSelect.appendChild(option);
            });
        }

        // Auth Functions
        window.loginWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('Google ile giriş başarısız: ' + error.message);
            }
        };

        window.loginWithEmail = async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('Giriş başarısız: ' + error.message);
            }
        };

        window.registerWithEmail = async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('Kayıt başarısız: ' + error.message);
            }
        };

        window.loginAsGuest = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                alert('Misafir girişi başarısız: ' + error.message);
            }
        };

        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                alert('Çıkış başarısız: ' + error.message);
            }
        };

        // Camera Functions
        window.addCamera = async () => {
            const name = document.getElementById('cameraName').value;
            const url = document.getElementById('cameraUrl').value;
            const type = document.getElementById('cameraType').value;

            if (!name || !url) {
                alert('Lütfen kamera adı ve URL girin');
                return;
            }

            try {
                await addDoc(collection(db, 'cameras'), {
                    userId: currentUser.uid,
                    name,
                    url,
                    type,
                    status: 'active',
                    createdAt: serverTimestamp()
                });

                document.getElementById('cameraName').value = '';
                document.getElementById('cameraUrl').value = '';
                loadCameras();
            } catch (error) {
                alert('Kamera eklenemedi: ' + error.message);
            }
        };

        window.deleteCamera = async (cameraId) => {
            if (!confirm('Bu kamerayı silmek istediğinize emin misiniz?')) return;

            try {
                await deleteDoc(doc(db, 'cameras', cameraId));
                loadCameras();
            } catch (error) {
                alert('Kamera silinemedi: ' + error.message);
            }
        };

        window.viewCamera = (camera) => {
            currentCamera = camera;
            document.getElementById('modalCameraName').textContent = camera.name;
            document.getElementById('cameraModal').classList.remove('hidden');

            // Load camera stream
            const streamImg = document.getElementById('cameraStream');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            streamImg.src = camera.url;
            streamImg.onload = () => {
                placeholder.classList.add('hidden');
                streamImg.classList.remove('hidden');
            };
            streamImg.onerror = () => {
                placeholder.innerHTML = '<p class="text-white">Kamera bağlantısı kurulamadı</p>';
            };

            // Refresh stream periodically for IP cameras
            if (camera.type === 'android') {
                setInterval(() => {
                    streamImg.src = camera.url + '?t=' + new Date().getTime();
                }, 1000);
            }
        };

        window.closeCameraModal = () => {
            document.getElementById('cameraModal').classList.add('hidden');
            if (analysisInterval) {
                clearInterval(analysisInterval);
                analysisInterval = null;
            }
            currentCamera = null;
        };

        async function loadCameras() {
            const q = query(collection(db, 'cameras'), where('userId', '==', currentUser.uid));
            const snapshot = await getDocs(q);
            
            const container = document.getElementById('cameraList');
            container.innerHTML = '';

            snapshot.forEach(doc => {
                const camera = { id: doc.id, ...doc.data() };
                const card = document.createElement('div');
                card.className = 'camera-card glass rounded-xl shadow-lg p-4 cursor-pointer';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-lg">${camera.name}</h3>
                        <span class="status-indicator ${camera.status === 'active' ? 'status-active' : 'status-inactive'}"></span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${camera.type.toUpperCase()}</p>
                    <div class="flex gap-2">
                        <button onclick='viewCamera(${JSON.stringify(camera)})' class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg text-sm transition-all">
                            İzle
                        </button>
                        <button onclick="deleteCamera('${camera.id}')" class="px-4 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg text-sm transition-all">
                            Sil
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Analysis Functions
        window.startAnalysis = async () => {
            const selectedQuestions = Array.from(document.querySelectorAll('.analysis-question:checked'))
                .map(cb => cb.dataset.question);
            const customQuestion = document.getElementById('customQuestion').value;
            
            if (customQuestion) selectedQuestions.push(customQuestion);
            if (selectedQuestions.length === 0) {
                alert('Lütfen en az bir analiz sorusu seçin');
                return;
            }

            const selectedAlerts = Array.from(document.querySelectorAll('.alert-type:checked'))
                .map(cb => cb.dataset.alert);
            const customAlert = document.getElementById('customAlert').value;
            if (customAlert) selectedAlerts.push(customAlert);

            document.getElementById('analysisResults').classList.remove('hidden');
            const resultsContainer = document.getElementById('analysisStream');
            
            // Start analysis loop
            analysisInterval = setInterval(async () => {
                await performAnalysis(selectedQuestions, selectedAlerts, resultsContainer);
            }, 10000); // Analyze every 10 seconds

            // First analysis immediately
            await performAnalysis(selectedQuestions, selectedAlerts, resultsContainer);
        };

        async function performAnalysis(questions, alerts, container) {
            const timestamp = new Date().toLocaleTimeString('tr-TR');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'bg-white p-3 rounded-lg border-l-4 border-purple-500';
            resultDiv.innerHTML = `<p class="text-xs text-gray-500 mb-1">${timestamp}</p><p class="text-sm">Analiz yapılıyor...</p>`;
            container.insertBefore(resultDiv, container.firstChild);

            try {
                const model = document.getElementById('gptModel').value;
                const analysisPrompt = `Sen bir AI video analiz asistanısın. Aşağıdaki sorulara göre görüntüyü analiz et ve kısa, net yanıtlar ver:

Analiz Soruları:
${questions.map((q, i) => `${i + 1}. ${q}`).join('\n')}

Uyarı Kontrolleri:
${alerts.map((a, i) => `${i + 1}. ${a}`).join('\n')}

Lütfen her soru ve uyarı için kısa yanıt ver. Uyarı tespit edersen, başına [UYARI] yaz.`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: 'user',
                                content: analysisPrompt
                            }
                        ],
                        max_tokens: 500
                    })
                });

                const data = await response.json();
                const analysisResult = data.choices[0].message.content;

                resultDiv.innerHTML = `
                    <p class="text-xs text-gray-500 mb-1">${timestamp}</p>
                    <p class="text-sm whitespace-pre-wrap">${analysisResult}</p>
                `;

                // Save to Firestore
                await addDoc(collection(db, 'analyses'), {
                    userId: currentUser.uid,
                    cameraId: currentCamera.id,
                    cameraName: currentCamera.name,
                    questions,
                    alerts,
                    result: analysisResult,
                    model,
                    timestamp: serverTimestamp()
                });

                // Check for alerts
                if (analysisResult.includes('[UYARI]')) {
                    const alertLines = analysisResult.split('\n').filter(line => line.includes('[UYARI]'));
                    for (const alertLine of alertLines) {
                        await createAlert(alertLine.replace('[UYARI]', '').trim());
                    }
                }

            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="text-xs text-gray-500 mb-1">${timestamp}</p>
                    <p class="text-sm text-red-500">Analiz hatası: ${error.message}</p>
                `;
            }
        }

        async function createAlert(message) {
            const alertId = 'alert_' + Date.now();
            
            if (activeAlerts.has(message)) return; // Already exists
            
            activeAlerts.set(message, alertId);

            try {
                await addDoc(collection(db, 'alerts'), {
                    userId: currentUser.uid,
                    cameraId: currentCamera.id,
                    cameraName: currentCamera.name,
                    message,
                    status: 'active',
                    createdAt: serverTimestamp()
                });

                showNotification(message);
                loadAlerts();
            } catch (error) {
                console.error('Alert creation error:', error);
            }
        }

        function showNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'notification-enter fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-xl shadow-2xl z-50';
            notif.innerHTML = `
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div>
                        <p class="font-semibold">Yeni Uyarı!</p>
                        <p class="text-sm">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 5000);
        }

        async function loadAlerts() {
            const q = query(
                collection(db, 'alerts'),
                where('userId', '==', currentUser.uid),
                where('status', '==', 'active')
            );
            const snapshot = await getDocs(q);
            
            const container = document.getElementById('notificationsList');
            container.innerHTML = '';

            if (snapshot.empty) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Henüz uyarı bulunmuyor</p>';
                return;
            }

            snapshot.forEach(doc => {
                const alert = { id: doc.id, ...doc.data() };
                const alertDiv = document.createElement('div');
                alertDiv.className = 'bg-red-50 border-l-4 border-red-500 p-3 rounded-lg';
                alertDiv.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="font-semibold text-sm">${alert.cameraName}</p>
                            <p class="text-sm text-gray-700">${alert.message}</p>
                        </div>
                        <button onclick="resolveAlert('${alert.id}')" class="text-red-600 hover:text-red-800 text-sm">
                            ✓
                        </button>
                    </div>
                `;
                container.appendChild(alertDiv);
            });
        }

        window.resolveAlert = async (alertId) => {
            try {
                await updateDoc(doc(db, 'alerts', alertId), {
                    status: 'resolved',
                    resolvedAt: serverTimestamp()
                });
                loadAlerts();
            } catch (error) {
                alert('Uyarı pasifleştirilemedi: ' + error.message);
            }
        };

        // Report Functions
        window.generateReport = async () => {
            const startTime = document.getElementById('reportStartTime').value;
            const endTime = document.getElementById('reportEndTime').value;
            const topic = document.getElementById('reportTopic').value || document.getElementById('customReportTopic').value;

            if (!startTime || !endTime || !topic) {
                alert('Lütfen tüm alanları doldurun');
                return;
            }

            try {
                const model = document.getElementById('gptModel').value;
                
                // Get analyses in time range
                const analysesQuery = query(
                    collection(db, 'analyses'),
                    where('userId', '==', currentUser.uid),
                    where('cameraId', '==', currentCamera.id)
                );
                const analysesSnapshot = await getDocs(analysesQuery);
                
                const relevantAnalyses = [];
                analysesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const timestamp = data.timestamp?.toDate();
                    if (timestamp >= new Date(startTime) && timestamp <= new Date(endTime)) {
                        relevantAnalyses.push(data.result);
                    }
                });

                const reportPrompt = `Sen bir profesyonel video analiz rapor uzmanısın. Aşağıdaki verilere göre "${topic}" konusunda detaylı bir rapor hazırla:

Kamera: ${currentCamera.name}
Tarih Aralığı: ${new Date(startTime).toLocaleString('tr-TR')} - ${new Date(endTime).toLocaleString('tr-TR')}

Analiz Verileri:
${relevantAnalyses.join('\n\n---\n\n')}

Lütfen aşağıdaki başlıkları içeren detaylı bir rapor oluştur:
1. Yönetici Özeti
2. Anahtar Bulgular
3. Detaylı Analiz
4. Öneriler
5. Sonuç

Rapor profesyonel, açıklayıcı ve eyleme dönük olmalı.`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: reportPrompt }],
                        max_tokens: 2000
                    })
                });

                const data = await response.json();
                const reportContent = data.choices[0].message.content;

                // Save report
                await addDoc(collection(db, 'reports'), {
                    userId: currentUser.uid,
                    cameraId: currentCamera.id,
                    cameraName: currentCamera.name,
                    topic,
                    startTime,
                    endTime,
                    content: reportContent,
                    model,
                    createdAt: serverTimestamp()
                });

                alert('Rapor başarıyla oluşturuldu!');
                loadReports();

                // Download report
                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${topic}_${new Date().toISOString()}.txt`;
                a.click();

            } catch (error) {
                alert('Rapor oluşturulamadı: ' + error.message);
            }
        };

        async function loadReports() {
            const q = query(
                collection(db, 'reports'),
                where('userId', '==', currentUser.uid)
            );
            const snapshot = await getDocs(q);
            
            const container = document.getElementById('reportsList');
            container.innerHTML = '';

            if (snapshot.empty) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Henüz rapor oluşturulmamış</p>';
                return;
            }

            const reports = [];
            snapshot.forEach(doc => {
                reports.push({ id: doc.id, ...doc.data() });
            });

            reports.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());
            reports.slice(0, 5).forEach(report => {
                const reportDiv = document.createElement('div');
                reportDiv.className = 'bg-blue-50 border-l-4 border-blue-500 p-3 rounded-lg cursor-pointer hover:bg-blue-100 transition-all';
                reportDiv.onclick = () => {
                    const blob = new Blob([report.content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${report.topic}_${report.id}.txt`;
                    a.click();
                };
                reportDiv.innerHTML = `
                    <p class="font-semibold text-sm">${report.topic}</p>
                    <p class="text-xs text-gray-600">${report.cameraName}</p>
                    <p class="text-xs text-gray-500">${report.createdAt?.toDate().toLocaleString('tr-TR')}</p>
                `;
                container.appendChild(reportDiv);
            });
        }

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email || 'Misafir Kullanıcı';
                
                initializeUI();
                await loadCameras();
                await loadAlerts();
                await loadReports();

                // Refresh alerts periodically
                setInterval(loadAlerts, 30000);
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
