<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityMarket - D√ºnya ≈ûehir Platformu</title>
    
    <!-- AmCharts -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/data/countries2.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #fff;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: drift 20s linear infinite;
        }

        @keyframes drift {
            from { transform: translate(0, 0); }
            to { transform: translate(50px, 50px); }
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 30px;
            padding: 50px 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .logo h1 {
            font-size: 36px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .logo p {
            color: #666;
            font-size: 15px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 15px;
            color: #333;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input::placeholder {
            color: #999;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-google {
            background: white;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 2px solid #f0f0f0;
        }

        .btn-google:hover {
            border-color: #667eea;
        }

        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .divider span {
            color: #999;
            font-size: 14px;
            background: rgba(255,255,255,0.95);
            padding: 0 10px;
        }

        /* Main App */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 12px;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 15px;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.2);
            color: #fff;
        }

        .balance-badge {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.3);
        }

        /* Map Container */
        #mapContainer {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0e27;
        }

        /* Search Bar */
        .search-overlay {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            width: 90%;
            max-width: 600px;
        }

        .search-bar {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
        }

        .search-bar input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-bar input:focus {
            outline: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e2a5e, #2d1b4e);
            border-radius: 30px;
            padding: 40px;
            max-width: 550px;
            width: 100%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-detail {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-detail:last-child {
            border-bottom: none;
        }

        .modal-detail label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .modal-detail span {
            font-weight: 700;
            font-size: 16px;
        }

        /* Canvas */
        #flagCanvas {
            width: 100%;
            background: white;
            border-radius: 15px;
            cursor: crosshair;
            touch-action: none;
            margin-bottom: 20px;
        }

        .color-palette {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .color-btn {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-btn.active {
            border-color: white;
            transform: scale(1.15);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Other Pages Container */
        .page-container {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 30px;
            background: #0a0e27;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .city-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .city-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 15px;
            transition: all 0.3s;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .back-btn:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        .page-title {
            font-size: 42px;
            margin-bottom: 30px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #ffc107;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .navbar {
                padding: 15px 20px;
            }

            #mapContainer {
                top: 70px;
            }

            .page-container {
                top: 70px;
                padding: 20px;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="logo">
                <div class="logo-icon">üåç</div>
                <h1>CityMarket</h1>
                <p>D√ºnya ≈ûehirlerini Ke≈üfet ve Sahip Ol</p>
            </div>

            <div id="loginForm">
                <div class="input-group">
                    <input type="email" id="loginEmail" placeholder="E-posta adresiniz">
                </div>
                <div class="input-group">
                    <input type="password" id="loginPassword" placeholder="≈ûifreniz">
                </div>
                <button class="btn btn-primary" onclick="handleLogin('email')">Giri≈ü Yap</button>
                <button class="btn btn-secondary" onclick="toggleRegister()">Hesap Olu≈ütur</button>
            </div>

            <div id="registerForm" class="hidden">
                <div class="input-group">
                    <input type="text" id="registerName" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z">
                </div>
                <div class="input-group">
                    <input type="email" id="registerEmail" placeholder="E-posta adresiniz">
                </div>
                <div class="input-group">
                    <input type="password" id="registerPassword" placeholder="≈ûifreniz">
                </div>
                <button class="btn btn-primary" onclick="handleRegister()">Kayƒ±t Ol</button>
                <button class="btn btn-secondary" onclick="toggleRegister()">Giri≈ü Sayfasƒ±na D√∂n</button>
            </div>

            <div class="divider">
                <span>veya</span>
            </div>

            <button class="btn btn-google" onclick="handleLogin('google')">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google ile Giri≈ü
            </button>
            <button class="btn btn-secondary" onclick="handleLogin('guest')">Misafir Olarak Devam Et</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="nav-brand">
                üåç CityMarket
            </div>
            <div class="nav-menu">
                <a href="#" class="nav-link" onclick="showPage('home')">Harita</a>
                <a href="#" class="nav-link" onclick="showPage('market')">Borsa</a>
                <a href="#" class="nav-link" onclick="showPage('wallet')">C√ºzdan</a>
                <a href="#" class="nav-link" onclick="showPage('profile')">Profil</a>
                <a href="#" class="nav-link" id="adminLink" onclick="showPage('admin')" style="display: none;">Admin</a>
                <span class="balance-badge" id="navBalance">0 USDT</span>
                <a href="#" class="nav-link" onclick="handleLogout()" style="opacity: 0.7;">√áƒ±kƒ±≈ü</a>
            </div>
        </nav>

        <!-- Home Page - Map -->
        <div id="homePage">
            <div class="search-overlay">
                <div class="search-bar">
                    <span style="font-size: 20px;">üîç</span>
                    <input type="text" id="searchInput" placeholder="√úlke veya ≈üehir ara..." oninput="searchOnMap()">
                </div>
            </div>
            <div id="mapContainer"></div>
        </div>

        <!-- Other Pages -->
        <div id="marketPage" class="page-container hidden">
            <div class="container">
                <button class="back-btn" onclick="showPage('home')">‚Üê Haritaya D√∂n</button>
                <h2 class="page-title">Borsa - ≈ûehir Alƒ±m Satƒ±m</h2>
                <div class="card">
                    <div id="marketOrders"></div>
                </div>
            </div>
        </div>

        <div id="walletPage" class="page-container hidden">
            <div class="container">
                <button class="back-btn" onclick="showPage('home')">‚Üê Haritaya D√∂n</button>
                <h2 class="page-title">C√ºzdan</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px;">
                    <div class="card">
                        <h3 style="margin-bottom: 25px; font-size: 24px;">üí∞ Para Yatƒ±r</h3>
                        <div class="input-group">
                            <input type="number" id="depositAmount" placeholder="Miktar (USDT)">
                        </div>
                        <div class="alert alert-warning">
                            Demo moddasƒ±nƒ±z. ƒ∞stediƒüiniz miktarƒ± yatƒ±rabilirsiniz!
                        </div>
                        <button class="btn btn-primary" onclick="handleDeposit()">Yatƒ±r</button>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 25px; font-size: 24px;">üí∏ Para √áek</h3>
                        <div class="input-group">
                            <input type="number" id="withdrawAmount" placeholder="Miktar (USDT)">
                        </div>
                        <div class="input-group">
                            <input type="text" id="withdrawWallet" placeholder="C√ºzdan Adresi">
                        </div>
                        <button class="btn btn-primary" onclick="handleWithdraw()">√áekim Talebi Olu≈ütur</button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 25px; font-size: 24px;">ƒ∞≈ülem Ge√ßmi≈üi</h3>
                    <div id="transactionList"></div>
                </div>
            </div>
        </div>

        <div id="profilePage" class="page-container hidden">
            <div class="container">
                <button class="back-btn" onclick="showPage('home')">‚Üê Haritaya D√∂n</button>
                <h2 class="page-title">Profil</h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 30px;">
                        <div>
                            <h3 style="font-size: 32px; margin-bottom: 10px;" id="profileName"></h3>
                            <p style="color: rgba(255,255,255,0.6); font-size: 16px;" id="profileEmail"></p>
                        </div>
                        <img id="profileFlag" src="" alt="flag" style="width: 120px; height: 80px; object-fit: cover; border-radius: 15px; border: 3px solid #667eea; display: none;">
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card green">
                            <div class="stat-label">Toplam Bakiye</div>
                            <div class="stat-value" id="profileBalance">0 USDT</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Sahip Olunan ≈ûehir</div>
                            <div class="stat-value" id="profileCityCount">0</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-label">Portf√∂y Deƒüeri</div>
                            <div class="stat-value" id="profileTotalValue">0 USDT</div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="openFlagEditor()">üé® Bayrak Tasarla</button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 25px; font-size: 24px;">≈ûehirlerim</h3>
                    <div class="city-grid" id="myCitiesGrid"></div>
                </div>
            </div>
        </div>

        <div id="adminPage" class="page-container hidden">
            <div class="container">
                <button class="back-btn" onclick="showPage('home')">‚Üê Haritaya D√∂n</button>
                <h2 class="page-title">Admin Paneli</h2>
                
                <div class="card">
                    <h3 style="margin-bottom: 25px; font-size: 24px;">Kullanƒ±cƒ±lar</h3>
                    <div id="adminUsers"></div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 25px; font-size: 24px;">T√ºm ƒ∞≈ülemler</h3>
                    <div id="adminTransactions"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- City Modal -->
    <div id="cityModal" class="modal hidden" onclick="closeCityModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closeCityModal()">√ó</button>
            <div class="modal-header">
                <h2 id="modalCityName"></h2>
                <p style="color: rgba(255,255,255,0.7);" id="modalCityCountry"></p>
            </div>
            <img id="modalCityFlag" src="" alt="flag" style="width: 100%; height: 220px; object-fit: cover; border-radius: 20px; margin-bottom: 25px; display: none;">
            <div id="modalCityDetails"></div>
            <div id="modalCityActions"></div>
        </div>
    </div>

    <!-- Flag Editor Modal -->
    <div id="flagModal" class="modal hidden" onclick="closeFlagEditor()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closeFlagEditor()">√ó</button>
            <div class="modal-header">
                <h2>Bayrak Tasarla</h2>
            </div>
            <canvas id="flagCanvas" width="600" height="400"></canvas>
            <div class="color-palette" id="colorPalette"></div>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-secondary" onclick="clearCanvas()" style="flex: 1;">Temizle</button>
                <button class="btn btn-primary" onclick="saveFlag()" style="flex: 1;">Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let cities = {};
        let users = {};
        let transactions = [];
        let marketOrders = [];
        let selectedCity = null;
        let isDrawing = false;
        let currentColor = '#FF0000';
        let mapRoot = null;
        let mapChart = null;
        let worldSeries = null;
        let citySeries = null;
        let backContainer = null;
        const canvas = document.getElementById('flagCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;

        // City Data by Country
        const cityDataByCountry = {
            'TR': [
                { name: 'ƒ∞stanbul', lat: 41.0082, lon: 28.9784, price: 5000 },
                { name: 'Ankara', lat: 39.9334, lon: 32.8597, price: 3000 },
                { name: 'ƒ∞zmir', lat: 38.4237, lon: 27.1428, price: 2500 }
            ],
            'US': [
                { name: 'New York', lat: 40.7128, lon: -74.0060, price: 10000 },
                { name: 'Los Angeles', lat: 34.0522, lon: -118.2437, price: 9000 },
                { name: 'Chicago', lat: 41.8781, lon: -87.6298, price: 7000 }
            ],
            'GB': [
                { name: 'London', lat: 51.5074, lon: -0.1278, price: 8000 },
                { name: 'Manchester', lat: 53.4808, lon: -2.2426, price: 5000 }
            ],
            'FR': [
                { name: 'Paris', lat: 48.8566, lon: 2.3522, price: 7500 },
                { name: 'Marseille', lat: 43.2965, lon: 5.3698, price: 4500 }
            ],
            'DE': [
                { name: 'Berlin', lat: 52.5200, lon: 13.4050, price: 6500 },
                { name: 'Munich', lat: 48.1351, lon: 11.5820, price: 6000 }
            ],
            'IT': [
                { name: 'Roma', lat: 41.9028, lon: 12.4964, price: 7000 },
                { name: 'Milano', lat: 45.4642, lon: 9.1900, price: 6500 }
            ],
            'ES': [
                { name: 'Madrid', lat: 40.4168, lon: -3.7038, price: 6000 },
                { name: 'Barcelona', lat: 41.3851, lon: 2.1734, price: 5500 }
            ],
            'JP': [
                { name: 'Tokyo', lat: 35.6762, lon: 139.6503, price: 12000 },
                { name: 'Osaka', lat: 34.6937, lon: 135.5023, price: 9000 }
            ],
            'CN': [
                { name: 'Beijing', lat: 39.9042, lon: 116.4074, price: 11000 },
                { name: 'Shanghai', lat: 31.2304, lon: 121.4737, price: 10500 }
            ]
        };

        // Initialize Cities
        function initDemoData() {
            cities = {};
            let cityId = 0;
            for (let country in cityDataByCountry) {
                cityDataByCountry[country].forEach(cityInfo => {
                    const id = 'city_' + cityId++;
                    cities[id] = {
                        id: id,
                        name: cityInfo.name,
                        country: country,
                        lat: cityInfo.lat,
                        lon: cityInfo.lon,
                        price: cityInfo.price,
                        owner: null,
                        flag: null,
                        initialPrice: cityInfo.price,
                        priceHistory: []
                    };
                });
            }

            users = {
                'demo1': { id: 'demo1', name: 'Demo Admin', email: 'admin@citymarket.com', balance: 100000, cities: [], flag: null, isAdmin: true }
            };
        }

        // Initialize Map
        function initMap() {
            if (mapRoot) {
                mapRoot.dispose();
            }

            mapRoot = am5.Root.new("mapContainer");
            mapRoot.setThemes([am5themes_Animated.new(mapRoot)]);

            mapChart = mapRoot.container.children.push(am5map.MapChart.new(mapRoot, {
                panX: "rotateX",
                projection: am5map.geoMercator(),
                maxZoomLevel: 32,
                homeZoomLevel: 1
            }));

            // World Series
            worldSeries = mapChart.series.push(am5map.MapPolygonSeries.new(mapRoot, {
                geoJSON: am5geodata_worldLow,
                exclude: ["AQ"]
            }));

            worldSeries.mapPolygons.template.setAll({
                tooltipText: "{name}",
                interactive: true,
                fill: am5.color(0x555555),
                strokeWidth: 0.5,
                stroke: am5.color(0x000000)
            }));

            worldSeries.mapPolygons.template.states.create("hover", {
                fill: am5.color(0x667eea)
            });

            // Country Click Event
            worldSeries.mapPolygons.template.events.on("click", (ev) => {
                const dataItem = ev.target.dataItem;
                const data = dataItem.dataContext;
                const countryId = data.id;
                
                // Check if we have cities for this country
                if (cityDataByCountry[countryId]) {
                    const zoomAnimation = worldSeries.zoomToDataItem(dataItem);

                    Promise.all([
                        zoomAnimation.waitForStop(),
                        am5.net.load("https://cdn.amcharts.com/lib/5/geodata/json/" + data.map + ".json", mapChart)
                    ]).then((results) => {
                        const geodata = am5.JSONParser.parse(results[1].response);
                        citySeries.setAll({
                            geoJSON: geodata,
                            fill: am5.color(0x666666)
                        });

                        // Add city points
                        addCityPoints(countryId);

                        citySeries.show();
                        worldSeries.hide(100);
                        backContainer.show();
                    });
                }
            });

            // City Series
            citySeries = mapChart.series.push(am5map.MapPolygonSeries.new(mapRoot, {
                visible: false
            }));

            citySeries.mapPolygons.template.setAll({
                tooltipText: "{name}",
                interactive: true,
                fill: am5.color(0x666666)
            });

            citySeries.mapPolygons.template.states.create("hover", {
                fill: am5.color(0x764ba2)
            });

            // City Point Series
            window.cityPointSeries = mapChart.series.push(am5map.MapPointSeries.new(mapRoot, {
                visible: false
            }));

            // Back Button
            backContainer = mapChart.children.push(am5.Container.new(mapRoot, {
                x: am5.p100,
                centerX: am5.p100,
                dx: -10,
                paddingTop: 10,
                paddingRight: 15,
                paddingBottom: 10,
                paddingLeft: 15,
                y: 30,
                interactiveChildren: false,
                layout: mapRoot.horizontalLayout,
                cursorOverStyle: "pointer",
                background: am5.RoundedRectangle.new(mapRoot, {
                    fill: am5.color(0x667eea),
                    fillOpacity: 0.9
                }),
                visible: false
            }));

            backContainer.children.push(am5.Label.new(mapRoot, {
                text: "‚Üê D√ºnya Haritasƒ±",
                centerY: am5.p50,
                fill: am5.color(0xffffff),
                fontSize: 14
            }));

            backContainer.events.on("click", function() {
                mapChart.goHome();
                worldSeries.show();
                citySeries.hide();
                window.cityPointSeries.hide();
                backContainer.hide();
            });
        }

        function addCityPoints(countryId) {
            if (!cityDataByCountry[countryId]) return;

            window.cityPointSeries.bullets.clear();
            
            window.cityPointSeries.bullets.push(function() {
                const container = am5.Container.new(mapRoot, {});
                
                const circle = container.children.push(am5.Circle.new(mapRoot, {
                    radius: 6,
                    fill: am5.color(0x667eea),
                    stroke: am5.color(0xffffff),
                    strokeWidth: 2,
                    tooltipText: "{name}\n{price} USDT",
                    cursorOverStyle: "pointer"
                }));

                circle.events.on("click", function(ev) {
                    const cityId = ev.target.dataItem.dataContext.cityId;
                    openCityModal(cities[cityId]);
                });

                circle.states.create("hover", {
                    fill: am5.color(0x764ba2),
                    scale: 1.5
                });

                return am5.Bullet.new(mapRoot, {
                    sprite: container
                });
            });

            const points = [];
            for (let cityId in cities) {
                const city = cities[cityId];
                if (city.country === countryId) {
                    points.push({
                        cityId: city.id,
                        name: city.name,
                        price: city.price.toFixed(0),
                        geometry: {
                            type: "Point",
                            coordinates: [city.lon, city.lat]
                        }
                    });
                }
            }

            window.cityPointSeries.data.setAll(points);
            window.cityPointSeries.show();
        }

        // Login Functions
        function toggleRegister() {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
        }

        function handleLogin(type) {
            if (type === 'google') {
                createUser('Google User', 'google@user.com', 10000, false);
            } else if (type === 'guest') {
                createUser('Misafir Kullanƒ±cƒ±', 'guest@user.com', 5000, false);
            } else if (type === 'email') {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    alert('L√ºtfen t√ºm alanlarƒ± doldurun');
                    return;
                }
                
                const user = Object.values(users).find(u => u.email === email);
                if (user) {
                    currentUser = user;
                    showMainApp();
                } else {
                    alert('Kullanƒ±cƒ± bulunamadƒ±');
                }
            }
        }

        function handleRegister() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                alert('L√ºtfen t√ºm alanlarƒ± doldurun');
                return;
            }
            
            createUser(name, email, 10000, false);
        }

        function createUser(name, email, balance, isAdmin) {
            const userId = 'user_' + Date.now();
            const newUser = {
                id: userId,
                name: name,
                email: email,
                balance: balance,
                cities: [],
                flag: null,
                isAdmin: isAdmin
            };
            users[userId] = newUser;
            currentUser = newUser;
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateNavBalance();
            if (currentUser.isAdmin) {
                document.getElementById('adminLink').style.display = 'block';
            }
            setTimeout(() => initMap(), 100);
        }

        function handleLogout() {
            if (mapRoot) {
                mapRoot.dispose();
                mapRoot = null;
            }
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            showPage('home');
        }

        function showPage(pageName) {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('marketPage').classList.add('hidden');
            document.getElementById('walletPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            if (pageName === 'home') {
                document.getElementById('homePage').classList.remove('hidden');
                if (!mapRoot) setTimeout(() => initMap(), 100);
            } else {
                document.getElementById(pageName + 'Page').classList.remove('hidden');
            }
            
            if (pageName === 'market') renderMarket();
            if (pageName === 'wallet') renderWallet();
            if (pageName === 'profile') renderProfile();
            if (pageName === 'admin') renderAdmin();
        }

        function searchOnMap() {
            // Implement search functionality
        }

        function openCityModal(city) {
            selectedCity = city;
            const modal = document.getElementById('cityModal');
            document.getElementById('modalCityName').textContent = city.name;
            document.getElementById('modalCityCountry').textContent = 'üìç ' + city.country;
            
            const flagImg = document.getElementById('modalCityFlag');
            if (city.flag) {
                flagImg.src = city.flag;
                flagImg.style.display = 'block';
            } else {
                flagImg.style.display = 'none';
            }
            
            const details = document.getElementById('modalCityDetails');
            const changePercent = ((city.price - city.initialPrice) / city.initialPrice * 100).toFixed(2);
            details.innerHTML = `
                <div class="modal-detail">
                    <label>Fiyat</label>
                    <span style="color: #11998e; font-size: 22px;">${city.price.toFixed(2)} USDT</span>
                </div>
                ${city.owner ? `
                    <div class="modal-detail">
                        <label>Sahibi</label>
                        <span style="color: #667eea;">${users[city.owner]?.name}</span>
                    </div>
                ` : ''}
                <div class="modal-detail">
                    <label>ƒ∞lk Fiyat</label>
                    <span>${city.initialPrice.toFixed(2)} USDT</span>
                </div>
                <div class="modal-detail">
                    <label>Deƒüi≈üim</label>
                    <span style="color: ${changePercent >= 0 ? '#11998e' : '#e74c3c'}">
                        ${changePercent >= 0 ? '+' : ''}${changePercent}%
                    </span>
                </div>
            `;
            
            const actions = document.getElementById('modalCityActions');
            if (city.owner === currentUser?.id) {
                actions.innerHTML = `
                    <div style="margin-top: 25px;">
                        <input type="number" id="sellPrice" placeholder="Satƒ±≈ü Fiyatƒ± (USDT)" style="width: 100%; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="listCityForSale()">Borsaya √áƒ±kar</button>
                    </div>
                `;
            } else if (city.owner) {
                actions.innerHTML = `
                    <div class="alert alert-warning" style="margin-top: 25px;">
                        Bu ≈üehir ${users[city.owner]?.name} kullanƒ±cƒ±sƒ±na ait. Borsadan satƒ±n alabilirsiniz.
                    </div>
                `;
            } else {
                actions.innerHTML = `
                    <button class="btn btn-primary" onclick="buyCity()" style="margin-top: 25px; font-size: 18px; padding: 18px;" ${currentUser.balance >= city.price ? '' : 'disabled'}>
                        ${currentUser.balance >= city.price ? 'üí∞ Satƒ±n Al - ' + city.price + ' USDT' : '‚ùå Yetersiz Bakiye'}
                    </button>
                `;
            }
            
            modal.classList.remove('hidden');
        }

        function closeCityModal() {
            document.getElementById('cityModal').classList.add('hidden');
            selectedCity = null;
        }

        function buyCity() {
            if (!selectedCity || currentUser.balance < selectedCity.price) return;
            
            currentUser.balance -= selectedCity.price;
            users[currentUser.id].balance = currentUser.balance;
            
            cities[selectedCity.id].owner = currentUser.id;
            cities[selectedCity.id].flag = currentUser.flag;
            
            users[currentUser.id].cities.push(selectedCity.id);
            
            transactions.push({
                id: Date.now(),
                type: 'buy',
                city: selectedCity.name,
                amount: selectedCity.price,
                date: new Date().toISOString(),
                userId: currentUser.id
            });
            
            updateNavBalance();
            closeCityModal();
            alert(`üéâ ${selectedCity.name} ≈üehrini ba≈üarƒ±yla satƒ±n aldƒ±nƒ±z!`);
        }

        function listCityForSale() {
            const price = parseFloat(document.getElementById('sellPrice').value);
            if (!price || price <= 0) {
                alert('L√ºtfen ge√ßerli bir fiyat girin');
                return;
            }
            
            marketOrders.push({
                id: Date.now(),
                cityId: selectedCity.id,
                sellerId: currentUser.id,
                price: price,
                date: new Date().toISOString()
            });
            
            closeCityModal();
            alert('≈ûehir borsaya √ßƒ±karƒ±ldƒ±!');
        }

        function renderMarket() {
            const container = document.getElementById('marketOrders');
            
            if (marketOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 60px; margin-bottom: 20px;">üìà</div>
                        <p>Hen√ºz satƒ±≈üta ≈üehir bulunmuyor</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            marketOrders.forEach(order => {
                const city = cities[order.cityId];
                const seller = users[order.sellerId];
                
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="font-size: 22px; margin-bottom: 8px;">${city.name}</h3>
                            <p style="color: rgba(255,255,255,0.6);">Satƒ±cƒ±: ${seller?.name}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 28px; font-weight: 800; color: #11998e; margin-bottom: 15px;">
                                ${order.price.toFixed(2)} USDT
                            </div>
                            ${order.sellerId !== currentUser?.id ? `
                                <button class="btn btn-primary" onclick="buyFromMarket(${order.id})" ${currentUser.balance < order.price ? 'disabled' : ''}>
                                    Satƒ±n Al
                                </button>
                            ` : '<span style="color: rgba(255,255,255,0.5);">Sizin ilanƒ±nƒ±z</span>'}
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function buyFromMarket(orderId) {
            const order = marketOrders.find(o => o.id === orderId);
            if (!order || currentUser.balance < order.price) return;
            
            const city = cities[order.cityId];
            
            currentUser.balance -= order.price;
            users[currentUser.id].balance = currentUser.balance;
            users[order.sellerId].balance += order.price;
            
            users[order.sellerId].cities = users[order.sellerId].cities.filter(c => c !== order.cityId);
            users[currentUser.id].cities.push(order.cityId);
            
            cities[order.cityId].owner = currentUser.id;
            cities[order.cityId].flag = currentUser.flag;
            cities[order.cityId].price = order.price * 1.1;
            
            transactions.push({
                id: Date.now(),
                type: 'buy',
                city: city.name,
                amount: order.price,
                date: new Date().toISOString(),
                userId: currentUser.id
            });
            
            marketOrders = marketOrders.filter(o => o.id !== orderId);
            
            updateNavBalance();
            renderMarket();
            alert(`üéâ ${city.name} ≈üehrini ba≈üarƒ±yla satƒ±n aldƒ±nƒ±z!`);
        }

        function handleDeposit() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            if (!amount || amount <= 0) {
                alert('L√ºtfen ge√ßerli bir miktar girin');
                return;
            }
            
            currentUser.balance += amount;
            users[currentUser.id].balance = currentUser.balance;
            
            transactions.push({
                id: Date.now(),
                type: 'deposit',
                amount: amount,
                date: new Date().toISOString(),
                userId: currentUser.id
            });
            
            document.getElementById('depositAmount').value = '';
            updateNavBalance();
            renderWallet();
            alert(`‚úÖ ${amount} USDT ba≈üarƒ±yla yatƒ±rƒ±ldƒ±!`);
        }

        function handleWithdraw() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const wallet = document.getElementById('withdrawWallet').value;
            
            if (!amount || amount <= 0 || !wallet) {
                alert('L√ºtfen t√ºm alanlarƒ± doldurun');
                return;
            }
            
            if (amount > currentUser.balance) {
                alert('Yetersiz bakiye');
                return;
            }
            
            transactions.push({
                id: Date.now(),
                type: 'withdrawal',
                amount: amount,
                wallet: wallet,
                date: new Date().toISOString(),
                userId: currentUser.id,
                status: 'pending'
            });
            
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawWallet').value = '';
            renderWallet();
            alert('√áekim talebiniz olu≈üturuldu!');
        }

        function renderWallet() {
            const container = document.getElementById('transactionList');
            const userTransactions = transactions.filter(t => t.userId === currentUser.id);
            
            if (userTransactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 60px; margin-bottom: 20px;">üí≥</div>
                        <p>Hen√ºz i≈ülem ge√ßmi≈üiniz yok</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            userTransactions.reverse().forEach(tx => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                
                let typeText = tx.type === 'buy' ? 'üõí Satƒ±n Alma' : tx.type === 'deposit' ? 'üí∞ Yatƒ±rma' : 'üí∏ √áekim Talebi';
                let amountColor = tx.type === 'deposit' ? '#11998e' : '#e74c3c';
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; margin-bottom: 5px;">${typeText}</div>
                            ${tx.city ? `<div style="color: rgba(255,255,255,0.6); font-size: 14px;">${tx.city}</div>` : ''}
                            ${tx.wallet ? `<div style="color: rgba(255,255,255,0.6); font-size: 14px;">C√ºzdan: ${tx.wallet}</div>` : ''}
                            <div style="color: rgba(255,255,255,0.5); font-size: 13px; margin-top: 5px;">
                                ${new Date(tx.date).toLocaleString('tr-TR')}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 22px; font-weight: 800; color: ${amountColor};">
                                ${tx.type === 'deposit' ? '+' : '-'}${tx.amount.toFixed(2)} USDT
                            </div>
                            ${tx.status ? `<div style="color: #ffc107; font-size: 12px; margin-top: 5px;">${tx.status}</div>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderProfile() {
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileBalance').textContent = currentUser.balance.toFixed(2) + ' USDT';
            
            const myCities = Object.values(cities).filter(c => c.owner === currentUser.id);
            document.getElementById('profileCityCount').textContent = myCities.length;
            
            const totalValue = myCities.reduce((sum, city) => sum + city.price, 0);
            document.getElementById('profileTotalValue').textContent = totalValue.toFixed(2) + ' USDT';
            
            const flagImg = document.getElementById('profileFlag');
            if (currentUser.flag) {
                flagImg.src = currentUser.flag;
                flagImg.style.display = 'block';
            } else {
                flagImg.style.display = 'none';
            }
            
            const grid = document.getElementById('myCitiesGrid');
            if (myCities.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 60px; margin-bottom: 20px;">üèôÔ∏è</div>
                        <p>Hen√ºz ≈üehriniz yok</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = '';
            myCities.forEach(city => {
                const card = document.createElement('div');
                card.className = 'city-card';
                card.onclick = () => openCityModal(city);
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <div>
                            <h3 style="font-size: 20px; margin-bottom: 5px;">${city.name}</h3>
                            <p style="color: rgba(255,255,255,0.6);">üìç ${city.country}</p>
                        </div>
                        ${city.flag ? `<img src="${city.flag}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 8px;">` : ''}
                    </div>
                    <div style="color: #11998e; font-size: 24px; font-weight: 800;">${city.price.toFixed(2)} USDT</div>
                `;
                grid.appendChild(card);
            });
        }

        function openFlagEditor() {
            document.getElementById('flagModal').classList.remove('hidden');
            initColorPalette();
            if (currentUser.flag) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = currentUser.flag;
            }
        }

        function closeFlagEditor() {
            document.getElementById('flagModal').classList.add('hidden');
        }

        function initColorPalette() {
            const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF', '#000000', '#FFA500', '#800080', '#FFC0CB', '#A52A2A', '#FFD700', '#00CED1'];
            const palette = document.getElementById('colorPalette');
            palette.innerHTML = '';
            
            colors.forEach(color => {
                const btn = document.createElement('button');
                btn.className = 'color-btn';
                btn.style.backgroundColor = color;
                if (color === currentColor) btn.classList.add('active');
                btn.onclick = () => {
                    currentColor = color;
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
                palette.appendChild(btn);
            });
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveFlag() {
            const flagData = canvas.toDataURL();
            currentUser.flag = flagData;
            users[currentUser.id].flag = flagData;
            
            Object.values(cities).forEach(city => {
                if (city.owner === currentUser.id) {
                    city.flag = flagData;
                }
            });
            
            closeFlagEditor();
            renderProfile();
            alert('üé® Bayraƒüƒ±nƒ±z kaydedildi!');
        }

        // Canvas Drawing
        if (canvas) {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopDrawing();
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentColor;
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function renderAdmin() {
            if (!currentUser.isAdmin) return;
            
            const usersContainer = document.getElementById('adminUsers');
            usersContainer.innerHTML = '';
            
            Object.values(users).forEach(user => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; margin-bottom: 5px;">${user.name}</div>
                            <div style="color: rgba(255,255,255,0.6); font-size: 14px;">${user.email}</div>
                            <div style="color: #11998e; margin-top: 5px;">Bakiye: ${user.balance.toFixed(2)} USDT</div>
                        </div>
                        <button class="btn btn-primary" onclick="adminAddBalance('${user.id}', 1000)" style="width: auto; padding: 10px 20px;">
                            +1000 USDT
                        </button>
                    </div>
                `;
                usersContainer.appendChild(item);
            });
            
            const transContainer = document.getElementById('adminTransactions');
            if (transactions.length === 0) {
                transContainer.innerHTML = `<div class="empty-state"><p>Hen√ºz i≈ülem yok</p></div>`;
                return;
            }
            
            transContainer.innerHTML = '';
            transactions.slice().reverse().forEach(tx => {
                const user = users[tx.userId];
                const item = document.createElement('div');
                item.className = 'transaction-item';
                
                let typeText = tx.type === 'buy' ? 'Satƒ±n Alma' : tx.type === 'deposit' ? 'Yatƒ±rma' : '√áekim';
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <div style="font-weight: 700; margin-bottom: 5px;">${typeText}</div>
                            <div style="color: rgba(255,255,255,0.6); font-size: 14px;">Kullanƒ±cƒ±: ${user?.name}</div>
                            ${tx.city ? `<div style="color: rgba(255,255,255,0.6); font-size: 14px;">${tx.city}</div>` : ''}
                            <div style="color: rgba(255,255,255,0.5); font-size: 13px; margin-top: 5px;">
                                ${new Date(tx.date).toLocaleString('tr-TR')}
                            </div>
                        </div>
                        <div style="font-size: 20px; font-weight: 800; color: ${tx.type === 'deposit' ? '#11998e' : '#e74c3c'};">
                            ${tx.amount.toFixed(2)} USDT
                        </div>
                    </div>
                `;
                transContainer.appendChild(item);
            });
        }

        function adminAddBalance(userId, amount) {
            users[userId].balance += amount;
            if (currentUser.id === userId) {
                currentUser.balance = users[userId].balance;
                updateNavBalance();
            }
            renderAdmin();
            alert(`‚úÖ ${users[userId].name} kullanƒ±cƒ±sƒ±na ${amount} USDT eklendi!`);
        }

        function updateNavBalance() {
            document.getElementById('navBalance').textContent = currentUser.balance.toFixed(0) + ' USDT';
        }

        // Initialize
        initDemoData();
    </script>
</body>
</html>
