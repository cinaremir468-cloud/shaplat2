<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityMarket - Şehir Alım Satım Platformu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #fff;
            min-height: 100vh;
        }

        .hidden {
            display: none !important;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .logo h1 {
            font-size: 32px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo p {
            color: #c4b5fd;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 15px;
            transition: all 0.3s;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        input:focus {
            outline: none;
            border-color: #a855f7;
            background: rgba(255, 255, 255, 0.15);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-google {
            background: white;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-google:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .divider {
            text-align: center;
            margin: 24px 0;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .divider span {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        /* Main App */
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: bold;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link:hover {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .balance-badge {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            color: #10b981;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .search-bar {
            margin-bottom: 24px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 14px 18px 14px 48px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 24px;
        }

        .city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .city-card {
            background: linear-gradient(135deg, #374151, #1f2937);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #4b5563;
            cursor: pointer;
            transition: all 0.3s;
        }

        .city-card:hover {
            border-color: #a855f7;
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.3);
        }

        .city-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .city-flag {
            width: 48px;
            height: 32px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .city-info h3 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .city-info p {
            color: #9ca3af;
            font-size: 14px;
        }

        .city-price {
            color: #10b981;
            font-size: 20px;
            font-weight: bold;
            margin-top: 12px;
        }

        .city-owner {
            color: #a855f7;
            font-size: 14px;
            margin-top: 8px;
        }

        .city-change {
            font-size: 14px;
            margin-top: 4px;
        }

        .city-change.positive { color: #10b981; }
        .city-change.negative { color: #ef4444; }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: linear-gradient(135deg, #1f2937, #111827);
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            border: 1px solid #4b5563;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .modal-detail {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-detail:last-child {
            border-bottom: none;
        }

        .modal-detail label {
            color: #9ca3af;
        }

        .modal-detail span {
            font-weight: 600;
        }

        /* Canvas */
        .canvas-container {
            margin-bottom: 20px;
        }

        #flagCanvas {
            width: 100%;
            background: white;
            border-radius: 12px;
            cursor: crosshair;
            touch-action: none;
        }

        .color-palette {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-btn.active {
            border-color: white;
            transform: scale(1.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 16px;
            padding: 20px;
        }

        .stat-card.green {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            border-color: rgba(16, 185, 129, 0.3);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            border-color: rgba(59, 130, 246, 0.3);
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            background: linear-gradient(135deg, #374151, #1f2937);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #4b5563;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .transaction-type {
            font-weight: 600;
            font-size: 16px;
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: bold;
        }

        .transaction-amount.positive { color: #10b981; }
        .transaction-amount.negative { color: #ef4444; }

        .transaction-info {
            font-size: 14px;
            color: #9ca3af;
        }

        .btn-group {
            display: flex;
            gap: 12px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }

        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .city-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 85, 247, 0.7);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
        }

        .back-btn:hover {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .page-title {
            font-size: 32px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="logo">
                <div class="logo-icon">🌍</div>
                <h1>CityMarket</h1>
                <p>Şehirleri Keşfedin, Sahip Olun, Ticaret Yapın</p>
            </div>

            <div id="loginForm">
                <div class="input-group">
                    <input type="email" id="loginEmail" placeholder="E-posta">
                </div>
                <div class="input-group">
                    <input type="password" id="loginPassword" placeholder="Şifre">
                </div>
                <button class="btn btn-primary" onclick="handleLogin('email')">Giriş Yap</button>
                <button class="btn btn-secondary" onclick="toggleRegister()">Hesap Oluştur</button>
            </div>

            <div id="registerForm" class="hidden">
                <div class="input-group">
                    <input type="text" id="registerName" placeholder="Adınız">
                </div>
                <div class="input-group">
                    <input type="email" id="registerEmail" placeholder="E-posta">
                </div>
                <div class="input-group">
                    <input type="password" id="registerPassword" placeholder="Şifre">
                </div>
                <button class="btn btn-primary" onclick="handleRegister()">Kayıt Ol</button>
                <button class="btn btn-secondary" onclick="toggleRegister()">Giriş Sayfasına Dön</button>
            </div>

            <div class="divider">
                <span>veya</span>
            </div>

            <button class="btn btn-google" onclick="handleLogin('google')">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google ile Giriş
            </button>
            <button class="btn btn-secondary" onclick="handleLogin('guest')">Misafir Olarak Devam Et</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="nav-brand">
                🌍 CityMarket
            </div>
            <div class="nav-menu">
                <a href="#" class="nav-link" onclick="showPage('home')">🏠 Ana Sayfa</a>
                <a href="#" class="nav-link" onclick="showPage('market')">📈 Borsa</a>
                <a href="#" class="nav-link" onclick="showPage('wallet')">💰 Cüzdan</a>
                <a href="#" class="nav-link" onclick="showPage('profile')">👤 Profil</a>
                <a href="#" class="nav-link" id="adminLink" onclick="showPage('admin')" style="display: none;">🛡️ Admin</a>
                <span class="balance-badge" id="navBalance">0.00 USDT</span>
                <a href="#" class="nav-link" onclick="handleLogout()">🚪</a>
            </div>
        </nav>

        <!-- Home Page -->
        <div id="homePage" class="container">
            <div class="search-bar">
                <span class="search-icon">🔍</span>
                <input type="text" id="searchInput" placeholder="Şehir veya kullanıcı ara..." oninput="filterCities()">
            </div>

            <div class="card">
                <h2 class="page-title">Şehirler</h2>
                <div class="city-grid" id="cityGrid"></div>
            </div>
        </div>

        <!-- Market Page -->
        <div id="marketPage" class="container hidden">
            <a href="#" class="back-btn" onclick="showPage('home')">← Geri</a>
            <h2 class="page-title">📈 Borsa - Şehir Alım Satım</h2>
            <div class="card">
                <div id="marketOrders"></div>
            </div>
        </div>

        <!-- Wallet Page -->
        <div id="walletPage" class="container hidden">
            <a href="#" class="back-btn" onclick="showPage('home')">← Geri</a>
            <h2 class="page-title">💰 Cüzdan</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                <div class="card">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        ➕ Para Yatır
                    </h3>
                    <div class="input-group">
                        <input type="number" id="depositAmount" placeholder="Miktar (USDT)">
                    </div>
                    <div class="alert alert-warning">
                        💡 Demo: Herhangi bir miktar yazıp yatırabilirsiniz
                    </div>
                    <button class="btn btn-success" onclick="handleDeposit()">Yatır</button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        ➖ Para Çek
                    </h3>
                    <div class="input-group">
                        <input type="number" id="withdrawAmount" placeholder="Miktar (USDT)">
                    </div>
                    <div class="input-group">
                        <input type="text" id="withdrawWallet" placeholder="Cüzdan Adresi">
                    </div>
                    <button class="btn btn-danger" onclick="handleWithdraw()">Çekim Talebi Oluştur</button>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px;">📜 İşlem Geçmişi</h3>
                <div class="transaction-list" id="transactionList"></div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="container hidden">
            <a href="#" class="back-btn" onclick="showPage('home')">← Geri</a>
            <h2 class="page-title">👤 Profil</h2>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                    <div>
                        <h3 style="font-size: 28px; margin-bottom: 8px;" id="profileName"></h3>
                        <p style="color: #9ca3af;" id="profileEmail"></p>
                    </div>
                    <img id="profileFlag" src="" alt="flag" style="width: 96px; height: 64px; object-fit: cover; border-radius: 8px; border: 2px solid #a855f7; display: none;">
                </div>

                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-label">Bakiye</div>
                        <div class="stat-value" id="profileBalance">0.00 USDT</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sahip Olunan Şehir</div>
                        <div class="stat-value" id="profileCityCount">0</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-label">Toplam Değer</div>
                        <div class="stat-value" id="profileTotalValue">0.00 USDT</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="openFlagEditor()">🏴 Bayrak Oluştur / Düzenle</button>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px;">Şehirlerim</h3>
                <div class="city-grid" id="myCitiesGrid"></div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="container hidden">
            <a href="#" class="back-btn" onclick="showPage('home')">← Geri</a>
            <h2 class="page-title">🛡️ Admin Paneli</h2>
            
            <div class="card">
                <h3 style="margin-bottom: 20px;">Kullanıcılar</h3>
                <div id="adminUsers"></div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px;">Tüm İşlemler</h3>
                <div class="transaction-list" id="adminTransactions"></div>
            </div>
        </div>
    </div>

    <!-- City Detail Modal -->
    <div id="cityModal" class="modal hidden" onclick="closeCityModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalCityName"></h2>
                <button class="close-btn" onclick="closeCityModal()">×</button>
            </div>
            <img id="modalCityFlag" src="" alt="flag" style="width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 20px; display: none;">
            <div id="modalCityDetails"></div>
            <div id="modalCityActions"></div>
        </div>
    </div>

    <!-- Flag Editor Modal -->
    <div id="flagModal" class="modal hidden" onclick="closeFlagEditor()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>🏴 Bayrak Tasarla</h2>
                <button class="close-btn" onclick="closeFlagEditor()">×</button>
            </div>
            <div class="canvas-container">
                <canvas id="flagCanvas" width="600" height="400"></canvas>
            </div>
            <div class="color-palette" id="colorPalette"></div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="clearCanvas()">Temizle</button>
                <button class="btn btn-primary" onclick="saveFlag()">Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let cities = {};
        let users = {};
        let transactions = [];
        let marketOrders = [];
        let selectedCity = null;
        let isDrawing = false;
        let currentColor = '#FF0000';
        const canvas = document.getElementById('flagCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;

        // Initialize Demo Data
        function initDemoData() {
            cities = {
                'TR-06': { id: 'TR-06', name: 'Ankara', country: 'Türkiye', price: 1000, owner: null, flag: null, initialPrice: 1000, priceHistory: [] },
                'TR-34': { id: 'TR-34', name: 'İstanbul', country: 'Türkiye', price: 5000, owner: null, flag: null, initialPrice: 5000, priceHistory: [] },
                'TR-35': { id: 'TR-35', name: 'İzmir', country: 'Türkiye', price: 3000, owner: null, flag: null, initialPrice: 3000, priceHistory: [] },
                'US-NY': { id: 'US-NY', name: 'New York', country: 'USA', price: 10000, owner: null, flag: null, initialPrice: 10000, priceHistory: [] },
                'GB-LDN': { id: 'GB-LDN', name: 'London', country: 'UK', price: 8000, owner: null, flag: null, initialPrice: 8000, priceHistory: [] },
                'FR-PAR': { id: 'FR-PAR', name: 'Paris', country: 'France', price: 7500, owner: null, flag: null, initialPrice: 7500, priceHistory: [] },
                'DE-BER': { id: 'DE-BER', name: 'Berlin', country: 'Germany', price: 6500, owner: null, flag: null, initialPrice: 6500, priceHistory: [] },
                'IT-ROM': { id: 'IT-ROM', name: 'Roma', country: 'Italy', price: 7000, owner: null, flag: null, initialPrice: 7000, priceHistory: [] },
                'ES-MAD': { id: 'ES-MAD', name: 'Madrid', country: 'Spain', price: 6000, owner: null, flag: null, initialPrice: 6000, priceHistory: [] },
                'JP-TOK': { id: 'JP-TOK', name: 'Tokyo', country: 'Japan', price: 12000, owner: null, flag: null, initialPrice: 12000, priceHistory: [] },
            };

            users = {
                'demo1': { id: 'demo1', name: 'Demo Admin', email: 'admin@citymarket.com', balance: 100000, cities: [], flag: null, isAdmin: true }
            };
        }

        // Login/Register Functions
        function toggleRegister() {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
        }

        function handleLogin(type) {
            if (type === 'google') {
                createUser('Google User', 'google@user.com', 10000, false);
            } else if (type === 'guest') {
                createUser('Misafir Kullanıcı', 'guest@user.com', 5000, false);
            } else if (type === 'email') {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    alert('Lütfen tüm alanları doldurun');
                    return;
                }
                
                const user = Object.values(users).find(u => u.email === email);
                if (user) {
                    currentUser = user;
                    showMainApp();
                } else {
                    alert('Kullanıcı bulunamadı');
                }
            }
        }

        function handleRegister() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                alert('Lütfen tüm alanları doldurun');
                return;
            }
            
            createUser(name, email, 10000, false);
        }

        function createUser(name, email, balance, isAdmin) {
            const userId = 'user_' + Date.now();
            const newUser = {
                id: userId,
                name: name,
                email: email,
                balance: balance,
                cities: [],
                flag: null,
                isAdmin: isAdmin
            };
            users[userId] = newUser;
            currentUser = newUser;
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateNavBalance();
            if (currentUser.isAdmin) {
                document.getElementById('adminLink').style.display = 'flex';
            }
            renderCities();
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            showPage('home');
        }

        // Page Navigation
        function showPage(pageName) {
            const pages = ['homePage', 'marketPage', 'walletPage', 'profilePage', 'adminPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            document.getElementById(pageName + 'Page').classList.remove('hidden');
            
            if (pageName === 'market') renderMarket();
            if (pageName === 'wallet') renderWallet();
            if (pageName === 'profile') renderProfile();
            if (pageName === 'admin') renderAdmin();
            if (pageName === 'home') renderCities();
        }

        // City Functions
        function renderCities() {
            const grid = document.getElementById('cityGrid');
            grid.innerHTML = '';
            
            Object.values(cities).forEach(city => {
                const card = createCityCard(city);
                grid.appendChild(card);
            });
        }

        function createCityCard(city) {
            const card = document.createElement('div');
            card.className = 'city-card';
            card.onclick = () => openCityModal(city);
            
            const change = ((city.price - city.initialPrice) / city.initialPrice * 100).toFixed(2);
            const changeClass = change >= 0 ? 'positive' : 'negative';
            
            card.innerHTML = `
                <div class="city-header">
                    <div class="city-info">
                        <h3>${city.name}</h3>
                        <p>${city.country}</p>
                    </div>
                    ${city.flag ? `<img src="${city.flag}" alt="flag" class="city-flag">` : ''}
                </div>
                <div class="city-price">${city.price.toFixed(2)} USDT</div>
                ${city.owner ? `<div class="city-owner">👤 ${users[city.owner]?.name || 'Kullanıcı'}</div>` : ''}
                <div class="city-change ${changeClass}">${change >= 0 ? '+' : ''}${change}%</div>
            `;
            
            return card;
        }

        function openCityModal(city) {
            selectedCity = city;
            const modal = document.getElementById('cityModal');
            document.getElementById('modalCityName').textContent = city.name;
            
            const flagImg = document.getElementById('modalCityFlag');
            if (city.flag) {
                flagImg.src = city.flag;
                flagImg.style.display = 'block';
            } else {
                flagImg.style.display = 'none';
            }
            
            const details = document.getElementById('modalCityDetails');
            details.innerHTML = `
                <div class="modal-detail">
                    <label>Ülke</label>
                    <span>${city.country}</span>
                </div>
                <div class="modal-detail">
                    <label>Fiyat</label>
                    <span style="color: #10b981; font-size: 20px;">${city.price.toFixed(2)} USDT</span>
                </div>
                ${city.owner ? `
                    <div class="modal-detail">
                        <label>Sahibi</label>
                        <span style="color: #a855f7;">${users[city.owner]?.name}</span>
                    </div>
                ` : ''}
                <div class="modal-detail">
                    <label>İlk Fiyat</label>
                    <span>${city.initialPrice.toFixed(2)} USDT</span>
                </div>
                <div class="modal-detail">
                    <label>Değişim</label>
                    <span style="color: ${city.price >= city.initialPrice ? '#10b981' : '#ef4444'}">
                        ${((city.price - city.initialPrice) / city.initialPrice * 100).toFixed(2)}%
                    </span>
                </div>
            `;
            
            const actions = document.getElementById('modalCityActions');
            if (city.owner === currentUser?.id) {
                actions.innerHTML = `
                    <div style="margin-top: 20px;">
                        <input type="number" id="sellPrice" placeholder="Satış Fiyatı (USDT)" style="width: 100%; margin-bottom: 12px;">
                        <button class="btn btn-warning" onclick="listCityForSale()">Satışa Çıkar</button>
                    </div>
                `;
            } else if (city.owner) {
                actions.innerHTML = `
                    <div class="alert alert-info" style="margin-top: 20px;">
                        Bu şehir zaten bir sahibi var. Borsadan satın alabilirsiniz.
                    </div>
                `;
            } else {
                actions.innerHTML = `
                    <button class="btn btn-primary" onclick="buyCity()" style="margin-top: 20px;">
                        ${currentUser.balance >= city.price ? 'Satın Al' : 'Yetersiz Bakiye'}
                    </button>
                `;
            }
            
            modal.classList.remove('hidden');
        }

        function closeCityModal() {
            document.getElementById('cityModal').classList.add('hidden');
            selectedCity = null;
        }

        function buyCity() {
            if (!selectedCity || currentUser.balance < selectedCity.price) return;
            
            currentUser.balance -= selectedCity.price;
            users[currentUser.id].balance = currentUser.balance;
            
            cities[selectedCity.id].owner = currentUser.id;
            cities[selectedCity.id].flag = currentUser.flag;
            cities[selectedCity.id].priceHistory.push({
                price: selectedCity.price,
                date: new Date().toISOString(),
                buyer: currentUser.id
            });
            
            users[currentUser.id].cities.push(selectedCity.id);
            
            transactions.push({
                id: Date.now(),
                type: 'buy',
                city: selectedCity.name,
                amount: selectedCity.price,
                date: new Date().toISOString(),
                userId: currentUser.id
            });
            
            updateNavBalance();
            closeCityModal();
            renderCities();
            alert(`${selectedCity.name} şehrini başarıyla satın aldınız!`);
        }

        function listCityForSale() {
            const price = parseFloat(document.getElementById('sellPrice').value);
            if (!price || price <= 0) {
                alert('Lütfen geçerli bir fiyat girin');
                return;
            }
            
            marketOrders.push({
                id: Date.now(),
                cityId: selectedCity.id,
                sellerId: currentUser.id,
                price: price,
                date: new Date().toISOString()
            });
            
            closeCityModal();
            alert('Şehir borsaya çıkarıldı!');
        }

        // Market Functions
        function renderMarket() {
            const container = document.getElementById('marketOrders');
            
            if (marketOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18l-2 13H5L3 3z"/>
                        </svg>
                        <p>Henüz satışta şehir bulunmuyor</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            marketOrders.forEach(order => {
                const city = cities[order.cityId];
                const seller = users[order.sellerId];
                
                const orderCard = document.createElement('div');
                orderCard.className = 'transaction-item';
                orderCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <h3 style="font-size: 20px; margin-bottom: 4px;">${city.name}</h3>
                            <p style="color: #9ca3af; font-size: 14px;">${city.country}</p>
                            <p style="color: #a855f7; font-size: 14px; margin-top: 4px;">Satıcı: ${seller?.name}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #10b981; font-size: 24px; font-weight: bold; margin-bottom: 12px;">
                                ${order.price.toFixed(2)} USDT
                            </div>
                            ${order.sellerId !== currentUser?.id ? `
                                <button class="btn btn-primary btn-small" onclick="buyFromMarket(${order.id})" 
                                    ${currentUser.balance < order.price ? 'disabled' : ''}>
                                    Satın Al
                                </button>
                            ` : '<span style="color: #9ca3af;">Sizin ilanınız</span>'}
                        </div>
                    </div>
                `;
                container.appendChild(orderCard);
            });
        }

        function buyFromMarket(orderId) {
            const order = marketOrders.find(o => o.id === orderId);
            if (!order || currentUser.balance < order.price) return;
            
            const city = cities[order.cityId];
            
            // Transfer balance
            currentUser.balance -= order.price;
            users[currentUser.id].balance = currentUser.balance;
            users[order.sellerId].balance += order.price;
            
            // Transfer city
            users[order.sellerId].cities = users[order.sellerId].cities.filter(c => c !== order.cityId);
            users[currentUser.id].cities.push(order.cityId);
            
            cities[order.cityId].owner = currentUser.id;
            cities[order.cityId].flag = currentUser.flag;
            cities[order.cityId].price = order.price * 1.1; // %10 increase
            cities[order.cityId].priceHistory.push({
                price: order.price,
                date: new Date().toISOString(),
                buyer: currentUser.id,
                seller: order.sellerId
            });
            
            // Record transaction
            transactions.push({
                id: Date.now(),
                type: 'buy',
                city: city.name,
                amount: order.price,
                date: new Date().toISOString(),
                userId: currentUser.id,
                from: order.sellerId
            });
            
            // Remove order
            marketOrders = marketOrders.filter(o => o.id !== orderId);
            
            updateNavBalance();
            renderMarket();
            alert(`${city.name} şehrini başarıyla satın aldınız!`);
        }

        // Wallet Functions
        function handleDeposit() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            if (!amount || amount <= 0) {
                alert('Lütfen geçerli bir miktar girin');
                return;
            }
            
            currentUser.balance += amount;
            users[currentUser.id].balance = currentUser.balance;
            
            transactions.push({
                id: Date.now(),
                type: 'deposit',
                amount: amount,
                date: new Date().toISOString(),
                userId: currentUser.id
            });
            
            document.getElementById('depositAmount').value = '';
            updateNavBalance();
            renderWallet();
            alert(`${amount} USDT başarıyla yatırıldı!`);
        }

        function handleWithdraw() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const wallet = document.getElementById('withdrawWallet').value;
            
            if (!amount || amount <= 0 || !wallet) {
                alert('Lütfen tüm alanları doldurun');
                return;
            }
            
            if (amount > currentUser.balance) {
                alert('Yetersiz bakiye');
                return;
            }
            
            transactions.push({
                id: Date.now(),
                type: 'withdrawal',
                amount: amount,
                wallet: wallet,
                date: new Date().toISOString(),
                userId: currentUser.id,
                status: 'pending'
            });
            
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawWallet').value = '';
            renderWallet();
            alert('Çekim talebiniz oluşturuldu!');
        }

        function renderWallet() {
            const container = document.getElementById('transactionList');
            const userTransactions = transactions.filter(t => t.userId === currentUser.id);
            
            if (userTransactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p>Henüz işlem geçmişiniz yok</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            userTransactions.reverse().forEach(tx => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                
                let typeText = '';
                let amountClass = '';
                if (tx.type === 'buy') {
                    typeText = 'Satın Alma';
                    amountClass = 'negative';
                } else if (tx.type === 'deposit') {
                    typeText = 'Yatırma';
                    amountClass = 'positive';
                } else {
                    typeText = 'Çekim Talebi';
                    amountClass = 'negative';
                }
                
                item.innerHTML = `
                    <div class="transaction-header">
                        <div>
                            <div class="transaction-type">${typeText}</div>
                            ${tx.city ? `<div class="transaction-info">${tx.city}</div>` : ''}
                            ${tx.wallet ? `<div class="transaction-info">Cüzdan: ${tx.wallet}</div>` : ''}
                            <div class="transaction-info">${new Date(tx.date).toLocaleString('tr-TR')}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="transaction-amount ${amountClass}">
                                ${tx.type === 'deposit' ? '+' : '-'}${tx.amount.toFixed(2)} USDT
                            </div>
                            ${tx.status ? `<div style="color: #fbbf24; font-size: 12px;">${tx.status}</div>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // Profile Functions
        function renderProfile() {
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileBalance').textContent = currentUser.balance.toFixed(2) + ' USDT';
            
            const myCities = Object.values(cities).filter(c => c.owner === currentUser.id);
            document.getElementById('profileCityCount').textContent = myCities.length;
            
            const totalValue = myCities.reduce((sum, city) => sum + city.price, 0);
            document.getElementById('profileTotalValue').textContent = totalValue.toFixed(2) + ' USDT';
            
            const flagImg = document.getElementById('profileFlag');
            if (currentUser.flag) {
                flagImg.src = currentUser.flag;
                flagImg.style.display = 'block';
            } else {
                flagImg.style.display = 'none';
            }
            
            const grid = document.getElementById('myCitiesGrid');
            if (myCities.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        <p>Henüz şehriniz yok</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = '';
            myCities.forEach(city => {
                const card = createCityCard(city);
                grid.appendChild(card);
            });
        }

        // Flag Editor Functions
        function openFlagEditor() {
            document.getElementById('flagModal').classList.remove('hidden');
            initColorPalette();
            if (currentUser.flag) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = currentUser.flag;
            }
        }

        function closeFlagEditor() {
            document.getElementById('flagModal').classList.add('hidden');
        }

        function initColorPalette() {
            const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF', '#000000', '#FFA500', '#800080', '#FFC0CB', '#A52A2A'];
            const palette = document.getElementById('colorPalette');
            palette.innerHTML = '';
            
            colors.forEach(color => {
                const btn = document.createElement('button');
                btn.className = 'color-btn';
                btn.style.backgroundColor = color;
                if (color === currentColor) btn.classList.add('active');
                btn.onclick = () => {
                    currentColor = color;
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
                palette.appendChild(btn);
            });
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveFlag() {
            const flagData = canvas.toDataURL();
            currentUser.flag = flagData;
            users[currentUser.id].flag = flagData;
            
            // Update all cities owned by user
            Object.values(cities).forEach(city => {
                if (city.owner === currentUser.id) {
                    city.flag = flagData;
                }
            });
            
            closeFlagEditor();
            renderProfile();
            renderCities();
            alert('Bayrağınız kaydedildi!');
        }

        // Canvas drawing
        if (canvas) {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentColor;
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        // Admin Functions
        function renderAdmin() {
            if (!currentUser.isAdmin) return;
            
            const usersContainer = document.getElementById('adminUsers');
            usersContainer.innerHTML = '';
            
            Object.values(users).forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'transaction-item';
                userCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 4px;">${user.name}</div>
                            <div style="color: #9ca3af; font-size: 14px;">${user.email}</div>
                            <div style="color: #10b981; font-size: 14px; margin-top: 4px;">Bakiye: ${user.balance.toFixed(2)} USDT</div>
                        </div>
                        <button class="btn btn-success btn-small" onclick="adminAddBalance('${user.id}', 1000)">
                            +1000 USDT
                        </button>
                    </div>
                `;
                usersContainer.appendChild(userCard);
            });
            
            const transContainer = document.getElementById('adminTransactions');
            if (transactions.length === 0) {
                transContainer.innerHTML = `
                    <div class="empty-state">
                        <p>Henüz işlem yok</p>
                    </div>
                `;
                return;
            }
            
            transContainer.innerHTML = '';
            transactions.slice().reverse().forEach(tx => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                
                const user = users[tx.userId];
                let typeText = '';
                if (tx.type === 'buy') typeText = 'Satın Alma';
                else if (tx.type === 'deposit') typeText = 'Yatırma';
                else typeText = 'Çekim Talebi';
                
                item.innerHTML = `
                    <div class="transaction-header">
                        <div>
                            <div class="transaction-type">${typeText}</div>
                            <div class="transaction-info">Kullanıcı: ${user?.name}</div>
                            ${tx.city ? `<div class="transaction-info">${tx.city}</div>` : ''}
                            ${tx.wallet ? `<div class="transaction-info">Cüzdan: ${tx.wallet}</div>` : ''}
                            <div class="transaction-info">${new Date(tx.date).toLocaleString('tr-TR')}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="transaction-amount ${tx.type === 'deposit' ? 'positive' : 'negative'}">
                                ${tx.amount.toFixed(2)} USDT
                            </div>
                            ${tx.status ? `<div style="color: #fbbf24; font-size: 12px;">${tx.status}</div>` : ''}
                        </div>
                    </div>
                `;
                transContainer.appendChild(item);
            });
        }

        function adminAddBalance(userId, amount) {
            users[userId].balance += amount;
            if (currentUser.id === userId) {
                currentUser.balance = users[userId].balance;
                updateNavBalance();
            }
            renderAdmin();
            alert(`${users[userId].name} kullanıcısına ${amount} USDT eklendi!`);
        }

        // Utility Functions
        function updateNavBalance() {
            document.getElementById('navBalance').textContent = currentUser.balance.toFixed(2) + ' USDT';
        }

        function filterCities() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const grid = document.getElementById('cityGrid');
            grid.innerHTML = '';
            
            Object.values(cities)
                .filter(city => 
                    city.name.toLowerCase().includes(query) || 
                    city.country.toLowerCase().includes(query) ||
                    (city.owner && users[city.owner]?.name.toLowerCase().includes(query))
                )
                .forEach(city => {
                    const card = createCityCard(city);
                    grid.appendChild(card);
                });
        }

        // Initialize
        initDemoData();
    </script>
</body>
</html>
