import React, { useState, useEffect, useRef } from 'react';
import { Search, User, MapPin, TrendingUp, Wallet, LogOut, Settings, Shield, Home, Menu, X, Plus, Minus, ChevronRight, Flag, PaintBucket, Download, Upload } from 'lucide-react';

// Firebase yapılandırması (Kullanıcının kendi Firebase config'ini buraya eklemesi gerekiyor)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const CityMarketplace = () => {
  const [currentUser, setCurrentUser] = useState(null);
  const [page, setPage] = useState('login');
  const [cities, setCities] = useState({});
  const [selectedCity, setSelectedCity] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [balance, setBalance] = useState(0);
  const [transactions, setTransactions] = useState([]);
  const [users, setUsers] = useState({});
  const [marketOrders, setMarketOrders] = useState([]);
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  const [flagEditor, setFlagEditor] = useState({ show: false, colors: ['#FF0000', '#FFFFFF', '#0000FF'] });
  const [loginForm, setLoginForm] = useState({ email: '', password: '', isRegister: false });
  const [withdrawalRequest, setWithdrawalRequest] = useState({ amount: '', wallet: '' });
  const [depositAmount, setDepositAmount] = useState('');
  const canvasRef = useRef(null);
  const [drawing, setDrawing] = useState(false);
  const [currentColor, setCurrentColor] = useState('#FF0000');

  // Başlangıç verileri
  useEffect(() => {
    // Demo şehirler
    const demoCities = {
      'TR-06': { id: 'TR-06', name: 'Ankara', country: 'Türkiye', price: 1000, owner: null, flag: null, initialPrice: 1000, priceHistory: [] },
      'TR-34': { id: 'TR-34', name: 'İstanbul', country: 'Türkiye', price: 5000, owner: null, flag: null, initialPrice: 5000, priceHistory: [] },
      'US-NY': { id: 'US-NY', name: 'New York', country: 'USA', price: 10000, owner: null, flag: null, initialPrice: 10000, priceHistory: [] },
      'GB-LDN': { id: 'GB-LDN', name: 'London', country: 'UK', price: 8000, owner: null, flag: null, initialPrice: 8000, priceHistory: [] },
      'FR-PAR': { id: 'FR-PAR', name: 'Paris', country: 'France', price: 7500, owner: null, flag: null, initialPrice: 7500, priceHistory: [] },
    };
    setCities(demoCities);

    // Demo kullanıcılar
    const demoUsers = {
      'demo1': { id: 'demo1', name: 'Demo User', email: 'demo@test.com', balance: 50000, cities: [], flag: null, isAdmin: true },
    };
    setUsers(demoUsers);
  }, []);

  // Canvas çizim işlemleri
  const startDrawing = (e) => {
    setDrawing(true);
    draw(e);
  };

  const stopDrawing = () => {
    setDrawing(false);
    const canvas = canvasRef.current;
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.beginPath();
    }
  };

  const draw = (e) => {
    if (!drawing) return;
    const canvas = canvasRef.current;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    ctx.strokeStyle = currentColor;
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  };

  const saveFlag = () => {
    const canvas = canvasRef.current;
    const flagData = canvas.toDataURL();
    if (currentUser) {
      setUsers(prev => ({
        ...prev,
        [currentUser.id]: { ...prev[currentUser.id], flag: flagData }
      }));
      setFlagEditor({ ...flagEditor, show: false });
    }
  };

  const clearCanvas = () => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  };

  // Giriş işlemleri
  const handleLogin = (type) => {
    if (type === 'google') {
      const newUser = {
        id: 'user_' + Date.now(),
        name: 'Google User',
        email: 'google@user.com',
        balance: 10000,
        cities: [],
        flag: null,
        isAdmin: false
      };
      setUsers(prev => ({ ...prev, [newUser.id]: newUser }));
      setCurrentUser(newUser);
      setBalance(newUser.balance);
      setPage('home');
    } else if (type === 'guest') {
      const newUser = {
        id: 'guest_' + Date.now(),
        name: 'Misafir Kullanıcı',
        email: 'guest@user.com',
        balance: 5000,
        cities: [],
        flag: null,
        isAdmin: false
      };
      setUsers(prev => ({ ...prev, [newUser.id]: newUser }));
      setCurrentUser(newUser);
      setBalance(newUser.balance);
      setPage('home');
    } else if (type === 'email') {
      if (loginForm.isRegister) {
        const newUser = {
          id: 'user_' + Date.now(),
          name: loginForm.email.split('@')[0],
          email: loginForm.email,
          balance: 10000,
          cities: [],
          flag: null,
          isAdmin: false
        };
        setUsers(prev => ({ ...prev, [newUser.id]: newUser }));
        setCurrentUser(newUser);
        setBalance(newUser.balance);
        setPage('home');
      } else {
        const user = Object.values(users).find(u => u.email === loginForm.email);
        if (user) {
          setCurrentUser(user);
          setBalance(user.balance);
          setPage('home');
        }
      }
    }
  };

  // Şehir satın alma
  const buyCity = (cityId) => {
    const city = cities[cityId];
    if (currentUser && balance >= city.price) {
      const newBalance = balance - city.price;
      setBalance(newBalance);
      
      const updatedCity = {
        ...city,
        owner: currentUser.id,
        flag: currentUser.flag,
        priceHistory: [...city.priceHistory, { price: city.price, date: new Date().toISOString(), buyer: currentUser.id }]
      };
      
      setCities(prev => ({ ...prev, [cityId]: updatedCity }));
      
      setUsers(prev => ({
        ...prev,
        [currentUser.id]: {
          ...prev[currentUser.id],
          balance: newBalance,
          cities: [...prev[currentUser.id].cities, cityId]
        }
      }));

      setTransactions(prev => [...prev, {
        id: Date.now(),
        type: 'buy',
        city: city.name,
        amount: city.price,
        date: new Date().toISOString()
      }]);

      setSelectedCity(null);
    }
  };

  // Şehir satışa çıkarma
  const listCityForSale = (cityId, price) => {
    const city = cities[cityId];
    if (city.owner === currentUser.id) {
      setMarketOrders(prev => [...prev, {
        id: Date.now(),
        cityId,
        sellerId: currentUser.id,
        price: parseFloat(price),
        date: new Date().toISOString()
      }]);
    }
  };

  // Borsadan şehir satın alma
  const buyFromMarket = (orderId) => {
    const order = marketOrders.find(o => o.id === orderId);
    if (order && balance >= order.price) {
      const city = cities[order.cityId];
      const seller = users[order.sellerId];
      
      // Alıcı bakiyesini düş
      const newBalance = balance - order.price;
      setBalance(newBalance);
      
      // Satıcı bakiyesini artır
      setUsers(prev => ({
        ...prev,
        [order.sellerId]: {
          ...prev[order.sellerId],
          balance: prev[order.sellerId].balance + order.price,
          cities: prev[order.sellerId].cities.filter(c => c !== order.cityId)
        },
        [currentUser.id]: {
          ...prev[currentUser.id],
          balance: newBalance,
          cities: [...prev[currentUser.id].cities, order.cityId]
        }
      }));
      
      // Şehir sahipliğini değiştir
      setCities(prev => ({
        ...prev,
        [order.cityId]: {
          ...prev[order.cityId],
          owner: currentUser.id,
          flag: currentUser.flag,
          price: order.price * 1.1, // %10 fiyat artışı
          priceHistory: [...prev[order.cityId].priceHistory, {
            price: order.price,
            date: new Date().toISOString(),
            buyer: currentUser.id,
            seller: order.sellerId
          }]
        }
      }));
      
      // Emri kaldır
      setMarketOrders(prev => prev.filter(o => o.id !== orderId));
      
      // İşlemi kaydet
      setTransactions(prev => [...prev, {
        id: Date.now(),
        type: 'buy',
        city: city.name,
        amount: order.price,
        date: new Date().toISOString(),
        from: order.sellerId
      }]);
    }
  };

  // Para yatırma
  const deposit = () => {
    const amount = parseFloat(depositAmount);
    if (amount > 0 && currentUser) {
      const newBalance = balance + amount;
      setBalance(newBalance);
      setUsers(prev => ({
        ...prev,
        [currentUser.id]: { ...prev[currentUser.id], balance: newBalance }
      }));
      setTransactions(prev => [...prev, {
        id: Date.now(),
        type: 'deposit',
        amount,
        date: new Date().toISOString()
      }]);
      setDepositAmount('');
    }
  };

  // Para çekme
  const requestWithdrawal = () => {
    const amount = parseFloat(withdrawalRequest.amount);
    if (amount > 0 && amount <= balance && withdrawalRequest.wallet) {
      setTransactions(prev => [...prev, {
        id: Date.now(),
        type: 'withdrawal_request',
        amount,
        wallet: withdrawalRequest.wallet,
        date: new Date().toISOString(),
        status: 'pending'
      }]);
      setWithdrawalRequest({ amount: '', wallet: '' });
    }
  };

  // Admin: Bakiye ekleme
  const adminAddBalance = (userId, amount) => {
    setUsers(prev => ({
      ...prev,
      [userId]: { ...prev[userId], balance: prev[userId].balance + amount }
    }));
  };

  // Render - Login Sayfası
  const renderLogin = () => (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
      <div className="bg-white/10 backdrop-blur-lg rounded-3xl shadow-2xl p-8 w-full max-w-md border border-white/20">
        <div className="text-center mb-8">
          <div className="flex justify-center mb-4">
            <MapPin className="w-16 h-16 text-purple-400" />
          </div>
          <h1 className="text-3xl font-bold text-white mb-2">CityMarket</h1>
          <p className="text-purple-200">Şehirleri Keşfedin, Sahip Olun, Ticaret Yapın</p>
        </div>

        {!loginForm.isRegister ? (
          <div className="space-y-4">
            <input
              type="email"
              placeholder="E-posta"
              value={loginForm.email}
              onChange={(e) => setLoginForm({ ...loginForm, email: e.target.value })}
              className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:border-purple-400"
            />
            <input
              type="password"
              placeholder="Şifre"
              value={loginForm.password}
              onChange={(e) => setLoginForm({ ...loginForm, password: e.target.value })}
              className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:border-purple-400"
            />
            <button
              onClick={() => handleLogin('email')}
              className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition"
            >
              Giriş Yap
            </button>
            <button
              onClick={() => setLoginForm({ ...loginForm, isRegister: true })}
              className="w-full text-purple-300 hover:text-purple-100 transition"
            >
              Hesap Oluştur
            </button>
          </div>
        ) : (
          <div className="space-y-4">
            <input
              type="email"
              placeholder="E-posta"
              value={loginForm.email}
              onChange={(e) => setLoginForm({ ...loginForm, email: e.target.value })}
              className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:border-purple-400"
            />
            <input
              type="password"
              placeholder="Şifre"
              value={loginForm.password}
              onChange={(e) => setLoginForm({ ...loginForm, password: e.target.value })}
              className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:border-purple-400"
            />
            <button
              onClick={() => handleLogin('email')}
              className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition"
            >
              Kayıt Ol
            </button>
            <button
              onClick={() => setLoginForm({ ...loginForm, isRegister: false })}
              className="w-full text-purple-300 hover:text-purple-100 transition"
            >
              Giriş Sayfasına Dön
            </button>
          </div>
        )}

        <div className="my-6 flex items-center">
          <div className="flex-1 border-t border-white/20"></div>
          <span className="px-4 text-white/50 text-sm">veya</span>
          <div className="flex-1 border-t border-white/20"></div>
        </div>

        <div className="space-y-3">
          <button
            onClick={() => handleLogin('google')}
            className="w-full bg-white text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-100 transition flex items-center justify-center gap-2"
          >
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Google ile Giriş
          </button>
          <button
            onClick={() => handleLogin('guest')}
            className="w-full bg-white/10 border border-white/20 text-white py-3 rounded-xl font-semibold hover:bg-white/20 transition"
          >
            Misafir Olarak Devam Et
          </button>
        </div>
      </div>
    </div>
  );

  // Render - Ana Sayfa
  const renderHome = () => (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800">
      {/* Navbar */}
      <nav className="bg-white/10 backdrop-blur-lg border-b border-white/10">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center gap-3">
              <MapPin className="w-8 h-8 text-purple-400" />
              <span className="text-white font-bold text-xl">CityMarket</span>
            </div>
            
            <div className="hidden md:flex items-center gap-6">
              <button onClick={() => setPage('home')} className="text-white hover:text-purple-400 transition flex items-center gap-2">
                <Home className="w-5 h-5" />
                Ana Sayfa
              </button>
              <button onClick={() => setPage('market')} className="text-white hover:text-purple-400 transition flex items-center gap-2">
                <TrendingUp className="w-5 h-5" />
                Borsa
              </button>
              <button onClick={() => setPage('wallet')} className="text-white hover:text-purple-400 transition flex items-center gap-2">
                <Wallet className="w-5 h-5" />
                Cüzdan
              </button>
              <button onClick={() => setPage('profile')} className="text-white hover:text-purple-400 transition flex items-center gap-2">
                <User className="w-5 h-5" />
                Profil
              </button>
              {currentUser?.isAdmin && (
                <button onClick={() => setPage('admin')} className="text-white hover:text-purple-400 transition flex items-center gap-2">
                  <Shield className="w-5 h-5" />
                  Admin
                </button>
              )}
            </div>

            <div className="flex items-center gap-4">
              <div className="bg-green-500/20 px-4 py-2 rounded-lg border border-green-500/30">
                <span className="text-green-400 font-semibold">{balance.toFixed(2)} USDT</span>
              </div>
              <button onClick={() => { setCurrentUser(null); setPage('login'); }} className="text-white hover:text-red-400 transition">
                <LogOut className="w-5 h-5" />
              </button>
              <button onClick={() => setShowMobileMenu(!showMobileMenu)} className="md:hidden text-white">
                {showMobileMenu ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* Mobile Menu */}
      {showMobileMenu && (
        <div className="md:hidden bg-white/10 backdrop-blur-lg border-b border-white/10">
          <div className="px-4 py-3 space-y-2">
            <button onClick={() => { setPage('home'); setShowMobileMenu(false); }} className="w-full text-left text-white hover:text-purple-400 transition py-2">Ana Sayfa</button>
            <button onClick={() => { setPage('market'); setShowMobileMenu(false); }} className="w-full text-left text-white hover:text-purple-400 transition py-2">Borsa</button>
            <button onClick={() => { setPage('wallet'); setShowMobileMenu(false); }} className="w-full text-left text-white hover:text-purple-400 transition py-2">Cüzdan</button>
            <button onClick={() => { setPage('profile'); setShowMobileMenu(false); }} className="w-full text-left text-white hover:text-purple-400 transition py-2">Profil</button>
            {currentUser?.isAdmin && (
              <button onClick={() => { setPage('admin'); setShowMobileMenu(false); }} className="w-full text-left text-white hover:text-purple-400 transition py-2">Admin Panel</button>
            )}
          </div>
        </div>
      )}

      {/* Arama */}
      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="relative">
          <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
          <input
            type="text"
            placeholder="Şehir veya kullanıcı ara..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full pl-12 pr-4 py-3 bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:border-purple-400"
          />
        </div>
      </div>

      {/* Harita ve Şehirler */}
      <div className="max-w-7xl mx-auto px-4 pb-8">
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
          <h2 className="text-2xl font-bold text-white mb-4">Şehirler</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {Object.values(cities)
              .filter(city => city.name.toLowerCase().includes(searchQuery.toLowerCase()))
              .map(city => (
                <div
                  key={city.id}
                  onClick={() => setSelectedCity(city)}
                  className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-4 border border-gray-700 hover:border-purple-400 transition cursor-pointer"
                >
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <h3 className="text-white font-bold text-lg">{city.name}</h3>
                      <p className="text-gray-400 text-sm">{city.country}</p>
                    </div>
                    {city.flag && (
                      <img src={city.flag} alt="flag" className="w-12 h-8 object-cover rounded" />
                    )}
                  </div>
                  <div className="space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="text-gray-400 text-sm">Fiyat</span>
                      <span className="text-green-400 font-bold">{city.price.toFixed(2)} USDT</span>
                    </div>
                    {city.owner && (
                      <div className="flex justify-between items-center">
                        <span className="text-gray-400 text-sm">Sahibi</span>
                        <button
                          onClick={(e) => { e.stopPropagation(); setPage('profile'); }}
                          className="text-purple-400 hover:text-purple-300 text-sm"
                        >
                          {users[city.owner]?.name || 'Kullanıcı'}
                        </button>
                      </div>
                    )}
                    {city.initialPrice && (
                      <div className="flex justify-between items-center">
                        <span className="text-gray-400 text-sm">Değişim</span>
                        <span className={city.price > city.initialPrice ? 'text-green-400' : 'text-red-400'}>
                          {((city.price - city.initialPrice) / city.initialPrice * 100).toFixed(2)}%
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              ))}
          </div>
        </div>
      </div>

      {/* Şehir Detay Pop-up */}
      {selectedCity && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50" onClick={() => setSelectedCity(null)}>
          <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 max-w-md w-full border border-gray-700" onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-start mb-4">
              <div>
                <h3 className="text-2xl font-bold text-white">{selectedCity.name}</h3>
                <p className="text-gray-400">{selectedCity.country}</p>
              </div>
              <button onClick={() => setSelectedCity(null)} className="text-gray-400 hover:text-white">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            {selectedCity.flag && (
              <img src={selectedCity.flag} alt="flag" className="w-full h-32 object-cover rounded-lg mb-4" />
            )}
            
            <div className="space-y-3 mb-6">
              <div className="flex justify-between items-center">
                <span className="text-gray-400">Fiyat</span>
                <span className="text-green-400 font-bold text-xl">{selectedCity.price.toFixed(2)} USDT</span>
              </div>
              {selectedCity.owner && (
                <div className="flex justify-between items-center">
                  <span className="text-gray-400">Sahibi</span>
                  <span className="text-purple-400">{users[selectedCity.owner]?.name}</span>
                </div>
              )}
              <div className="flex justify-between items-center">
                <span className="text-gray-400">İlk Fiyat</span>
                <span className="text-gray-300">{selectedCity.initialPrice.toFixed(2)} USDT</span>
              </div>
            </div>

            {selectedCity.owner === currentUser?.id ? (
              <div className="space-y-3">
                <input
                  type="number"
                  placeholder="Satış Fiyatı (USDT)"
                  className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:border-purple-400"
                  id={`sell-price-${selectedCity.id}`}
                />
                <button
                  onClick={() => {
                    const price = document.getElementById(`sell-price-${selectedCity.id}`).value;
                    if (price) {
                      listCityForSale(selectedCity.id, price);
                      setSelectedCity(null);
                    }
                  }}
                  className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 rounded-xl font-semibold hover:from-orange-600 hover:to-red-600 transition"
                >
                  Satışa Çıkar
                </button>
              </div>
            ) : selectedCity.owner ? (
              <div className="text-center text-gray-400">
                Bu şehir zaten bir sahibi var. Borsadan satın alabilirsiniz.
              </div>
            ) : (
              <button
                onClick={() => buyCity(selectedCity.id)}
                disabled={balance < selectedCity.price}
                className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {balance < selectedCity.price ? 'Yetersiz Bakiye' : 'Satın Al'}
              </button>
            )}
          </div>
        </div>
      )}
    </div>
  );

  // Render - Borsa
  const renderMarket = () => (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4">
      <div className="max-w-7xl mx-auto">
        <button onClick={() => setPage('home')} className="text-white mb-4 flex items-center gap-2 hover:text-purple-400">
          <ChevronRight className="w-5 h-5 rotate-180" />
          Geri
        </button>
        
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
          <h2 className="text-3xl font-bold text-white mb-6">Borsa - Şehir Alım Satım</h2>
          
          <div className="space-y-4">
            {marketOrders.length === 0 ? (
              <div className="text-center text-gray-400 py-12">
                Henüz satışta şehir bulunmuyor
              </div>
            ) : (
              marketOrders.map(order => {
                const city = cities[order.cityId];
                const seller = users[order.sellerId];
                return (
                  <div key={order.id} className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-4 border border-gray-700">
                    <div className="flex justify-between items-center">
                      <div className="flex-1">
                        <h3 className="text-white font-bold text-lg">{city.name}</h3>
                        <p className="text-gray-400 text-sm">{city.country}</p>
                        <p className="text-purple-400 text-sm mt-1">Satıcı: {seller?.name}</p>
                      </div>
                      <div className="text-right">
                        <div className="text-green-400 font-bold text-xl mb-2">{order.price.toFixed(2)} USDT</div>
                        {order.sellerId !== currentUser?.id && (
                          <button
                            onClick={() => buyFromMarket(order.id)}
                            disabled={balance < order.price}
                            className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition disabled:opacity-50"
                          >
                            Satın Al
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      </div>
    </div>
  );

  // Render - Cüzdan
  const renderWallet = () => (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4">
      <div className="max-w-4xl mx-auto">
        <button onClick={() => setPage('home')} className="text-white mb-4 flex items-center gap-2 hover:text-purple-400">
          <ChevronRight className="w-5 h-5 rotate-180" />
          Geri
        </button>

        <div className="grid md:grid-cols-2 gap-6 mb-6">
          {/* Para Yatırma */}
          <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <Plus className="w-6 h-6 text-green-400" />
              Para Yatır
            </h3>
            <div className="space-y-4">
              <input
                type="number"
                placeholder="Miktar (USDT)"
                value={depositAmount}
                onChange={(e) => setDepositAmount(e.target.value)}
                className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:border-purple-400"
              />
              <div className="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-3">
                <p className="text-yellow-300 text-sm">Demo: Herhangi bir miktar yazıp yatırabilirsiniz</p>
              </div>
              <button
                onClick={deposit}
                className="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 rounded-xl font-semibold hover:from-green-600 hover:to-emerald-600 transition"
              >
                Yatır
              </button>
            </div>
          </div>

          {/* Para Çekme */}
          <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <Minus className="w-6 h-6 text-red-400" />
              Para Çek
            </h3>
            <div className="space-y-4">
              <input
                type="number"
                placeholder="Miktar (USDT)"
                value={withdrawalRequest.amount}
                onChange={(e) => setWithdrawalRequest({ ...withdrawalRequest, amount: e.target.value })}
                className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:border-purple-400"
              />
              <input
                type="text"
                placeholder="Cüzdan Adresi"
                value={withdrawalRequest.wallet}
                onChange={(e) => setWithdrawalRequest({ ...withdrawalRequest, wallet: e.target.value })}
                className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:outline-none focus:border-purple-400"
              />
              <button
                onClick={requestWithdrawal}
                disabled={!withdrawalRequest.amount || !withdrawalRequest.wallet || parseFloat(withdrawalRequest.amount) > balance}
                className="w-full bg-gradient-to-r from-red-500 to-pink-500 text-white py-3 rounded-xl font-semibold hover:from-red-600 hover:to-pink-600 transition disabled:opacity-50"
              >
                Çekim Talebi Oluştur
              </button>
            </div>
          </div>
        </div>

        {/* İşlem Geçmişi */}
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
          <h3 className="text-xl font-bold text-white mb-4">İşlem Geçmişi</h3>
          <div className="space-y-3">
            {transactions.length === 0 ? (
              <div className="text-center text-gray-400 py-8">Henüz işlem geçmişiniz yok</div>
            ) : (
              transactions.map(tx => (
                <div key={tx.id} className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-4 border border-gray-700">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="text-white font-semibold">
                        {tx.type === 'buy' ? 'Satın Alma' : tx.type === 'deposit' ? 'Yatırma' : 'Çekim Talebi'}
                      </p>
                      {tx.city && <p className="text-gray-400 text-sm">{tx.city}</p>}
                      <p className="text-gray-500 text-xs">{new Date(tx.date).toLocaleString('tr-TR')}</p>
                    </div>
                    <div className="text-right">
                      <p className={`font-bold text-lg ${tx.type === 'buy' ? 'text-red-400' : 'text-green-400'}`}>
                        {tx.type === 'buy' ? '-' : '+'}{tx.amount.toFixed(2)} USDT
                      </p>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );

  // Render - Profil
  const renderProfile = () => {
    const myCities = Object.values(cities).filter(c => c.owner === currentUser?.id);
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4">
        <div className="max-w-4xl mx-auto">
          <button onClick={() => setPage('home')} className="text-white mb-4 flex items-center gap-2 hover:text-purple-400">
            <ChevronRight className="w-5 h-5 rotate-180" />
            Geri
          </button>

          <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 mb-6">
            <div className="flex justify-between items-start mb-6">
              <div>
                <h2 className="text-3xl font-bold text-white mb-2">{currentUser?.name}</h2>
                <p className="text-gray-400">{currentUser?.email}</p>
              </div>
              {currentUser?.flag && (
                <img src={currentUser.flag} alt="flag" className="w-24 h-16 object-cover rounded-lg border-2 border-purple-400" />
              )}
            </div>

            <div className="grid md:grid-cols-3 gap-4 mb-6">
              <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 rounded-xl p-4 border border-green-500/30">
                <p className="text-green-400 text-sm mb-1">Bakiye</p>
                <p className="text-white text-2xl font-bold">{balance.toFixed(2)} USDT</p>
              </div>
              <div className="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl p-4 border border-purple-500/30">
                <p className="text-purple-400 text-sm mb-1">Sahip Olunan Şehir</p>
                <p className="text-white text-2xl font-bold">{myCities.length}</p>
              </div>
              <div className="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-xl p-4 border border-blue-500/30">
                <p className="text-blue-400 text-sm mb-1">Toplam Değer</p>
                <p className="text-white text-2xl font-bold">
                  {myCities.reduce((sum, city) => sum + city.price, 0).toFixed(2)} USDT
                </p>
              </div>
            </div>

            <button
              onClick={() => setFlagEditor({ ...flagEditor, show: true })}
              className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition flex items-center justify-center gap-2"
            >
              <Flag className="w-5 h-5" />
              Bayrak Oluştur / Düzenle
            </button>
          </div>

          {/* Şehirlerim */}
          <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
            <h3 className="text-xl font-bold text-white mb-4">Şehirlerim</h3>
            {myCities.length === 0 ? (
              <div className="text-center text-gray-400 py-8">Henüz şehriniz yok</div>
            ) : (
              <div className="grid md:grid-cols-2 gap-4">
                {myCities.map(city => (
                  <div key={city.id} className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-4 border border-gray-700">
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <h4 className="text-white font-bold">{city.name}</h4>
                        <p className="text-gray-400 text-sm">{city.country}</p>
                      </div>
                      {city.flag && (
                        <img src={city.flag} alt="flag" className="w-12 h-8 object-cover rounded" />
                      )}
                    </div>
                    <div className="text-green-400 font-bold mb-2">{city.price.toFixed(2)} USDT</div>
                    <button
                      onClick={() => setSelectedCity(city)}
                      className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-2 rounded-lg font-semibold hover:from-orange-600 hover:to-red-600 transition text-sm"
                    >
                      Satışa Çıkar
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Bayrak Editörü */}
        {flagEditor.show && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50" onClick={() => setFlagEditor({ ...flagEditor, show: false })}>
            <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 max-w-2xl w-full border border-gray-700" onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-2xl font-bold text-white">Bayrak Tasarla</h3>
                <button onClick={() => setFlagEditor({ ...flagEditor, show: false })} className="text-gray-400 hover:text-white">
                  <X className="w-6 h-6" />
                </button>
              </div>

              <canvas
                ref={canvasRef}
                width={600}
                height={400}
                onMouseDown={startDrawing}
                onMouseUp={stopDrawing}
                onMouseMove={draw}
                onMouseLeave={stopDrawing}
                className="w-full bg-white rounded-lg mb-4 cursor-crosshair"
              />

              <div className="flex gap-2 mb-4">
                {['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF', '#000000'].map(color => (
                  <button
                    key={color}
                    onClick={() => setCurrentColor(color)}
                    className={`w-10 h-10 rounded-lg border-2 ${currentColor === color ? 'border-white' : 'border-gray-600'}`}
                    style={{ backgroundColor: color }}
                  />
                ))}
              </div>

              <div className="flex gap-3">
                <button
                  onClick={clearCanvas}
                  className="flex-1 bg-gray-700 text-white py-3 rounded-xl font-semibold hover:bg-gray-600 transition"
                >
                  Temizle
                </button>
                <button
                  onClick={saveFlag}
                  className="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition"
                >
                  Kaydet
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Render - Admin Panel
  const renderAdmin = () => (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4">
      <div className="max-w-6xl mx-auto">
        <button onClick={() => setPage('home')} className="text-white mb-4 flex items-center gap-2 hover:text-purple-400">
          <ChevronRight className="w-5 h-5 rotate-180" />
          Geri
        </button>

        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
          <h2 className="text-3xl font-bold text-white mb-6 flex items-center gap-3">
            <Shield className="w-8 h-8 text-purple-400" />
            Admin Paneli
          </h2>

          {/* Kullanıcılar */}
          <div className="mb-8">
            <h3 className="text-xl font-bold text-white mb-4">Kullanıcılar</h3>
            <div className="space-y-3">
              {Object.values(users).map(user => (
                <div key={user.id} className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-4 border border-gray-700">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="text-white font-bold">{user.name}</p>
                      <p className="text-gray-400 text-sm">{user.email}</p>
                      <p className="text-green-400 text-sm">Bakiye: {user.balance.toFixed(2)} USDT</p>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => adminAddBalance(user.id, 1000)}
                        className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition text-sm"
                      >
                        +1000 USDT
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* İşlemler */}
          <div>
            <h3 className="text-xl font-bold text-white mb-4">Tüm İşlemler</h3>
            <div className="space-y-3">
              {transactions.map(tx => (
                <div key={tx.id} className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-4 border border-gray-700">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="text-white font-semibold">
                        {tx.type === 'buy' ? 'Satın Alma' : tx.type === 'deposit' ? 'Yatırma' : 'Çekim Talebi'}
                      </p>
                      {tx.city && <p className="text-gray-400 text-sm">{tx.city}</p>}
                      {tx.wallet && <p className="text-gray-400 text-sm">Cüzdan: {tx.wallet}</p>}
                      <p className="text-gray-500 text-xs">{new Date(tx.date).toLocaleString('tr-TR')}</p>
                    </div>
                    <div className="text-right">
                      <p className={`font-bold ${tx.type === 'buy' ? 'text-red-400' : 'text-green-400'}`}>
                        {tx.amount.toFixed(2)} USDT
                      </p>
                      {tx.status && (
                        <span className="text-yellow-400 text-sm">{tx.status}</span>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );

  // Ana Render
  if (!currentUser) return renderLogin();

  return (
    <>
      {page === 'home' && renderHome()}
      {page === 'market' && renderMarket()}
      {page === 'wallet' && renderWallet()}
      {page === 'profile' && renderProfile()}
      {page === 'admin' && currentUser.isAdmin && renderAdmin()}
      
      {selectedCity && page === 'home' && null}
    </>
  );
};

export default CityMarketplace;
