<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kripto ≈ûehir Ticaret Platformu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --darker: #111827;
            --light: #f3f4f6;
            --border: #e5e7eb;
            --text: #374151;
            --text-light: #9ca3af;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: var(--light);
        }

        .user-balance {
            background: var(--secondary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--dark);
        }

        /* Map Container */
        #chartdiv {
            width: 100%;
            height: 600px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin: 20px 0;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-light);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: var(--light);
            color: var(--danger);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Auth Buttons */
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .google-btn {
            background: white;
            color: var(--text);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .google-btn:hover {
            border-color: var(--primary);
            background: var(--light);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 3000;
            animation: slideInRight 0.3s;
            max-width: 400px;
        }

        .toast.active {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid var(--secondary);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        /* Flag Designer */
        .flag-designer {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        #flagCanvas {
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: crosshair;
            display: block;
            margin: 0 auto 16px;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .color-box {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .color-box:hover {
            transform: scale(1.1);
        }

        .color-box.active {
            border-color: var(--dark);
            box-shadow: 0 0 0 2px white;
        }

        .tool-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Marketplace */
        .marketplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .city-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .city-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .city-flag {
            width: 100%;
            height: 120px;
            border-radius: 8px;
            margin-bottom: 12px;
            object-fit: cover;
            background: var(--light);
        }

        .city-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .city-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .city-owner {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 12px;
        }

        /* Profile */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 32px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            font-weight: 700;
        }

        .profile-info h2 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Admin Panel */
        .admin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border);
        }

        .admin-tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }

        tr:hover {
            background: var(--light);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Search Bar */
        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid var(--border);
            border-radius: 24px;
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
            }

            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }

            #chartdiv {
                height: 400px;
            }

            .marketplace-grid {
                grid-template-columns: 1fr;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .modal-content {
                padding: 20px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-select {
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* Transaction History */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-type {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 4px;
        }

        .transaction-type.buy {
            background: #dbeafe;
            color: #1e40af;
        }

        .transaction-type.sell {
            background: #dcfce7;
            color: #166534;
        }

        .transaction-type.deposit {
            background: #fef3c7;
            color: #92400e;
        }

        .transaction-type.withdraw {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="spinner"></div>
            <p style="text-align: center; margin-top: 16px; color: var(--text);">Y√ºkleniyor...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                üåç Kripto ≈ûehir Borsasƒ±
            </div>
            <nav class="nav-menu" id="navMenu">
                <!-- Auth buttons will be injected here -->
            </nav>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Map Section -->
        <div id="mapSection">
            <div class="card">
                <h1 style="text-align: center; margin-bottom: 8px; color: var(--dark);">ƒ∞nteraktif D√ºnya ≈ûehir Haritasƒ±</h1>
                <p style="text-align: center; color: var(--text-light); margin-bottom: 24px;">≈ûehirlere tƒ±klayarak satƒ±n alabilir, kendi bayraƒüƒ±nƒ±zƒ± tasarlayabilirsiniz</p>
                <div id="chartdiv"></div>
            </div>
        </div>

        <!-- Marketplace Section -->
        <div id="marketplaceSection" class="hidden">
            <div class="card">
                <div class="card-title">üìä ≈ûehir Pazarƒ±</div>
                <div class="search-bar">
                    <input type="text" class="search-input" id="marketplaceSearch" placeholder="≈ûehir veya √ºlke ara...">
                    <span class="search-icon">üîç</span>
                </div>
                <div class="filters">
                    <select class="filter-select" id="filterCountry">
                        <option value="">T√ºm √úlkeler</option>
                    </select>
                    <select class="filter-select" id="filterStatus">
                        <option value="">T√ºm Durumlar</option>
                        <option value="available">Satƒ±lƒ±k</option>
                        <option value="owned">Sahipli</option>
                    </select>
                    <select class="filter-select" id="filterSort">
                        <option value="price-asc">Fiyat (D√º≈ü√ºkten Y√ºkseƒüe)</option>
                        <option value="price-desc">Fiyat (Y√ºksekten D√º≈ü√ºƒüe)</option>
                        <option value="name">ƒ∞sme G√∂re</option>
                    </select>
                </div>
                <div class="marketplace-grid" id="marketplaceGrid">
                    <!-- City cards will be injected here -->
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="hidden">
            <div class="card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">U</div>
                    <div class="profile-info">
                        <h2 id="profileName">Kullanƒ±cƒ±</h2>
                        <p style="color: var(--text-light);" id="profileEmail">user@example.com</p>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="statBalance">0</div>
                        <div class="stat-label">Bakiye (USDT)</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <div class="stat-value" id="statCities">0</div>
                        <div class="stat-label">Sahip Olunan ≈ûehir</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <div class="stat-value" id="statTransactions">0</div>
                        <div class="stat-label">Toplam ƒ∞≈ülem</div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <button class="btn btn-primary" onclick="showFlagDesigner()">üé® Bayrak Tasarla</button>
                    <button class="btn btn-secondary" onclick="showWalletModal()">üí∞ C√ºzdan</button>
                </div>

                <div class="card-title">üèôÔ∏è Sahip Olduƒüum ≈ûehirler</div>
                <div class="marketplace-grid" id="ownedCitiesGrid">
                    <!-- Owned cities will be shown here -->
                </div>

                <div class="card-title" style="margin-top: 32px;">üìú ƒ∞≈ülem Ge√ßmi≈üi</div>
                <div id="transactionHistory">
                    <!-- Transactions will be shown here -->
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="hidden">
            <div class="card">
                <div class="card-title">üõ°Ô∏è Admin Paneli</div>
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchAdminTab('users')">Kullanƒ±cƒ±lar</button>
                    <button class="admin-tab" onclick="switchAdminTab('withdrawals')">√áekim Talepleri</button>
                    <button class="admin-tab" onclick="switchAdminTab('transactions')">ƒ∞≈ülemler</button>
                    <button class="admin-tab" onclick="switchAdminTab('stats')">ƒ∞statistikler</button>
                </div>

                <div class="admin-content active" id="adminUsers">
                    <table>
                        <thead>
                            <tr>
                                <th>Kullanƒ±cƒ±</th>
                                <th>Email</th>
                                <th>Bakiye</th>
                                <th>≈ûehirler</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersTable"></tbody>
                    </table>
                </div>

                <div class="admin-content" id="adminWithdrawals">
                    <table>
                        <thead>
                            <tr>
                                <th>Kullanƒ±cƒ±</th>
                                <th>Miktar</th>
                                <th>C√ºzdan</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="adminWithdrawalsTable"></tbody>
                    </table>
                </div>

                <div class="admin-content" id="adminTransactions">
                    <table>
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Tip</th>
                                <th>Kullanƒ±cƒ±</th>
                                <th>Miktar</th>
                                <th>Detay</th>
                            </tr>
                        </thead>
                        <tbody id="adminTransactionsTable"></tbody>
                    </table>
                </div>

                <div class="admin-content" id="adminStats">
                    <div class="profile-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalUsers">0</div>
                            <div class="stat-label">Toplam Kullanƒ±cƒ±</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <div class="stat-value" id="statTotalVolume">0</div>
                            <div class="stat-label">ƒ∞≈ülem Hacmi (USDT)</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <div class="stat-value" id="statActiveCities">0</div>
                            <div class="stat-label">Satƒ±lan ≈ûehirler</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîê Giri≈ü Yap</h2>
                <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <div class="auth-buttons">
                <button class="google-btn" onclick="signInWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Google ile Giri≈ü
                </button>
                <button class="btn btn-outline" onclick="showEmailAuth()">üìß Email ile Giri≈ü</button>
                <button class="btn btn-primary" onclick="signInAsGuest()">üë§ Misafir Giri≈üi</button>
            </div>
        </div>
    </div>

    <!-- Email Auth Modal -->
    <div class="modal" id="emailAuthModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìß Email ile Giri≈ü</h2>
                <button class="close-btn" onclick="closeModal('emailAuthModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="authEmail" placeholder="ornek@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">≈ûifre</label>
                <input type="password" class="form-input" id="authPassword" placeholder="******">
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="signInWithEmail()">Giri≈ü Yap</button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="signUpWithEmail()">Kayƒ±t Ol</button>
            </div>
        </div>
    </div>

    <!-- City Detail Modal -->
    <div class="modal" id="cityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="cityModalTitle">≈ûehir Detayƒ±</h2>
                <button class="close-btn" onclick="closeModal('cityModal')">&times;</button>
            </div>
            <div id="cityModalContent">
                <!-- City details will be injected here -->
            </div>
        </div>
    </div>

    <!-- Flag Designer Modal -->
    <div class="modal" id="flagDesignerModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">üé® Bayrak Tasarƒ±mcƒ±sƒ±</h2>
                <button class="close-btn" onclick="closeModal('flagDesignerModal')">&times;</button>
            </div>
            <div class="flag-designer">
                <canvas id="flagCanvas" width="400" height="240"></canvas>
                <div class="color-palette" id="colorPalette">
                    <!-- Color boxes will be injected -->
                </div>
                <div class="tool-buttons">
                    <button class="btn btn-outline" onclick="clearCanvas()">üóëÔ∏è Temizle</button>
                    <button class="btn btn-outline" onclick="fillCanvas()">üé® Doldur</button>
                    <input type="range" min="1" max="50" value="5" id="brushSize" style="flex: 1;">
                    <label>Fƒ±r√ßa: <span id="brushSizeLabel">5</span>px</label>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="saveFlagDesign()">üíæ Bayraƒüƒ± Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div class="modal" id="walletModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∞ C√ºzdan</h2>
                <button class="close-btn" onclick="closeModal('walletModal')">&times;</button>
            </div>
            <div class="profile-stats">
                <div class="stat-card">
                    <div class="stat-value" id="walletBalance">0</div>
                    <div class="stat-label">Bakiye (USDT)</div>
                </div>
            </div>
            <div style="display: flex; gap: 12px; margin: 24px 0;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="showDepositSection()">üì• Yatƒ±r</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="showWithdrawSection()">üì§ √áek</button>
            </div>
            <div id="depositSection" class="hidden">
                <div class="card-title">Yatƒ±rma Adresi (USDT TRC20)</div>
                <div class="form-group">
                    <input type="text" class="form-input" id="depositAddress" readonly value="TXjq...√∂rnek...adres">
                    <button class="btn btn-outline" style="margin-top: 8px;" onclick="copyDepositAddress()">üìã Kopyala</button>
                </div>
                <p style="color: var(--text-light); font-size: 14px;">Not: Bu √∂rnek bir adrestir. Ger√ßek uygulamada benzersiz c√ºzdan adresi olu≈üturulur.</p>
            </div>
            <div id="withdrawSection" class="hidden">
                <div class="card-title">√áekim Talebi</div>
                <div class="form-group">
                    <label class="form-label">Miktar (USDT)</label>
                    <input type="number" class="form-input" id="withdrawAmount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">C√ºzdan Adresi (TRC20)</label>
                    <input type="text" class="form-input" id="withdrawAddress" placeholder="TX...">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="requestWithdrawal()">√áekim Talebi Olu≈ütur</button>
            </div>
        </div>
    </div>

    <!-- Firebase & amCharts Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>

    <script>
        // Firebase Configuration (DEMO - Replace with your config)
        const firebaseConfig = {
            apiKey: "AIzaSyDemoKeyForTestingPurposesOnly",
            authDomain: "demo-project.firebaseapp.com",
            projectId: "demo-project",
            storageBucket: "demo-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (error) {
            console.warn("Firebase ba≈ülatƒ±lamadƒ± (demo mode):", error);
        }

        // Global State (Memory-based since localStorage is not available)
        let currentUser = null;
        let currentSection = 'map';
        let cities = [];
        let users = [];
        let transactions = [];
        let withdrawRequests = [];

        // Initialize Demo Data
        function initDemoData() {
            // Demo cities
            const demoCountries = ['Turkey', 'Germany', 'France', 'Italy', 'Spain', 'USA', 'Japan', 'Brazil', 'Australia', 'Canada'];
            const demoCities = [
                'Istanbul', 'Berlin', 'Paris', 'Rome', 'Madrid', 'New York', 'Tokyo', 'Rio', 'Sydney', 'Toronto',
                'Ankara', 'Munich', 'Lyon', 'Milan', 'Barcelona', 'LA', 'Osaka', 'Brasilia', 'Melbourne', 'Vancouver',
                'Izmir', 'Hamburg', 'Marseille', 'Naples', 'Valencia', 'Chicago', 'Kyoto', 'Salvador', 'Perth', 'Montreal'
            ];

            cities = demoCities.map((city, index) => ({
                id: `city_${index}`,
                name: city,
                country: demoCountries[Math.floor(index / 3)],
                currentPrice: 50 + (Math.random() * 200),
                initialPrice: 50,
                owner: index % 5 === 0 ? 'demo_user_1' : null,
                forSale: index % 5 !== 0,
                flag: null,
                priceHistory: []
            }));

            // Demo admin user
            if (!currentUser) {
                currentUser = {
                    uid: 'demo_admin',
                    email: 'admin@demo.com',
                    displayName: 'Demo Admin',
                    balance: 10000,
                    ownedCities: [],
                    isAdmin: true,
                    flagDesign: null
                };
            }
        }

        // UI Functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = `toast ${type} active`;
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function switchSection(section) {
            const sections = ['mapSection', 'marketplaceSection', 'profileSection', 'adminSection'];
            sections.forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(section + 'Section').classList.remove('hidden');
            currentSection = section;

            if (section === 'marketplace') {
                renderMarketplace();
            } else if (section === 'profile') {
                renderProfile();
            } else if (section === 'admin') {
                renderAdmin();
            }
        }

        function switchAdminTab(tab) {
            const tabs = document.querySelectorAll('.admin-tab');
            const contents = document.querySelectorAll('.admin-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('admin' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }

        // Auth Functions
        async function signInWithGoogle() {
            try {
                showLoading();
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                await handleAuthSuccess(result.user);
            } catch (error) {
                console.error("Google giri≈ü hatasƒ±:", error);
                // Demo mode fallback
                await handleAuthSuccess({
                    uid: 'demo_user_' + Date.now(),
                    email: 'demo@example.com',
                    displayName: 'Demo User'
                });
            }
        }

        function showEmailAuth() {
            closeModal('loginModal');
            showModal('emailAuthModal');
        }

        async function signInWithEmail() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                showToast('L√ºtfen t√ºm alanlarƒ± doldurun', 'error');
                return;
            }

            try {
                showLoading();
                const result = await auth.signInWithEmailAndPassword(email, password);
                await handleAuthSuccess(result.user);
            } catch (error) {
                console.error("Email giri≈ü hatasƒ±:", error);
                // Demo mode
                await handleAuthSuccess({
                    uid: 'demo_user_email',
                    email: email,
                    displayName: email.split('@')[0]
                });
            }
        }

        async function signUpWithEmail() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                showToast('L√ºtfen t√ºm alanlarƒ± doldurun', 'error');
                return;
            }

            try {
                showLoading();
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await handleAuthSuccess(result.user);
            } catch (error) {
                console.error("Email kayƒ±t hatasƒ±:", error);
                await handleAuthSuccess({
                    uid: 'demo_user_new',
                    email: email,
                    displayName: email.split('@')[0]
                });
            }
        }

        async function signInAsGuest() {
            try {
                showLoading();
                const result = await auth.signInAnonymously();
                await handleAuthSuccess(result.user);
            } catch (error) {
                console.error("Misafir giri≈ü hatasƒ±:", error);
                await handleAuthSuccess({
                    uid: 'guest_' + Date.now(),
                    email: 'guest@demo.com',
                    displayName: 'Misafir',
                    isAnonymous: true
                });
            }
        }

        async function handleAuthSuccess(user) {
            // Initialize or get user data
            currentUser = {
                uid: user.uid,
                email: user.email || 'guest@demo.com',
                displayName: user.displayName || 'Kullanƒ±cƒ±',
                balance: 5000, // Demo ba≈ülangƒ±√ß bakiyesi
                ownedCities: [],
                isAdmin: user.uid === 'demo_admin',
                flagDesign: null,
                isAnonymous: user.isAnonymous || false
            };

            // In real app, fetch from Firestore
            // const userDoc = await db.collection('users').doc(user.uid).get();
            
            closeModal('loginModal');
            closeModal('emailAuthModal');
            hideLoading();
            renderNavMenu();
            showToast('Ba≈üarƒ±yla giri≈ü yaptƒ±nƒ±z!');
        }

        async function signOut() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("√áƒ±kƒ±≈ü hatasƒ±:", error);
            }
            currentUser = null;
            renderNavMenu();
            switchSection('map');
            showToast('Ba≈üarƒ±yla √ßƒ±kƒ±≈ü yaptƒ±nƒ±z');
        }

        function renderNavMenu() {
            const navMenu = document.getElementById('navMenu');
            
            if (!currentUser) {
                navMenu.innerHTML = `
                    <button class="nav-btn" onclick="switchSection('map')">üó∫Ô∏è Harita</button>
                    <button class="nav-btn" onclick="switchSection('marketplace')">üìä Borsa</button>
                    <button class="btn btn-primary" onclick="showModal('loginModal')">Giri≈ü Yap</button>
                `;
            } else {
                navMenu.innerHTML = `
                    <button class="nav-btn" onclick="switchSection('map')">üó∫Ô∏è Harita</button>
                    <button class="nav-btn" onclick="switchSection('marketplace')">üìä Borsa</button>
                    <button class="nav-btn" onclick="switchSection('profile')">üë§ Profil</button>
                    ${currentUser.isAdmin ? '<button class="nav-btn" onclick="switchSection(\'admin\')">üõ°Ô∏è Admin</button>' : ''}
                    <span class="user-balance">üí∞ ${currentUser.balance.toFixed(2)} USDT</span>
                    <button class="btn btn-danger" onclick="signOut()">√áƒ±kƒ±≈ü</button>
                `;
            }
        }

        // Map Functions
        let chart, worldSeries, countrySeries;

        function initMap() {
            const root = am5.Root.new("chartdiv");
            root.setThemes([am5themes_Animated.new(root)]);

            chart = root.container.children.push(am5map.MapChart.new(root, {
                panX: "rotateX",
                projection: am5map.geoMercator()
            }));

            worldSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
                geoJSON: am5geodata_worldLow,
                exclude: ["AQ"]
            }));

            worldSeries.mapPolygons.template.setAll({
                tooltipText: "{name}",
                interactive: true,
                fill: am5.color(0xcccccc)
            });

            const colors = am5.ColorSet.new(root, {});
            worldSeries.mapPolygons.template.states.create("hover", {
                fill: colors.getIndex(9)
            });

            worldSeries.mapPolygons.template.events.on("click", (ev) => {
                const data = ev.target.dataItem.dataContext;
                showCityInfo(data.name || 'Unknown');
            });
        }

        function showCityInfo(cityName) {
            const city = cities.find(c => c.name === cityName || c.country === cityName);
            
            if (!city) {
                showToast('Bu ≈üehir hen√ºz satƒ±≈üa sunulmadƒ±', 'error');
                return;
            }

            const modalContent = document.getElementById('cityModalContent');
            const owner = city.owner ? users.find(u => u.uid === city.owner) || currentUser : null;

            modalContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <div class="city-flag" style="width: 100%; height: 200px; background: ${city.flag || 'linear-gradient(135deg, #667eea, #764ba2)'};"></div>
                </div>
                <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${city.name}</div>
                <div style="color: var(--text-light); margin-bottom: 24px;">üìç ${city.country}</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-label">G√ºncel Fiyat</div>
                        <div class="stat-value">${city.currentPrice.toFixed(2)}</div>
                        <div style="font-size: 14px;">USDT</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <div class="stat-label">Durum</div>
                        <div style="font-size: 20px; margin-top: 8px;">${city.owner ? 'üë§ Sahipli' : 'üè∑Ô∏è Satƒ±lƒ±k'}</div>
                    </div>
                </div>
                ${city.owner ? `
                    <div style="background: var(--light); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <strong>Sahibi:</strong> ${owner ? owner.displayName : 'Bilinmiyor'}
                    </div>
                ` : ''}
                ${!currentUser ? `
                    <button class="btn btn-primary" style="width: 100%;" onclick="showModal('loginModal')">
                        Satƒ±n Almak ƒ∞√ßin Giri≈ü Yapƒ±n
                    </button>
                ` : city.owner === currentUser.uid ? `
                    <button class="btn btn-secondary" style="width: 100%;" onclick="listCityForSale('${city.id}')">
                        Satƒ±≈üa √áƒ±kar
                    </button>
                ` : city.forSale ? `
                    <button class="btn btn-primary" style="width: 100%;" onclick="buyCity('${city.id}')">
                        üí∞ ${city.currentPrice.toFixed(2)} USDT - Satƒ±n Al
                    </button>
                ` : `
                    <div style="text-align: center; color: var(--text-light); padding: 20px;">
                        Bu ≈üehir ≈üu anda satƒ±lƒ±k deƒüil
                    </div>
                `}
            `;

            document.getElementById('cityModalTitle').textContent = city.name;
            showModal('cityModal');
        }

        async function buyCity(cityId) {
            if (!currentUser) {
                showModal('loginModal');
                return;
            }

            const city = cities.find(c => c.id === cityId);
            if (!city) return;

            if (currentUser.balance < city.currentPrice) {
                showToast('Yetersiz bakiye!', 'error');
                return;
            }

            showLoading();

            // Simulate transaction
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Update city
            const previousOwner = city.owner;
            city.owner = currentUser.uid;
            city.forSale = false;
            city.priceHistory.push({
                price: city.currentPrice,
                date: new Date(),
                buyer: currentUser.uid,
                seller: previousOwner
            });

            // Update balances
            currentUser.balance -= city.currentPrice;
            currentUser.ownedCities.push(cityId);

            // Apply user's flag
            if (currentUser.flagDesign) {
                city.flag = currentUser.flagDesign;
            }

            // Create transaction
            transactions.push({
                id: 'tx_' + Date.now(),
                type: 'buy',
                userId: currentUser.uid,
                cityId: cityId,
                amount: city.currentPrice,
                timestamp: new Date()
            });

            // Increase price for next sale
            city.currentPrice *= 1.05;

            hideLoading();
            closeModal('cityModal');
            renderNavMenu();
            showToast(`${city.name} ba≈üarƒ±yla satƒ±n alƒ±ndƒ±!`);
        }

        // Marketplace Functions
        function renderMarketplace() {
            const grid = document.getElementById('marketplaceGrid');
            const searchTerm = document.getElementById('marketplaceSearch').value.toLowerCase();
            const filterCountry = document.getElementById('filterCountry').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const filterSort = document.getElementById('filterSort').value;

            let filteredCities = cities.filter(city => {
                const matchesSearch = city.name.toLowerCase().includes(searchTerm) || 
                                     city.country.toLowerCase().includes(searchTerm);
                const matchesCountry = !filterCountry || city.country === filterCountry;
                const matchesStatus = !filterStatus || 
                                     (filterStatus === 'available' && !city.owner) ||
                                     (filterStatus === 'owned' && city.owner);
                return matchesSearch && matchesCountry && matchesStatus;
            });

            // Sort
            filteredCities.sort((a, b) => {
                if (filterSort === 'price-asc') return a.currentPrice - b.currentPrice;
                if (filterSort === 'price-desc') return b.currentPrice - a.currentPrice;
                if (filterSort === 'name') return a.name.localeCompare(b.name);
                return 0;
            });

            grid.innerHTML = filteredCities.map(city => `
                <div class="city-card" onclick="showCityInfo('${city.name}')">
                    <div class="city-flag" style="background: ${city.flag || 'linear-gradient(135deg, #667eea, #764ba2)'};"></div>
                    <div class="city-name">${city.name}</div>
                    <div class="city-price">${city.currentPrice.toFixed(2)} USDT</div>
                    <div class="city-owner">${city.owner ? 'üë§ Sahipli' : 'üè∑Ô∏è Satƒ±lƒ±k'}</div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="event.stopPropagation(); showCityInfo('${city.name}')">
                        Detaylar
                    </button>
                </div>
            `).join('');

            // Populate country filter
            const countries = [...new Set(cities.map(c => c.country))];
            document.getElementById('filterCountry').innerHTML = 
                '<option value="">T√ºm √úlkeler</option>' +
                countries.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // Profile Functions
        function renderProfile() {
            if (!currentUser) {
                switchSection('map');
                showModal('loginModal');
                return;
            }

            document.getElementById('profileAvatar').textContent = currentUser.displayName.charAt(0).toUpperCase();
            document.getElementById('profileName').textContent = currentUser.displayName;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('statBalance').textContent = currentUser.balance.toFixed(2);
            document.getElementById('statCities').textContent = currentUser.ownedCities.length;
            document.getElementById('statTransactions').textContent = 
                transactions.filter(t => t.userId === currentUser.uid).length;

            // Render owned cities
            const ownedCities = cities.filter(c => currentUser.ownedCities.includes(c.id));
            const ownedGrid = document.getElementById('ownedCitiesGrid');
            
            if (ownedCities.length === 0) {
                ownedGrid.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">Hen√ºz ≈üehriniz yok</p>';
            } else {
                ownedGrid.innerHTML = ownedCities.map(city => `
                    <div class="city-card" onclick="showCityInfo('${city.name}')">
                        <div class="city-flag" style="background: ${city.flag || 'linear-gradient(135deg, #667eea, #764ba2)'};"></div>
                        <div class="city-name">${city.name}</div>
                        <div class="city-price">${city.currentPrice.toFixed(2)} USDT</div>
                        <button class="btn btn-secondary" style="width: 100%;" onclick="event.stopPropagation(); showCityInfo('${city.name}')">
                            Y√∂net
                        </button>
                    </div>
                `).join('');
            }

            // Render transactions
            const userTransactions = transactions.filter(t => t.userId === currentUser.uid);
            const transactionHistory = document.getElementById('transactionHistory');
            
            if (userTransactions.length === 0) {
                transactionHistory.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">Hen√ºz i≈ülem yok</p>';
            } else {
                transactionHistory.innerHTML = userTransactions.map(tx => {
                    const city = cities.find(c => c.id === tx.cityId);
                    return `
                        <div class="transaction-item">
                            <div>
                                <div class="transaction-type ${tx.type}">${tx.type}</div>
                                <div style="font-weight: 600;">${city ? city.name : 'Bilinmiyor'}</div>
                                <div style="font-size: 12px; color: var(--text-light);">${new Date(tx.timestamp).toLocaleString('tr-TR')}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--secondary);">${tx.amount.toFixed(2)} USDT</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Flag Designer
        let canvas, ctx, isDrawing = false, currentColor = '#FF0000', brushSize = 5;

        function showFlagDesigner() {
            showModal('flagDesignerModal');
            setTimeout(initFlagDesigner, 100);
        }

        function initFlagDesigner() {
            canvas = document.getElementById('flagCanvas');
            ctx = canvas.getContext('2d');

            // Load existing design
            if (currentUser.flagDesign) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0);
                img.src = currentUser.flagDesign;
            } else {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Color palette
            const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF', '#000000',
                           '#FFA500', '#800080', '#008000', '#FFC0CB', '#A52A2A', '#808080', '#FFD700', '#4B0082'];
            
            document.getElementById('colorPalette').innerHTML = colors.map(color => 
                `<div class="color-box ${color === currentColor ? 'active' : ''}" 
                      style="background: ${color};" 
                      onclick="selectColor('${color}')"></div>`
            ).join('');

            // Brush size
            document.getElementById('brushSize').addEventListener('input', (e) => {
                brushSize = e.target.value;
                document.getElementById('brushSizeLabel').textContent = brushSize;
            });

            // Drawing events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-box').forEach(box => {
                box.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function draw(e) {
            if (!isDrawing) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.beginPath();
            ctx.arc(x, y, brushSize, 0, Math.PI * 2);
            ctx.fillStyle = currentColor;
            ctx.fill();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearCanvas() {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function fillCanvas() {
            ctx.fillStyle = currentColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function saveFlagDesign() {
            const dataURL = canvas.toDataURL();
            currentUser.flagDesign = dataURL;

            // Apply to all owned cities
            currentUser.ownedCities.forEach(cityId => {
                const city = cities.find(c => c.id === cityId);
                if (city) city.flag = dataURL;
            });

            closeModal('flagDesignerModal');
            showToast('Bayrak tasarƒ±mƒ± kaydedildi ve t√ºm ≈üehirlerinize uygulandƒ±!');
        }

        // Wallet Functions
        function showWalletModal() {
            document.getElementById('walletBalance').textContent = currentUser.balance.toFixed(2);
            showModal('walletModal');
        }

        function showDepositSection() {
            document.getElementById('depositSection').classList.remove('hidden');
            document.getElementById('withdrawSection').classList.add('hidden');
        }

        function showWithdrawSection() {
            document.getElementById('depositSection').classList.add('hidden');
            document.getElementById('withdrawSection').classList.remove('hidden');
        }

        function copyDepositAddress() {
            const address = document.getElementById('depositAddress').value;
            navigator.clipboard.writeText(address);
            showToast('Adres kopyalandƒ±!');
        }

        async function requestWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const address = document.getElementById('withdrawAddress').value;

            if (!amount || amount <= 0) {
                showToast('Ge√ßerli bir miktar girin', 'error');
                return;
            }

            if (!address || address.length < 10) {
                showToast('Ge√ßerli bir c√ºzdan adresi girin', 'error');
                return;
            }

            if (amount > currentUser.balance) {
                showToast('Yetersiz bakiye!', 'error');
                return;
            }

            showLoading();
            await new Promise(resolve => setTimeout(resolve, 1000));

            withdrawRequests.push({
                id: 'wd_' + Date.now(),
                userId: currentUser.uid,
                amount: amount,
                address: address,
                status: 'pending',
                timestamp: new Date()
            });

            hideLoading();
            closeModal('walletModal');
            showToast('√áekim talebiniz olu≈üturuldu. Admin onayƒ± bekleniyor.');
        }

        // Admin Functions
        function renderAdmin() {
            if (!currentUser || !currentUser.isAdmin) {
                switchSection('map');
                showToast('Bu sayfaya eri≈üim yetkiniz yok', 'error');
                return;
            }

            // Stats
            document.getElementById('statTotalUsers').textContent = users.length + 1;
            document.getElementById('statTotalVolume').textContent = 
                transactions.reduce((sum, tx) => sum + tx.amount, 0).toFixed(2);
            document.getElementById('statActiveCities').textContent = 
                cities.filter(c => c.owner).length;

            // Users table
            document.getElementById('adminUsersTable').innerHTML = 
                `<tr>
                    <td>${currentUser.displayName}</td>
                    <td>${currentUser.email}</td>
                    <td>${currentUser.balance.toFixed(2)} USDT</td>
                    <td>${currentUser.ownedCities.length}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">D√ºzenle</button>
                    </td>
                </tr>`;

            // Withdrawal requests
            document.getElementById('adminWithdrawalsTable').innerHTML = 
                withdrawRequests.map(wd => `
                    <tr>
                        <td>${currentUser.displayName}</td>
                        <td>${wd.amount.toFixed(2)} USDT</td>
                        <td>${wd.address.substring(0, 10)}...</td>
                        <td><span style="color: ${wd.status === 'pending' ? 'orange' : 'green'};">${wd.status}</span></td>
                        <td>
                            ${wd.status === 'pending' ? `
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="approveWithdrawal('${wd.id}')">Onayla</button>
                                <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="rejectWithdrawal('${wd.id}')">Reddet</button>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="text-align: center;">Talep yok</td></tr>';

            // Transactions
            document.getElementById('adminTransactionsTable').innerHTML = 
                transactions.slice(-10).reverse().map(tx => {
                    const city = cities.find(c => c.id === tx.cityId);
                    return `
                        <tr>
                            <td>${new Date(tx.timestamp).toLocaleString('tr-TR')}</td>
                            <td><span class="transaction-type ${tx.type}">${tx.type}</span></td>
                            <td>${currentUser.displayName}</td>
                            <td>${tx.amount.toFixed(2)} USDT</td>
                            <td>${city ? city.name : '-'}</td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="5" style="text-align: center;">ƒ∞≈ülem yok</td></tr>';
        }

        function approveWithdrawal(id) {
            const wd = withdrawRequests.find(w => w.id === id);
            if (wd) {
                wd.status = 'approved';
                showToast('√áekim talebi onaylandƒ±');
                renderAdmin();
            }
        }

        function rejectWithdrawal(id) {
            const wd = withdrawRequests.find(w => w.id === id);
            if (wd) {
                wd.status = 'rejected';
                showToast('√áekim talebi reddedildi');
                renderAdmin();
            }
        }

        // Event Listeners
        document.getElementById('marketplaceSearch').addEventListener('input', renderMarketplace);
        document.getElementById('filterCountry').addEventListener('change', renderMarketplace);
        document.getElementById('filterStatus').addEventListener('change', renderMarketplace);
        document.getElementById('filterSort').addEventListener('change', renderMarketplace);

        // Initialize App
        window.addEventListener('load', () => {
            initDemoData();
            initMap();
            renderNavMenu();
            hideLoading();

            // Check auth state
            if (auth) {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        handleAuthSuccess(user);
                    }
                });
            }
        });
    </script>
</body>
</html>
