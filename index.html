<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityMarket - Dünya Şehir Platformu</title>
    
    <!-- AmCharts -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/data/countries2.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #fff;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: drift 20s linear infinite;
        }

        @keyframes drift {
            from { transform: translate(0, 0); }
            to { transform: translate(50px, 50px); }
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 30px;
            padding: 50px 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .logo h1 {
            font-size: 36px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .logo p {
            color: #666;
            font-size: 15px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 15px;
            color: #333;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input::placeholder {
            color: #999;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-google {
            background: white;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 2px solid #f0f0f0;
        }

        .btn-google:hover {
            border-color: #667eea;
        }

        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .divider span {
            color: #999;
            font-size: 14px;
            background: rgba(255,255,255,0.95);
            padding: 0 10px;
        }

        /* Main App */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 12px;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 15px;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.2);
            color: #fff;
        }

        .balance-badge {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.3);
        }

        /* Map Container */
        #mapContainer {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0e27;
        }

        /* Search Bar */
        .search-overlay {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            width: 90%;
            max-width: 600px;
        }

        .search-bar {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
        }

        .search-bar input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-bar input:focus {
            outline: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e2a5e, #2d1b4e);
            border-radius: 30px;
            padding: 40px;
            max-width: 550px;
            width: 100%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-detail {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-detail:last-child {
            border-bottom: none;
        }

        .modal-detail label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .modal-detail span {
            font-weight: 700;
            font-size: 16px;
        }

        /* Canvas */
        #flagCanvas {
            width: 100%;
            background: white;
            border-radius: 15px;
            cursor: crosshair;
            touch-action: none;
            margin-bottom: 20px;
        }

        .color-palette {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .color-btn {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-btn.active {
            border-color: white;
            transform: scale(1.15);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Other Pages Container */
        .page-container {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 30px;
            background: #0a0e27;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .city-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .city-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 15px;
            transition: all 0.3s;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .back-btn:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        .page-title {
            font-size: 42px;
            margin-bottom: 30px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #ffc107;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .navbar {
                padding: 15px 20px;
            }

            #mapContainer {
                top: 70px;
            }

            .page-container {
                top: 70px;
                padding: 20px;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="logo">
                <div class="logo-icon">🌍</div>
                <h1>CityMarket</h1>
                <p>Dünya Şehirlerini Keşfet ve Sahip Ol</p>
            </div>

            <div id="loginForm">
                <div class="input-group">
                    <input type="email" id="loginEmail" placeholder="E-posta adresiniz">
                </div>
                <div class="input-group">
                    <input type="password" id="loginPassword" placeholder="Şifreniz">
                </div>
                <button class="btn btn-primary" onclick="handleLogin('email')">Giriş Yap</button>
                <button class="btn btn-secondary" onclick="toggleRegister()">Hesap Oluştur</button>
            </div>

            <div id="registerForm" class="hidden">
                <div class="input-group">
                    <input type="text" id="registerName" placeholder="Adınız Soyadınız">
                </div>
                <div class="input-group">
                    <input type="email" id="registerEmail" placeholder="E-posta adresiniz">
                </div>
                <div class="input-group">
                    <input type="password" id="registerPassword" placeholder="Şifreniz">
                </div>
                <button class="btn btn-primary" onclick="handleRegister()">Kayıt Ol</button>
                <button class="btn btn-secondary" onclick="toggleRegister()">Giriş Sayfasına Dön</button>
            </div>

            <div class="divider">
                <span>veya</span>
            </div>

            <button class="btn btn-google" onclick="handleLogin('google')">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google ile Giriş
            </button>
            <button class="btn btn-secondary" onclick="handleLogin('guest')">Misafir Olarak Devam Et</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="nav-brand">
                🌍 CityMarket
            </div>
            <div class="nav-menu">
                <a href="#" class="nav-link" onclick="showPage('home')">Harita</a>
                <a href="#" class="nav-link" onclick="showPage('market')">Borsa</a>
                <a href="#" class="nav-link" onclick="showPage('wallet')">Cüzdan</a>
                <a href="#" class="nav-link" onclick="showPage('profile')">Profil</a>
                <a href="#" class="nav-link" id="adminLink" onclick="showPage('admin')" style="display: none;">Admin</a>
                <span class="balance-badge" id="navBalance">0 USDT</span>
                <a href="#" class="nav-link" onclick="handleLogout()" style="opacity: 0.7;">Çıkış</a>
            </div>
        </nav>

        <!-- Home Page - Map -->
        <div id="homePage">
            <div class="search-overlay">
                <div class="search-bar">
                    <span style="font-size: 20px;">🔍</span>
                    <input type="text" id="searchInput" placeholder="Ülke veya şehir ara...">
                </div>
            </div>
            <div id="mapContainer"></div>
        </div>

        <!-- Other Pages -->
        <div id="marketPage" class="page-container hidden">
            <div class="container">
                <button class="back-btn" onclick="showPage('home')">← Haritaya Dön</button>
                <h2 class="page-title">Borsa - Şehir Alım Satım</h2>
                <div class="card">
                    <div id="marketOrders"></div>
                </div>
            </div>
        </div>

        <div id="walletPage" class="page-container hidden">
            <div class="container">
                <button class="back-btn" onclick="showPage('home')">← Haritaya Dön</button>
                <h2 class="page-title">Cüzdan</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px;">
                    <div class="card">
                        <h3 style="margin-bottom: 25px; font-size: 24px;">💰 Para Yatır</h3>
                        <div class="input-group">
                            <input type="number" id="depositAmount" placeholder="Miktar (USDT)">
                        </div>
                        <div class="alert alert-warning">
                            Demo moddasınız. İstediğiniz miktarı yatırabilirsiniz!
                        </div>
                        <button class="btn btn-primary" onclick="handleDeposit()">Yatır</button>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 25px; font-size: 24px;">💸 Para Çek</h3>
                        <div class="input-group">
                            <input type="number" id="withdrawAmount" placeholder="Miktar (USDT)">
                        </div>
                        <div class="input-group">
                            <input type="text" id="withdrawWallet" placeholder="Cüzdan Adresi">
                        </div>
                        <button class="btn btn-primary" onclick="handleWithdraw()">Çekim Talebi Oluştur</button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 25px; font-size: 24px;">İşlem Geçmişi</h3>
                    <div id="transactionList"></div>
                </div>
            </div>
        </div>

        <div id="profilePage" class="page-container hidden">
            <div class="container">
                <button class="back-btn" onclick="showPage('home')">← Haritaya Dön</button>
                <h2 class="page-title">Profil</h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 30px;">
                        <div>
                            <h3 style="font-size: 32px; margin-bottom: 10px;" id="profileName"></h3>
                            <p style="color: rgba(255,255,255,0.6); font-size: 16px;" id="profileEmail"></p>
                        </div>
                        <img id="profileFlag" src="" alt="flag" style="width: 120px; height: 80px; object-fit: cover; border-radius: 15px; border: 3px solid #667eea; display: none;">
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card green">
                            <div class="stat-label">Toplam Bakiye</div>
                            <div class="stat-value" id="profileBalance">0 USDT</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Sahip Olunan Şehir</div>
                            <div class="stat-value" id="profileCityCount">0</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-label">Portföy Değeri</div>
                            <div class="stat-value" id="profileTotalValue">0 USDT</div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="openFlagEditor()">🎨 Bayrak Tasarla</button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 25px; font-size: 24px;">Şehirlerim</h3>
                    <div class="city-grid" id="myCitiesGrid"></div>
                </div>
            </div>
        </div>

        <div id="adminPage" class="page-container hidden">
            <div class="container">
                <button class="back-btn" onclick="showPage('home')">← Haritaya Dön</button>
                <h2 class="page-title">Admin Paneli</h2>
                
                <div class="card">
                    <h3 style="margin-bottom: 25px; font-size: 24px;">Kullanıcılar</h3>
                    <div id="adminUsers"></div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 25px; font-size: 24px;">Tüm İşlemler</h3>
                    <div id="adminTransactions"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- City Modal -->
    <div id="cityModal" class="modal hidden" onclick="closeCityModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closeCityModal()">×</button>
            <div class="modal-header">
                <h2 id="modalCityName"></h2>
                <p style="color: rgba(255,255,255,0.7);" id="modalCityCountry"></p>
            </div>
            <img id="modalCityFlag" src="" alt="flag" style="width: 100%; height: 220px; object-fit: cover; border-radius: 20px; margin-bottom: 25px; display: none;">
            <div id="modalCityDetails"></div>
            <div id="modalCityActions"></div>
        </div>
    </div>

    <!-- Flag Editor Modal -->
    <div id="flagModal" class="modal hidden" onclick="closeFlagEditor()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closeFlagEditor()">×</button>
            <div class="modal-header">
                <h2>Bayrak Tasarla</h2>
            </div>
            <canvas id="flagCanvas" width="600" height="400"></canvas>
            <div class="color-palette" id="colorPalette"></div>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-secondary" onclick="clearCanvas()" style="flex: 1;">Temizle</button>
                <button class="btn btn-primary" onclick="saveFlag()" style="flex: 1;">Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        var currentUser = null;
        var cities = {};
        var users = {};
        var transactions = [];
        var marketOrders = [];
        var selectedCity = null;
        var isDrawing = false;
        var currentColor = '#FF0000';
        var mapRoot = null;
        var mapChart = null;
        var worldSeries = null;
        var citySeries = null;
        var backContainer = null;
        var canvas = document.getElementById('flagCanvas');
        var ctx = canvas ? canvas.getContext('2d') : null;

        // ŞEHİR VERİLERİ - ÜLKEYE GÖRE KOORDİNATLAR
        var cityDataByCountry = {
            'TR': [
                { name: 'İstanbul', lat: 41.0082, lon: 28.9784, price: 5000 },
                { name: 'Ankara', lat: 39.9334, lon: 32.8597, price: 3000 },
                { name: 'İzmir', lat: 38.4237, lon: 27.1428, price: 2500 },
                { name: 'Antalya', lat: 36.8969, lon: 30.7133, price: 2200 },
                { name: 'Bursa', lat: 40.1826, lon: 29.0665, price: 1800 }
            ],
            'US': [
                { name: 'New York', lat: 40.7128, lon: -74.0060, price: 10000 },
                { name: 'Los Angeles', lat: 34.0522, lon: -118.2437, price: 9000 },
                { name: 'Chicago', lat: 41.8781, lon: -87.6298, price: 7000 },
                { name: 'Houston', lat: 29.7604, lon: -95.3698, price: 6000 },
                { name: 'Miami', lat: 25.7617, lon: -80.1918, price: 5500 },
                { name: 'San Francisco', lat: 37.7749, lon: -122.4194, price: 8500 },
                { name: 'Las Vegas', lat: 36.1699, lon: -115.1398, price: 4500 }
            ],
            'GB': [
                { name: 'London', lat: 51.5074, lon: -0.1278, price: 8000 },
                { name: 'Manchester', lat: 53.4808, lon: -2.2426, price: 5000 },
                { name: 'Birmingham', lat: 52.4862, lon: -1.8904, price: 4000 },
                { name: 'Liverpool', lat: 53.4084, lon: -2.9916, price: 3500 }
            ],
            'FR': [
                { name: 'Paris', lat: 48.8566, lon: 2.3522, price: 7500 },
                { name: 'Marseille', lat: 43.2965, lon: 5.3698, price: 4500 },
                { name: 'Lyon', lat: 45.7640, lon: 4.8357, price: 4200 },
                { name: 'Nice', lat: 43.7102, lon: 7.2620, price: 4000 }
            ],
            'DE': [
                { name: 'Berlin', lat: 52.5200, lon: 13.4050, price: 6500 },
                { name: 'Munich', lat: 48.1351, lon: 11.5820, price: 6000 },
                { name: 'Frankfurt', lat: 50.1109, lon: 8.6821, price: 5500 },
                { name: 'Hamburg', lat: 53.5511, lon: 9.9937, price: 5200 }
            ],
            'IT': [
                { name: 'Roma', lat: 41.9028, lon: 12.4964, price: 7000 },
                { name: 'Milano', lat: 45.4642, lon: 9.1900, price: 6500 },
                { name: 'Venezia', lat: 45.4408, lon: 12.3155, price: 5000 },
                { name: 'Firenze', lat: 43.7696, lon: 11.2558, price: 4500 }
            ],
            'ES': [
                { name: 'Madrid', lat: 40.4168, lon: -3.7038, price: 6000 },
                { name: 'Barcelona', lat: 41.3851, lon: 2.1734, price: 5500 },
                { name: 'Valencia', lat: 39.4699, lon: -0.3763, price: 3500 },
                { name: 'Sevilla', lat: 37.3891, lon: -5.9845, price: 3200 }
            ],
            'JP': [
                { name: 'Tokyo', lat: 35.6762, lon: 139.6503, price: 12000 },
                { name: 'Osaka', lat: 34.6937, lon: 135.5023, price: 9000 },
                { name: 'Kyoto', lat: 35.0116, lon: 135.7681, price: 7000 },
                { name: 'Yokohama', lat: 35.4437, lon: 139.6380, price: 6500 }
            ],
            'CN': [
                { name: 'Beijing', lat: 39.9042, lon: 116.4074, price: 11000 },
                { name: 'Shanghai', lat: 31.2304, lon: 121.4737, price: 10500 },
                { name: 'Hong Kong', lat: 22.3193, lon: 114.1694, price: 9500 },
                { name: 'Guangzhou', lat: 23.1291, lon: 113.2644, price: 7500 }
            ],
            'RU': [
                { name: 'Moscow', lat: 55.7558, lon: 37.6173, price: 8000 },
                { name: 'St Petersburg', lat: 59.9343, lon: 30.3351, price: 6000 },
                { name: 'Sochi', lat: 43.6028, lon: 39.7342, price: 4000 }
            ],
            'BR': [
                { name: 'São Paulo', lat: -23.5505, lon: -46.6333, price: 7000 },
                { name: 'Rio de Janeiro', lat: -22.9068, lon: -43.1729, price: 6500 },
                { name: 'Brasília', lat: -15.7975, lon: -47.8919, price: 5000 }
            ],
            'AU': [
                { name: 'Sydney', lat: -33.8688, lon: 151.2093, price: 8000 },
                { name: 'Melbourne', lat: -37.8136, lon: 144.9631, price: 7000 },
                { name: 'Brisbane', lat: -27.4698, lon: 153.0251, price: 5500 }
            ],
            'CA': [
                { name: 'Toronto', lat: 43.6532, lon: -79.3832, price: 7500 },
                { name: 'Vancouver', lat: 49.2827, lon: -123.1207, price: 7000 },
                { name: 'Montreal', lat: 45.5017, lon: -73.5673, price: 6000 }
            ],
            'AE': [
                { name: 'Dubai', lat: 25.2048, lon: 55.2708, price: 9000 },
                { name: 'Abu Dhabi', lat: 24.4539, lon: 54.3773, price: 7500 }
            ],
            'SA': [
                { name: 'Riyadh', lat: 24.7136, lon: 46.6753, price: 6000 },
                { name: 'Jeddah', lat: 21.5433, lon: 39.1728, price: 5000 }
            ],
            'EG': [
                { name: 'Cairo', lat: 30.0444, lon: 31.2357, price: 5000 },
                { name: 'Alexandria', lat: 31.2001, lon: 29.9187, price: 3500 }
            ],
            'ZA': [
                { name: 'Cape Town', lat: -33.9249, lon: 18.4241, price: 5500 },
                { name: 'Johannesburg', lat: -26.2041, lon: 28.0473, price: 5000 }
            ],
            'MX': [
                { name: 'Mexico City', lat: 19.4326, lon: -99.1332, price: 6500 },
                { name: 'Cancún', lat: 21.1619, lon: -86.8515, price: 4500 }
            ],
            'AR': [
                { name: 'Buenos Aires', lat: -34.6037, lon: -58.3816, price: 6000 },
                { name: 'Córdoba', lat: -31.4201, lon: -64.1888, price: 3500 }
            ],
            'IN': [
                { name: 'Mumbai', lat: 19.0760, lon: 72.8777, price: 7000 },
                { name: 'Delhi', lat: 28.7041, lon: 77.1025, price: 6500 },
                { name: 'Bangalore', lat: 12.9716, lon: 77.5946, price: 5500 }
            ],
            'TH': [
                { name: 'Bangkok', lat: 13.7563, lon: 100.5018, price: 5500 },
                { name: 'Phuket', lat: 7.8804, lon: 98.3923, price: 4000 }
            ],
            'SG': [
                { name: 'Singapore', lat: 1.3521, lon: 103.8198, price: 9000 }
            ],
            'KR': [
                { name: 'Seoul', lat: 37.5665, lon: 126.9780, price: 8000 },
                { name: 'Busan', lat: 35.1796, lon: 129.0756, price: 5500 }
            ],
            'NL': [
                { name: 'Amsterdam', lat: 52.3676, lon: 4.9041, price: 6500 },
                { name: 'Rotterdam', lat: 51.9225, lon: 4.4792, price: 4500 }
            ],
            'BE': [
                { name: 'Brussels', lat: 50.8503, lon: 4.3517, price: 5500 }
            ],
            'CH': [
                { name: 'Zürich', lat: 47.3769, lon: 8.5417, price: 7000 },
                { name: 'Geneva', lat: 46.2044, lon: 6.1432, price: 6500 }
            ],
            'AT': [
                { name: 'Vienna', lat: 48.2082, lon: 16.3738, price: 6000 }
            ],
            'SE': [
                { name: 'Stockholm', lat: 59.3293, lon: 18.0686, price: 6000 }
            ],
            'NO': [
                { name: 'Oslo', lat: 59.9139, lon: 10.7522, price: 6500 }
            ],
            'DK': [
                { name: 'Copenhagen', lat: 55.6761, lon: 12.5683, price: 6000 }
            ],
            'FI': [
                { name: 'Helsinki', lat: 60.1699, lon: 24.9384, price: 5500 }
            ],
            'PL': [
                { name: 'Warsaw', lat: 52.2297, lon: 21.0122, price: 4500 },
                { name: 'Kraków', lat: 50.0647, lon: 19.9450, price: 3500 }
            ],
            'CZ': [
                { name: 'Prague', lat: 50.0755, lon: 14.4378, price: 5000 }
            ],
            'GR': [
                { name: 'Athens', lat: 37.9838, lon: 23.7275, price: 4500 }
            ],
            'PT': [
                { name: 'Lisbon', lat: 38.7223, lon: -9.1393, price: 4500 },
                { name: 'Porto', lat: 41.1579, lon: -8.6291, price: 3500 }
            ],
            'IE': [
                { name: 'Dublin', lat: 53.3498, lon: -6.2603, price: 5500 }
            ],
            'NZ': [
                { name: 'Auckland', lat: -36.8485, lon: 174.7633, price: 5500 }
            ]
        };

        // Initialize Cities
        function initDemoData() {
            cities = {};
            var cityId = 0;
            for (var country in cityDataByCountry) {
                cityDataByCountry[country].forEach(function(cityInfo) {
                    var id = 'city_' + cityId++;
                    cities[id] = {
                        id: id,
                        name: cityInfo.name,
                        country: country,
                        lat: cityInfo.lat,
                        lon: cityInfo.lon,
                        price: cityInfo.price,
                        owner: null,
                        flag: null,
                        initialPrice: cityInfo.price,
                        priceHistory: []
                    };
                });
            }

            users = {
                'demo1': { id: 'demo1', name: 'Demo Admin', email: 'admin@citymarket.com', balance: 100000, cities: [], flag: null, isAdmin: true }
            };
        }

        // Initialize Map
        function initMap() {
            if (mapRoot) {
                mapRoot.dispose();
            }

            mapRoot = am5.Root.new("mapContainer");
            mapRoot.setThemes([am5themes_Animated.new(mapRoot)]);

            mapChart = mapRoot.container.children.push(am5map.MapChart.new(mapRoot, {
                panX: "rotateX",
                projection: am5map.geoMercator(),
                maxZoomLevel: 32,
                homeZoomLevel: 1
            }));

            // World Series
            worldSeries = mapChart.series.push(am5map.MapPolygonSeries.new(mapRoot, {
                geoJSON: am5geodata_worldLow,
                exclude: ["AQ"]
            }));

            worldSeries.mapPolygons.template.setAll({
                tooltipText: "{name}",
                interactive: true,
                fill: am5.color(0x555555),
                strokeWidth: 0.5,
                stroke: am5.color(0x000000)
            });

            worldSeries.mapPolygons.template.states.create("hover", {
                fill: am5.color(0x667eea)
            });

            // Country Click Event
            worldSeries.mapPolygons.template.events.on("click", function(ev) {
                var dataItem = ev.target.dataItem;
                var data = dataItem.dataContext;
                var countryId = data.id;
                
                if (cityDataByCountry[countryId]) {
                    var zoomAnimation = worldSeries.zoomToDataItem(dataItem);

                    Promise.all([
                        zoomAnimation.waitForStop(),
                        am5.net.load("https://cdn.amcharts.com/lib/5/geodata/json/" + data.map + ".json", mapChart)
                    ]).then(function(results) {
                        var geodata = am5.JSONParser.parse(results[1].response);
                        citySeries.setAll({
                            geoJSON: geodata,
                            fill: am5.color(0x666666)
                        });

                        addCityPoints(countryId);

                        citySeries.show();
                        worldSeries.hide(100);
                        backContainer.show();
                    });
                }
            });

            // City Series
            citySeries = mapChart.series.push(am5map.MapPolygonSeries.new(mapRoot, {
                visible: false
            }));

            citySeries.mapPolygons.template.setAll({
                tooltipText: "{name}",
                interactive: true,
                fill: am5.color(0x666666)
            });

            citySeries.mapPolygons.template.states.create("hover", {
                fill: am5.color(0x764ba2)
            });

            // City Point Series
            window.cityPointSeries = mapChart.series.push(am5map.MapPointSeries.new(mapRoot, {
                visible: false
            }));

            // Back Button
            backContainer = mapChart.children.push(am5.Container.new(mapRoot, {
                x: am5.p100,
                centerX: am5.p100,
                dx: -10,
                paddingTop: 10,
                paddingRight: 15,
                paddingBottom: 10,
                paddingLeft: 15,
                y: 30,
                interactiveChildren: false,
                layout: mapRoot.horizontalLayout,
                cursorOverStyle: "pointer",
                background: am5.RoundedRectangle.new(mapRoot, {
                    fill: am5.color(0x667eea),
                    fillOpacity: 0.9
                }),
                visible: false
            }));

            backContainer.children.push(am5.Label.new(mapRoot, {
                text: "← Dünya Haritası",
                centerY: am5.p50,
                fill: am5.color(0xffffff),
                fontSize: 14
            }));

            backContainer.events.on("click", function() {
                mapChart.goHome();
                worldSeries.show();
                citySeries.hide();
                window.cityPointSeries.hide();
                backContainer.hide();
            });
        }

        function addCityPoints(countryId) {
            if (!cityDataByCountry[countryId]) return;

            window.cityPointSeries.bullets.clear();
            
            window.cityPointSeries.bullets.push(function() {
                var container = am5.Container.new(mapRoot, {});
                
                var circle = container.children.push(am5.Circle.new(mapRoot, {
                    radius: 6,
                    fill: am5.color(0x667eea),
                    stroke: am5.color(0xffffff),
                    strokeWidth: 2,
                    tooltipText: "{name}\n{price} USDT",
                    cursorOverStyle: "pointer"
                }));

                circle.events.on("click", function(ev) {
                    var cityId = ev.target.dataItem.dataContext.cityId;
                    openCityModal(cities[cityId]);
                });

                circle.states.create("hover", {
                    fill: am5.color(0x764ba2),
                    scale: 1.5
                });

                return am5.Bullet.new(mapRoot, {
                    sprite: container
                });
            });

            var points = [];
            for (var cityId in cities) {
                var city = cities[cityId];
                if (city.country === countryId) {
                    points.push({
                        cityId: city.id,
                        name: city.name,
                        price: city.price.toFixed(0),
                        geometry: {
                            type: "Point",
                            coordinates: [city.lon, city.lat]
                        }
                    });
                }
            }

            window.cityPointSeries.data.setAll(points);
            window.cityPointSeries.show();
        }

        // Login Functions
        function toggleRegister() {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
        }

        function handleLogin(type) {
            if (type === 'google') {
                createUser('Google User', 'google@user.com', 10000, false);
            } else if (type === 'guest') {
                createUser('Misafir Kullanıcı', 'guest@user.com', 5000, false);
            } else if (type === 'email') {
                var email = document.getElementById('loginEmail').value;
                var password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    alert('Lütfen tüm alanları doldurun');
                    return;
                }
                
                var user = Object.values(users).find(function(u) { return u.email === email; });
                if (user) {
                    currentUser = user;
                    showMainApp();
                } else {
                    alert('Kullanıcı bulunamadı');
                }
            }
        }

        function handleRegister() {
            var name = document.getElementById('registerName').value;
            var email = document.getElementById('registerEmail').value;
            var password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                alert('Lütfen tüm alanları doldurun');
                return;
            }
            
            createUser(name, email, 10000, false);
        }

        function createUser(name, email, balance, isAdmin) {
            var userId = 'user_' + Date.now();
            var newUser = {
                id: userId,
                name: name,
                email: email,
                balance: balance,
                cities: [],
                flag: null,
                isAdmin: isAdmin
            };
            users[userId] = newUser;
            currentUser = newUser;
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateNavBalance();
            if (currentUser.isAdmin) {
                document.getElementById('adminLink').style.display = 'block';
            }
            setTimeout(function() { initMap(); }, 100);
        }

        function handleLogout() {
            if (mapRoot) {
                mapRoot.dispose();
                mapRoot = null;
            }
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            showPage('home');
        }

        function showPage(pageName) {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('marketPage').classList.add('hidden');
            document.getElementById('walletPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            if (pageName === 'home') {
                document.getElementById('homePage').classList.remove('hidden');
                if (!mapRoot) setTimeout(function() { initMap(); }, 100);
            } else {
                document.getElementById(pageName + 'Page').classList.remove('hidden');
            }
            
            if (pageName === 'market') renderMarket();
            if (pageName === 'wallet') renderWallet();
            if (pageName === 'profile') renderProfile();
            if (pageName === 'admin') renderAdmin();
        }

        function openCityModal(city) {
            selectedCity = city;
            var modal = document.getElementById('cityModal');
            document.getElementById('modalCityName').textContent = city.name;
            document.getElementById('modalCityCountry').textContent = '📍 ' + city.country;
            
            var flagImg = document.getElementById('modalCityFlag');
            if (city.flag) {
                flagImg.src = city.flag;
                flagImg.style.display = 'block';
            } else {
                flagImg.style.display = 'none';
            }
            
            var details = document.getElementById('modalCityDetails');
            var changePercent = ((city.price - city.initialPrice) / city.initialPrice * 100).toFixed(2);
            details.innerHTML = '<div class="modal-detail"><label>Fiyat</label><span style="color: #11998e; font-size: 22px;">' + city.price.toFixed(2) + ' USDT</span></div>' +
                (city.owner ? '<div class="modal-detail"><label>Sahibi</label><span style="color: #667eea;">' + (users[city.owner] ? users[city.owner].name : '') + '</span></div>' : '') +
                '<div class="modal-detail"><label>İlk Fiyat</label><span>' + city.initialPrice.toFixed(2) + ' USDT</span></div>' +
                '<div class="modal-detail"><label>Değişim</label><span style="color: ' + (changePercent >= 0 ? '#11998e' : '#e74c3c') + '">' +
                (changePercent >= 0 ? '+' : '') + changePercent + '%</span></div>';
            
            var actions = document.getElementById('modalCityActions');
            if (city.owner === currentUser.id) {
                actions.innerHTML = '<div style="margin-top: 25px;"><input type="number" id="sellPrice" placeholder="Satış Fiyatı (USDT)" style="width: 100%; margin-bottom: 15px;"><button class="btn btn-primary" onclick="listCityForSale()">Borsaya Çıkar</button></div>';
            } else if (city.owner) {
                actions.innerHTML = '<div class="alert alert-warning" style="margin-top: 25px;">Bu şehir ' + (users[city.owner] ? users[city.owner].name : 'başka bir kullanıcıya') + ' ait. Borsadan satın alabilirsiniz.</div>';
            } else {
                var disabled = currentUser.balance >= city.price ? '' : 'disabled';
                var buttonText = currentUser.balance >= city.price ? '💰 Satın Al - ' + city.price + ' USDT' : '❌ Yetersiz Bakiye';
                actions.innerHTML = '<button class="btn btn-primary" onclick="buyCity()" style="margin-top: 25px; font-size: 18px; padding: 18px;" ' + disabled + '>' + buttonText + '</button>';
            }
            
            modal.classList.remove('hidden');
        }

        function closeCityModal() {
            document.getElementById('cityModal').classList.add('hidden');
            selectedCity = null;
        }

        function buyCity() {
            if (!selectedCity || currentUser.balance < selectedCity.price) return;
            
            currentUser.balance -= selectedCity.price;
            users[currentUser.id].balance = currentUser.balance;
            
            cities[selectedCity.id].owner = currentUser.id;
            cities[selectedCity.id].flag = currentUser.flag;
            
            users[currentUser.id].cities.push(selectedCity.id);
            
            transactions.push({
                id: Date.now(),
                type: 'buy',
                city: selectedCity.name,
                amount: selectedCity.price,
                date: new Date().toISOString(),
                userId: currentUser.id
            });
            
            updateNavBalance();
            closeCityModal();
            alert('🎉 ' + selectedCity.name + ' şehrini başarıyla satın aldınız!');
        }

        function listCityForSale() {
            var price = parseFloat(document.getElementById('sellPrice').value);
            if (!price || price <= 0) {
                alert('Lütfen geçerli bir fiyat girin');
                return;
            }
            
            marketOrders.push({
                id: Date.now(),
                cityId: selectedCity.id,
                sellerId: currentUser.id,
                price: price,
                date: new Date().toISOString()
            });
            
            closeCityModal();
            alert('Şehir borsaya çıkarıldı!');
        }

        function renderMarket() {
            var container = document.getElementById('marketOrders');
            
            if (marketOrders.length === 0) {
                container.innerHTML = '<div class="empty-state"><div style="font-size: 60px; margin-bottom: 20px;">📈</div><p>Henüz satışta şehir bulunmuyor</p></div>';
                return;
            }
            
            container.innerHTML = '';
            marketOrders.forEach(function(order) {
                var city = cities[order.cityId];
                var seller = users[order.sellerId];
                
                var item = document.createElement('div');
                item.className = 'transaction-item';
                var disabled = order.sellerId !== currentUser.id && currentUser.balance < order.price ? 'disabled' : '';
                var button = order.sellerId !== currentUser.id ? '<button class="btn btn-primary" onclick="buyFromMarket(' + order.id + ')" ' + disabled + '>Satın Al</button>' : '<span style="color: rgba(255,255,255,0.5);">Sizin ilanınız</span>';
                
                item.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center;"><div><h3 style="font-size: 22px; margin-bottom: 8px;">' + city.name + '</h3><p style="color: rgba(255,255,255,0.6);">Satıcı: ' + (seller ? seller.name : '') + '</p></div><div style="text-align: right;"><div style="font-size: 28px; font-weight: 800; color: #11998e; margin-bottom: 15px;">' + order.price.toFixed(2) + ' USDT</div>' + button + '</div></div>';
                container.appendChild(item);
            });
        }

        function buyFromMarket(orderId) {
            var order = marketOrders.find(function(o) { return o.id === orderId; });
            if (!order || currentUser.balance < order.price) return;
            
            var city = cities[order.cityId];
            
            currentUser.balance -= order.price;
            users[currentUser.id].balance = currentUser.balance;
            users[order.sellerId].balance += order.price;
            
            users[order.sellerId].cities = users[order.sellerId].cities.filter(function(c) { return c !== order.cityId; });
            users[currentUser.id].cities.push(order.cityId);
            
            cities[order.cityId].owner = currentUser.id;
            cities[order.cityId].flag = currentUser.flag;
            cities[order.cityId].price = order.price * 1.1;
            
            transactions.push({
                id: Date.now(),
                type: 'buy',
                city: city.name,
                amount: order.price,
                date: new Date().toISOString(),
                userId: currentUser.id
            });
            
            marketOrders = marketOrders.filter(function(o) { return o.id !== orderId; });
            
            updateNavBalance();
            renderMarket();
            alert('🎉 ' + city.name + ' şehrini başarıyla satın aldınız!');
        }

        function handleDeposit() {
            var amount = parseFloat(document.getElementById('depositAmount').value);
            if (!amount || amount <= 0) {
                alert('Lütfen geçerli bir miktar girin');
                return;
            }
            
            currentUser.balance += amount;
            users[currentUser.id].balance = currentUser.balance;
            
            transactions.push({
                id: Date.now(),
                type: 'deposit',
                amount: amount,
                date: new Date().toISOString(),
                userId: currentUser.id
            });
            
            document.getElementById('depositAmount').value = '';
            updateNavBalance();
            renderWallet();
            alert('✅ ' + amount + ' USDT başarıyla yatırıldı!');
        }

        function handleWithdraw() {
            var amount = parseFloat(document.getElementById('withdrawAmount').value);
            var wallet = document.getElementById('withdrawWallet').value;
            
            if (!amount || amount <= 0 || !wallet) {
                alert('Lütfen tüm alanları doldurun');
                return;
            }
            
            if (amount > currentUser.balance) {
                alert('Yetersiz bakiye');
                return;
            }
            
            transactions.push({
                id: Date.now(),
                type: 'withdrawal',
                amount: amount,
                wallet: wallet,
                date: new Date().toISOString(),
                userId: currentUser.id,
                status: 'pending'
            });
            
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawWallet').value = '';
            renderWallet();
            alert('Çekim talebiniz oluşturuldu!');
        }

        function renderWallet() {
            var container = document.getElementById('transactionList');
            var userTransactions = transactions.filter(function(t) { return t.userId === currentUser.id; });
            
            if (userTransactions.length === 0) {
                container.innerHTML = '<div class="empty-state"><div style="font-size: 60px; margin-bottom: 20px;">💳</div><p>Henüz işlem geçmişiniz yok</p></div>';
                return;
            }
            
            container.innerHTML = '';
            userTransactions.reverse().forEach(function(tx) {
                var item = document.createElement('div');
                item.className = 'transaction-item';
                
                var typeText = tx.type === 'buy' ? '🛒 Satın Alma' : tx.type === 'deposit' ? '💰 Yatırma' : '💸 Çekim Talebi';
                var amountColor = tx.type === 'deposit' ? '#11998e' : '#e74c3c';
                
                item.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center;"><div><div style="font-weight: 700; margin-bottom: 5px;">' + typeText + '</div>' +
                    (tx.city ? '<div style="color: rgba(255,255,255,0.6); font-size: 14px;">' + tx.city + '</div>' : '') +
                    (tx.wallet ? '<div style="color: rgba(255,255,255,0.6); font-size: 14px;">Cüzdan: ' + tx.wallet + '</div>' : '') +
                    '<div style="color: rgba(255,255,255,0.5); font-size: 13px; margin-top: 5px;">' + new Date(tx.date).toLocaleString('tr-TR') + '</div></div>' +
                    '<div style="text-align: right;"><div style="font-size: 22px; font-weight: 800; color: ' + amountColor + ';">' +
                    (tx.type === 'deposit' ? '+' : '-') + tx.amount.toFixed(2) + ' USDT</div>' +
                    (tx.status ? '<div style="color: #ffc107; font-size: 12px; margin-top: 5px;">' + tx.status + '</div>' : '') +
                    '</div></div>';
                container.appendChild(item);
            });
        }

        function renderProfile() {
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileBalance').textContent = currentUser.balance.toFixed(2) + ' USDT';
            
            var myCities = Object.values(cities).filter(function(c) { return c.owner === currentUser.id; });
            document.getElementById('profileCityCount').textContent = myCities.length;
            
            var totalValue = myCities.reduce(function(sum, city) { return sum + city.price; }, 0);
            document.getElementById('profileTotalValue').textContent = totalValue.toFixed(2) + ' USDT';
            
            var flagImg = document.getElementById('profileFlag');
            if (currentUser.flag) {
                flagImg.src = currentUser.flag;
                flagImg.style.display = 'block';
            } else {
                flagImg.style.display = 'none';
            }
            
            var grid = document.getElementById('myCitiesGrid');
            if (myCities.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div style="font-size: 60px; margin-bottom: 20px;">🏙️</div><p>Henüz şehriniz yok</p></div>';
                return;
            }
            
            grid.innerHTML = '';
            myCities.forEach(function(city) {
                var card = document.createElement('div');
                card.className = 'city-card';
                card.onclick = function() { openCityModal(city); };
                
                card.innerHTML = '<div style="display: flex; justify-content: space-between; margin-bottom: 15px;"><div><h3 style="font-size: 20px; margin-bottom: 5px;">' + city.name + '</h3><p style="color: rgba(255,255,255,0.6);">📍 ' + city.country + '</p></div>' +
                    (city.flag ? '<img src="' + city.flag + '" style="width: 60px; height: 40px; object-fit: cover; border-radius: 8px;">' : '') +
                    '</div><div style="color: #11998e; font-size: 24px; font-weight: 800;">' + city.price.toFixed(2) + ' USDT</div>';
                grid.appendChild(card);
            });
        }

        function openFlagEditor() {
            document.getElementById('flagModal').classList.remove('hidden');
            initColorPalette();
            if (currentUser.flag) {
                var img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = currentUser.flag;
            }
        }

        function closeFlagEditor() {
            document.getElementById('flagModal').classList.add('hidden');
        }

        function initColorPalette() {
            var colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF', '#000000', '#FFA500', '#800080', '#FFC0CB', '#A52A2A', '#FFD700', '#00CED1'];
            var palette = document.getElementById('colorPalette');
            palette.innerHTML = '';
            
            colors.forEach(function(color) {
                var btn = document.createElement('button');
                btn.className = 'color-btn';
                btn.style.backgroundColor = color;
                if (color === currentColor) btn.classList.add('active');
                btn.onclick = function() {
                    currentColor = color;
                    var allBtns = document.querySelectorAll('.color-btn');
                    for (var i = 0; i < allBtns.length; i++) {
                        allBtns[i].classList.remove('active');
                    }
                    btn.classList.add('active');
                };
                palette.appendChild(btn);
            });
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveFlag() {
            var flagData = canvas.toDataURL();
            currentUser.flag = flagData;
            users[currentUser.id].flag = flagData;
            
            for (var cityId in cities) {
                if (cities[cityId].owner === currentUser.id) {
                    cities[cityId].flag = flagData;
                }
            }
            
            closeFlagEditor();
            renderProfile();
            alert('🎨 Bayrağınız kaydedildi!');
        }

        // Canvas Drawing
        if (canvas) {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                var touch = e.touches[0];
                var rect = canvas.getBoundingClientRect();
                var mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                var touch = e.touches[0];
                var mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                stopDrawing();
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!isDrawing) return;
            
            var rect = canvas.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentColor;
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function renderAdmin() {
            if (!currentUser.isAdmin) return;
            
            var usersContainer = document.getElementById('adminUsers');
            usersContainer.innerHTML = '';
            
            for (var userId in users) {
                var user = users[userId];
                var item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center;"><div><div style="font-weight: 700; margin-bottom: 5px;">' + user.name + '</div><div style="color: rgba(255,255,255,0.6); font-size: 14px;">' + user.email + '</div><div style="color: #11998e; margin-top: 5px;">Bakiye: ' + user.balance.toFixed(2) + ' USDT</div></div><button class="btn btn-primary" onclick="adminAddBalance(\'' + user.id + '\', 1000)" style="width: auto; padding: 10px 20px;">+1000 USDT</button></div>';
                usersContainer.appendChild(item);
            }
            
            var transContainer = document.getElementById('adminTransactions');
            if (transactions.length === 0) {
                transContainer.innerHTML = '<div class="empty-state"><p>Henüz işlem yok</p></div>';
                return;
            }
            
            transContainer.innerHTML = '';
            var reversed = transactions.slice().reverse();
            reversed.forEach(function(tx) {
                var user = users[tx.userId];
                var item = document.createElement('div');
                item.className = 'transaction-item';
                
                var typeText = tx.type === 'buy' ? 'Satın Alma' : tx.type === 'deposit' ? 'Yatırma' : 'Çekim';
                
                item.innerHTML = '<div style="display: flex; justify-content: space-between;"><div><div style="font-weight: 700; margin-bottom: 5px;">' + typeText + '</div><div style="color: rgba(255,255,255,0.6); font-size: 14px;">Kullanıcı: ' + (user ? user.name : '') + '</div>' +
                    (tx.city ? '<div style="color: rgba(255,255,255,0.6); font-size: 14px;">' + tx.city + '</div>' : '') +
                    '<div style="color: rgba(255,255,255,0.5); font-size: 13px; margin-top: 5px;">' + new Date(tx.date).toLocaleString('tr-TR') + '</div></div><div style="font-size: 20px; font-weight: 800; color: ' + (tx.type === 'deposit' ? '#11998e' : '#e74c3c') + ';">' + tx.amount.toFixed(2) + ' USDT</div></div>';
                transContainer.appendChild(item);
            });
        }

        function adminAddBalance(userId, amount) {
            users[userId].balance += amount;
            if (currentUser.id === userId) {
                currentUser.balance = users[userId].balance;
                updateNavBalance();
            }
            renderAdmin();
            alert('✅ ' + users[userId].name + ' kullanıcısına ' + amount + ' USDT eklendi!');
        }

        function updateNavBalance() {
            document.getElementById('navBalance').textContent = currentUser.balance.toFixed(0) + ' USDT';
        }

        // Initialize
        initDemoData();
    </script>
</body>
</html>
